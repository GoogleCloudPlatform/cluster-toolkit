---
- name: Spack config externals
  shell: |
    module load openmpi
    {{ spack_dir }}/bin/spack external find --scope=system --not-buildable
  when: True

- name: Spack mark cmake as buildable
  command: "{{ spack_dir }}/bin/spack config --scope system add packages:cmake:buildable:true"
  when: True

- name: Spack mark python as buildable
  command: "{{ spack_dir }}/bin/spack config --scope system add packages:python:buildable:true"
  when: True

- name: Spack mark OpenMPI as buildable
  command: "{{ spack_dir }}/bin/spack config --scope system add packages:openmpi:buildable:true"
  when: True

- name: Spack mark GCC as buildable
  command: "{{ spack_dir }}/bin/spack config --scope system add packages:gcc:buildable:true"
  when: True

- name: Spack Find DevTool compiler
  command: "{{ spack_dir }}/bin/spack compiler find --scope system /opt/rh/devtoolset-11/root/usr/bin"
  when: True


- name: Add Spack to default shells
  copy:
    dest: /etc/profile.d/zx-spack.sh
    content: |
      . {{ spack_dir }}/share/spack/setup-env.sh
    owner: root
    mode: 0755
    force: False
