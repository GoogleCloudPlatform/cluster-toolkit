# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

blueprint_name: weka-slurm

vars:
  project_id:  ## Set GCP Project ID Here ##
  deployment_name: weka-slurm
  region: us-central1
  zone: us-central1-a

deployment_groups:
- group: primary
  terraform_providers:
    google:
      source: "hashicorp/google"
      version: ">= 6.18.0, < 7.0.0"
    google-beta:
      source: "hashicorp/google-beta"
      version: ">= 6.18.0, < 7.0.0"
  modules:
  # Source is an embedded module, denoted by "modules/*" without ./, ../, /
  # as a prefix. To refer to a local module, prefix with ./, ../ or /
  - id: enable_apis
    source: community/modules/project/service-enablement
    settings:
      gcp_service_list:
      - artifactregistry.googleapis.com
      - cloudbuild.googleapis.com
      - cloudfunctions.googleapis.com
      - cloudresourcemanager.googleapis.com
      - cloudscheduler.googleapis.com
      - compute.googleapis.com
      - dns.googleapis.com
      - eventarc.googleapis.com
      - iam.googleapis.com
      - secretmanager.googleapis.com
      - servicenetworking.googleapis.com
      - serviceusage.googleapis.com
      - vpcaccess.googleapis.com
      - workflows.googleapis.com

  - id: weka_sa
    source: community/modules/project/service-account
    settings:
      name: weka
      project_roles:
      - cloudfunctions.developer
      - cloudbuild.builds.builder
      - compute.serviceAgent
      - compute.loadBalancerServiceUser
      - pubsub.subscriber
      - secretmanager.secretAccessor
      - secretmanager.secretVersionAdder
      - vpcaccess.serviceAgent
      - workflows.invoker

  - id: controller_sa
    source: community/modules/project/service-account
    settings:
      name: controller
      project_roles:
      - compute.instanceAdmin.v1
      - iam.serviceAccountUser
      - logging.logWriter
      - monitoring.metricWriter
      - pubsub.admin
      - storage.objectViewer
      - logging.configWriter

  - id: login_sa
    source: community/modules/project/service-account
    settings:
      name: login
      project_roles:
      - logging.logWriter
      - monitoring.metricWriter
      - storage.objectUser
      - storage.objectViewer

  - id: compute_sa
    source: community/modules/project/service-account
    settings:
      name: compute
      project_roles:
      - logging.logWriter
      - monitoring.metricWriter
      - storage.objectUser
      - storage.objectViewer

  - id: weka_cluster
    source: registry.terraform.io/weka/weka/gcp
    #version: 4.1.1 # TODO: waiting for https://github.com/weka/terraform-gcp-weka/pull/278 to merge & release
    settings:
      cluster_name: weka-cluster
      allow_ssh_cidrs:
      - 0.0.0.0/32 # no access allowed through ssh
      allow_weka_api_cidrs:
      - 10.1.0.0/16
      assign_public_ip: false
      cluster_size: 6
      create_nat_gateway: true
      create_worker_pool: false
      get_weka_io_token: # Obtain token from https://get.weka.io
      nvmes_number: 1
      psc_subnet_cidr: 10.2.1.0/24
      sa_email: $(weka_sa.service_account_email)
      subnet_autocreate_as_private: true
      cloud_functions_ingress: ALLOW_INTERNAL_ONLY
      function_build_service_account:
        create: true
        name: cf-build
      subnets_range:
      - 10.1.0.0/24
      - 10.1.1.0/24
      - 10.1.2.0/24
      - 10.1.3.0/24
      vpc_connector_range: 10.2.0.0/28
      weka_version: 4.4.2.113 # 4.4.1 # 4.4.2.113

  - id: weka_client
    source: community/modules/file-system/weka-client
    settings:
      local_mount: /home
      server_ip: $(weka_cluster.backend_lb_ip)
      remote_mount: default

  - id: weka_wait
    source: community/modules/scripts/wait
    settings:
      create_duration: "10m"
      triggers:
        weka_status: $(weka_cluster.get_cluster_status_uri)
        weka_resize: $(weka_cluster.resize_cluster_uri)

  - id: weka_mount
    source: modules/scripts/startup-script
    settings:
      runners: $(weka_client.runners)

  # compute nodeset mounts WEKA in DPDK mode with 3 network interfaces dedicated for DPDK
  - id: compute_nodeset
    source: community/modules/compute/schedmd-slurm-gcp-v6-nodeset
    settings:
      additional_networks:
      - subnetwork: $(weka_cluster.subnets_self_link[1])
#        subnetwork_project: $(vars.project_id)
        nic_type: VIRTIO_NET
      - subnetwork: $(weka_cluster.subnets_self_link[2])
#        subnetwork_project: $(vars.project_id)
        nic_type: VIRTIO_NET
      - subnetwork: $(weka_cluster.subnets_self_link[3])
#        subnetwork_project: $(vars.project_id)
        nic_type: VIRTIO_NET
      bandwidth_tier: gvnic_enabled
      machine_type: c2-standard-8
      node_count_dynamic_max: 20
      service_account_email: $(compute_sa.service_account_email)
      subnetwork_self_link: $(weka_cluster.subnets_self_link[0])
      startup_script: $(weka_mount.startup_script)
      metadata:
        weka-data_interfaces: 1,2,3 # allocate interfaces 1, 2, 3 and 4 to DPDK
        weka-mode: dpdk
        weka-options: num_cores=3,dpdk_base_memory_mb=16

  - id: compute_partition
    source: community/modules/compute/schedmd-slurm-gcp-v6-partition
    use: [compute_nodeset]
    settings:
      partition_name: compute

  - id: slurm_controller
    source: community/modules/scheduler/schedmd-slurm-gcp-v6-controller
    use:
    - slurm_login
    - compute_partition
    settings:
      deployment_name: "$(vars.deployment_name)$(weka_wait.empty)"
      login_startup_script: $(weka_mount.startup_script)
      enable_controller_public_ips: false
      service_account_email: $(controller_sa.service_account_email)
      subnetwork_self_link: $(weka_cluster.subnets_self_link[0])

  # Login node mounts WEKA in UDP mode
  - id: slurm_login
    source: community/modules/scheduler/schedmd-slurm-gcp-v6-login
    settings:
      enable_login_public_ips: false
      machine_type: n2-standard-4
      service_account_email: $(login_sa.service_account_email)
      subnetwork_self_link: $(weka_cluster.subnets_self_link[0])
