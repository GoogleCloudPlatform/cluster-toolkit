[root@vdi-test-scott-rocky-0 ~]# cat /var/log/messages | awk -F'startup-script: ' '/startup-script:/ {print $2}'
77 files removed
+ rm -rf /var/cache/yum
+ shred --remove /etc/ssh/ssh_host_ecdsa_key /etc/ssh/ssh_host_ecdsa_key.pub /etc/ssh/ssh_host_ed25519_key /etc/ssh/ssh_host_ed25519_key.pub /etc/ssh/ssh_host_rsa_key /etc/ssh/ssh_host_rsa_key.pub
+ truncate -s 0 /var/log/messages
+ rm -rf /root/mpi-tuning/
+ rm -f /root/.bash_history
+ history -c
+ echo 'DaisySuccess: HPC VM tuning complete'
DaisySuccess: HPC VM tuning complete
Thu Jul 24 15:23:27 +0000 2025 Info [1535]: === start executing runner: 99-running-script-warning.sh-54ee ===
Thu Jul 24 15:23:27 +0000 2025 Info [1535]: === 99-running-script-warning.sh-54ee finished with exit_code=0 ===
Thu Jul 24 15:23:29 +0000 2025 Info [1535]: === start executing runner: early_run_hotfixes.sh-b383 ===
Thu Jul 24 15:23:29 +0000 2025 Info [1535]: === early_run_hotfixes.sh-b383 finished with exit_code=0 ===
Thu Jul 24 15:23:30 +0000 2025 Info [1535]: === start executing runner: passed_startup_script.sh-22f5 ===
Thu Jul 24 15:23:32 +0000 2025 Info [1870]: === start executing runner: 99-running-script-warning.sh-54ee ===
Thu Jul 24 15:23:32 +0000 2025 Info [1870]: === 99-running-script-warning.sh-54ee finished with exit_code=0 ===
Thu Jul 24 15:23:34 +0000 2025 Info [1870]: === start executing runner: early_run_hotfixes.sh-b383 ===
Thu Jul 24 15:23:34 +0000 2025 Info [1870]: === early_run_hotfixes.sh-b383 finished with exit_code=0 ===
Thu Jul 24 15:23:36 +0000 2025 Info [1870]: === start executing runner: install_ansible_automatic.sh-ccf1 ===
+ REQ_ANSIBLE_VERSION=2.15
+ REQ_ANSIBLE_PIP_VERSION=8.7.0
+ REQ_PIP_WHEEL_VERSION=0.45.1
+ REQ_PIP_SETUPTOOLS_VERSION=80.8.0
+ REQ_PIP_MAJOR_VERSION=25
+ REQ_PYTHON3_VERSION=9
+ main /usr/local/ghpc-venv
+ '[' 1 -gt 1 ']'
+ venv_path=/usr/local/ghpc-venv
+ get_python_path
+ python_path=
+ command -v python3
++ command -v python3
+ python_path=/usr/bin/python3
+ get_python_major_version /usr/bin/python3
+ python_path=/usr/bin/python3
++ /usr/bin/python3 -c 'import sys; print(sys.version_info.major)'
+ python_major_version=3
+ get_python_minor_version /usr/bin/python3
+ python_path=/usr/bin/python3
++ /usr/bin/python3 -c 'import sys; print(sys.version_info.minor)'
+ python_minor_version=6
+ '[' /usr/bin/python3 = '' ']'
+ '[' 3 = 2 ']'
+ '[' 6 -lt 9 ']'
+ install_python3
+ '[' -f /etc/redhat-release ']'
+ install_python3_dnf
++ rpm -E '%{rhel}'
+ major_version=8
+ set -- '--disablerepo=*' --enablerepo=baseos,appstream
+ grep -qi 'ID="rhel"' /etc/os-release
+ '[' 8 -lt 10 ']'
+ dnf install '--disablerepo=*' --enablerepo=baseos,appstream -y python3.12 python3.12-pip
Waiting for process with pid 1124 to finish.
Last metadata expiration check: 0:00:46 ago on Thu 24 Jul 2025 03:24:31 PM UTC.
Dependencies resolved.
================================================================================
 Package                   Arch       Version               Repository     Size
================================================================================
Installing:
 python3.12                x86_64     3.12.11-1.el8_10      appstream      30 k
 python3.12-pip            noarch     23.2.1-4.el8          appstream     3.2 M
Installing dependencies:
 python3.12-libs           x86_64     3.12.11-1.el8_10      appstream      10 M
 python3.12-pip-wheel      noarch     23.2.1-4.el8          appstream     1.5 M
Installing weak dependencies:
 python3.12-setuptools     noarch     68.2.2-5.el8_10       appstream     1.7 M

Transaction Summary
================================================================================
Install  5 Packages

Total download size: 16 M
Installed size: 65 M
Downloading Packages:
(1/5): python3.12-3.12.11-1.el8_10.x86_64.rpm   858 kB/s |  30 kB     00:00
(2/5): python3.12-libs-3.12.11-1.el8_10.x86_64.  73 MB/s |  10 MB     00:00
(3/5): python3.12-pip-wheel-23.2.1-4.el8.noarch  11 MB/s | 1.5 MB     00:00
(4/5): python3.12-setuptools-68.2.2-5.el8_10.no 6.1 MB/s | 1.7 MB     00:00
(5/5): python3.12-pip-23.2.1-4.el8.noarch.rpm   6.0 MB/s | 3.2 MB     00:00
--------------------------------------------------------------------------------
Total                                            27 MB/s |  16 MB     00:00
Running transaction check
Transaction check succeeded.
Running transaction test
Transaction test succeeded.
Running transaction
  Preparing        :                                                        1/1
  Installing       : python3.12-pip-wheel-23.2.1-4.el8.noarch               1/5
  Installing       : python3.12-libs-3.12.11-1.el8_10.x86_64                2/5
  Installing       : python3.12-3.12.11-1.el8_10.x86_64                     3/5
  Running scriptlet: python3.12-3.12.11-1.el8_10.x86_64                     3/5
  Installing       : python3.12-setuptools-68.2.2-5.el8_10.noarch           4/5
  Installing       : python3.12-pip-23.2.1-4.el8.noarch                     5/5
  Running scriptlet: python3.12-pip-23.2.1-4.el8.noarch                     5/5
  Verifying        : python3.12-3.12.11-1.el8_10.x86_64                     1/5
  Verifying        : python3.12-libs-3.12.11-1.el8_10.x86_64                2/5
  Verifying        : python3.12-pip-23.2.1-4.el8.noarch                     3/5
  Verifying        : python3.12-pip-wheel-23.2.1-4.el8.noarch               4/5
  Verifying        : python3.12-setuptools-68.2.2-5.el8_10.noarch           5/5

Installed:
  python3.12-3.12.11-1.el8_10.x86_64
  python3.12-libs-3.12.11-1.el8_10.x86_64
  python3.12-pip-23.2.1-4.el8.noarch
  python3.12-pip-wheel-23.2.1-4.el8.noarch
  python3.12-setuptools-68.2.2-5.el8_10.noarch

Complete!
++ command -v python3.12
+ python_path=/usr/bin/python3.12
+ get_python_major_version /usr/bin/python3.12
+ python_path=/usr/bin/python3.12
++ /usr/bin/python3.12 -c 'import sys; print(sys.version_info.major)'
+ python_major_version=3
+ get_python_minor_version /usr/bin/python3.12
+ python_path=/usr/bin/python3.12
++ /usr/bin/python3.12 -c 'import sys; print(sys.version_info.minor)'
+ python_minor_version=12
+ /usr/bin/python3.12 -m pip --version
pip 23.2.1 from /usr/lib/python3.12/site-packages/pip (python 3.12)
+ /usr/bin/python3.12 -m venv /usr/local/ghpc-venv --copies
+ venv_python_path=/usr/local/ghpc-venv/bin/python3
++ /usr/local/ghpc-venv/bin/python3 -m pip --version
++ sed -nr 's/^pip ([0-9]+\.[0-9]+).*$/\1/p'
+ pip_version=23.2
++ echo 23.2
++ cut -d . -f 1
+ pip_major_version=23
+ '[' 23 -lt 25 ']'
+ /usr/local/ghpc-venv/bin/python3 -m pip install --upgrade pip
Requirement already satisfied: pip in /usr/local/ghpc-venv/lib64/python3.12/site-packages (23.2.1)
Collecting pip
  Obtaining dependency information for pip from https://files.pythonhosted.org/packages/29/a2/d40fb2460e883eca5199c62cfc2463fd261f760556ae6290f88488c362c0/pip-25.1.1-py3-none-any.whl.metadata
  Downloading pip-25.1.1-py3-none-any.whl.metadata (3.6 kB)
Downloading pip-25.1.1-py3-none-any.whl (1.8 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.8/1.8 MB 28.2 MB/s eta 0:00:00
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 23.2.1
    Uninstalling pip-23.2.1:
      Successfully uninstalled pip-23.2.1
Successfully installed pip-25.1.1
++ /usr/local/ghpc-venv/bin/python3 -m pip list --format=freeze
++ grep '^wheel'
++ true
+ wheel_pkg=
+ '[' '' '!=' wheel==0.45.1 ']'
+ /usr/local/ghpc-venv/bin/python3 -m pip install -U wheel==0.45.1
Collecting wheel==0.45.1
  Downloading wheel-0.45.1-py3-none-any.whl.metadata (2.3 kB)
Downloading wheel-0.45.1-py3-none-any.whl (72 kB)
Installing collected packages: wheel
Successfully installed wheel-0.45.1
++ /usr/local/ghpc-venv/bin/python3 -m pip list --format=freeze
++ grep '^setuptools'
++ true
+ setuptools_pkg=
+ '[' '' '!=' setuptools==80.8.0 ']'
+ /usr/local/ghpc-venv/bin/python3 -m pip install -U setuptools==80.8.0
Collecting setuptools==80.8.0
  Downloading setuptools-80.8.0-py3-none-any.whl.metadata (6.6 kB)
Downloading setuptools-80.8.0-py3-none-any.whl (1.2 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.2/1.2 MB 29.3 MB/s eta 0:00:00
Installing collected packages: setuptools
Successfully installed setuptools-80.8.0
+ '[' '!' -f /etc/ansible/ansible.cfg ']'
+ mkdir /etc/ansible
+ cat
+ ansible_version=
+ command -v ansible-playbook
+ '[' -z '' ']'
+ /usr/local/ghpc-venv/bin/python3 -m pip install ansible==8.7.0
Collecting ansible==8.7.0
  Downloading ansible-8.7.0-py3-none-any.whl.metadata (7.9 kB)
Collecting ansible-core~=2.15.7 (from ansible==8.7.0)
  Downloading ansible_core-2.15.13-py3-none-any.whl.metadata (7.0 kB)
Collecting jinja2>=3.0.0 (from ansible-core~=2.15.7->ansible==8.7.0)
  Downloading jinja2-3.1.6-py3-none-any.whl.metadata (2.9 kB)
Collecting PyYAML>=5.1 (from ansible-core~=2.15.7->ansible==8.7.0)
  Downloading PyYAML-6.0.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (2.1 kB)
Collecting cryptography (from ansible-core~=2.15.7->ansible==8.7.0)
  Downloading cryptography-45.0.5-cp311-abi3-manylinux_2_28_x86_64.whl.metadata (5.7 kB)
Collecting packaging (from ansible-core~=2.15.7->ansible==8.7.0)
  Downloading packaging-25.0-py3-none-any.whl.metadata (3.3 kB)
Collecting resolvelib<1.1.0,>=0.5.3 (from ansible-core~=2.15.7->ansible==8.7.0)
  Downloading resolvelib-1.0.1-py2.py3-none-any.whl.metadata (4.0 kB)
Collecting MarkupSafe>=2.0 (from jinja2>=3.0.0->ansible-core~=2.15.7->ansible==8.7.0)
  Downloading MarkupSafe-3.0.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (4.0 kB)
Collecting cffi>=1.14 (from cryptography->ansible-core~=2.15.7->ansible==8.7.0)
  Downloading cffi-1.17.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata (1.5 kB)
Collecting pycparser (from cffi>=1.14->cryptography->ansible-core~=2.15.7->ansible==8.7.0)
  Downloading pycparser-2.22-py3-none-any.whl.metadata (943 bytes)
Downloading ansible-8.7.0-py3-none-any.whl (48.4 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 48.4/48.4 MB 102.4 MB/s eta 0:00:00
Downloading ansible_core-2.15.13-py3-none-any.whl (2.3 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.3/2.3 MB 105.5 MB/s eta 0:00:00
Downloading resolvelib-1.0.1-py2.py3-none-any.whl (17 kB)
Downloading jinja2-3.1.6-py3-none-any.whl (134 kB)
Downloading MarkupSafe-3.0.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (23 kB)
Downloading PyYAML-6.0.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (767 kB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 767.5/767.5 kB 59.6 MB/s eta 0:00:00
Downloading cryptography-45.0.5-cp311-abi3-manylinux_2_28_x86_64.whl (4.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 4.5/4.5 MB 153.6 MB/s eta 0:00:00
Downloading cffi-1.17.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (479 kB)
Downloading packaging-25.0-py3-none-any.whl (66 kB)
Downloading pycparser-2.22-py3-none-any.whl (117 kB)
Installing collected packages: resolvelib, PyYAML, pycparser, packaging, MarkupSafe, jinja2, cffi, cryptography, ansible-core, ansible

Successfully installed MarkupSafe-3.0.2 PyYAML-6.0.2 ansible-8.7.0 ansible-core-2.15.13 cffi-1.17.1 cryptography-45.0.5 jinja2-3.1.6 packaging-25.0 pycparser-2.22 resolvelib-1.0.1
+ read -r cmd
+ '[' -L /usr/bin/ansible ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible /usr/bin/ansible
+ read -r cmd
+ '[' -L /usr/bin/ansible-config ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-config /usr/bin/ansible-config
+ read -r cmd
+ '[' -L /usr/bin/ansible-connection ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-connection /usr/bin/ansible-connection
+ read -r cmd
+ '[' -L /usr/bin/ansible-console ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-console /usr/bin/ansible-console
+ read -r cmd
+ '[' -L /usr/bin/ansible-doc ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-doc /usr/bin/ansible-doc
+ read -r cmd
+ '[' -L /usr/bin/ansible-galaxy ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-galaxy /usr/bin/ansible-galaxy
+ read -r cmd
+ '[' -L /usr/bin/ansible-inventory ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-inventory /usr/bin/ansible-inventory
+ read -r cmd
+ '[' -L /usr/bin/ansible-playbook ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-playbook /usr/bin/ansible-playbook
+ read -r cmd
+ '[' -L /usr/bin/ansible-pull ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-pull /usr/bin/ansible-pull
+ read -r cmd
+ '[' -L /usr/bin/ansible-test ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-test /usr/bin/ansible-test
+ read -r cmd
+ '[' -L /usr/bin/ansible-vault ']'
+ ln -s /usr/local/ghpc-venv/bin/ansible-vault /usr/bin/ansible-vault
+ read -r cmd
Thu Jul 24 15:25:55 +0000 2025 Info [1870]: === install_ansible_automatic.sh-ccf1 finished with exit_code=0 ===
Thu Jul 24 15:25:57 +0000 2025 Info [1870]: === start executing runner: ansible_docker_settings.json-c21f ===
Thu Jul 24 15:25:57 +0000 2025 Info [1870]: === ansible_docker_settings.json-c21f finished with exit_code=0 ===
Thu Jul 24 15:25:58 +0000 2025 Info [1870]: === start executing runner: install_docker.yml-b4a8 ===

PLAY [Install and configure Docker] ********************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [Gather distribution facts] ***********************************************
ok: [localhost]

TASK [Check if docker is installed] ********************************************
ok: [localhost]

TASK [Add Docker GPG key (Rocky)] **********************************************
changed: [localhost]

TASK [Add Docker repository for Rocky Linux] ***********************************
changed: [localhost]

TASK [Install Docker Engine and related packages on Rocky] *********************
changed: [localhost]

TASK [Install python3-pip] *****************************************************
ok: [localhost]

TASK [Install Docker SDK for Python] *******************************************
changed: [localhost]

TASK [Download Docker Installer (get.docker.com)] ******************************
skipping: [localhost]

TASK [Install Docker] **********************************************************
skipping: [localhost]

TASK [Create Docker daemon configuration] **************************************
skipping: [localhost]

TASK [Create Docker service override directory] ********************************
changed: [localhost]

TASK [Create Docker service override configuration] ****************************
changed: [localhost]

TASK [Create Docker socket override directory] *********************************
skipping: [localhost]

TASK [Create Docker socket override configuration] *****************************
skipping: [localhost]

TASK [Delete Docker socket override configuration] *****************************
ok: [localhost]

RUNNING HANDLER [Refresh dnf cache] ********************************************
ok: [localhost]

TASK [Start Docker] ************************************************************
changed: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=13   changed=7    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0

Thu Jul 24 15:27:29 +0000 2025 Info [1870]: === install_docker.yml-b4a8 finished with exit_code=0 ===
Thu Jul 24 15:27:31 +0000 2025 Info [1870]: === start executing runner: install-deps.sh-1526 ===
+ /usr/local/ghpc-venv/bin/python3 -m pip install requests google-auth docker
Requirement already satisfied: requests in /usr/local/ghpc-venv/lib64/python3.12/site-packages (2.32.4)
Collecting google-auth
  Downloading google_auth-2.40.3-py2.py3-none-any.whl.metadata (6.2 kB)
Requirement already satisfied: docker in /usr/local/ghpc-venv/lib64/python3.12/site-packages (7.1.0)
Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (3.4.2)
Requirement already satisfied: idna<4,>=2.5 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (3.10)
Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (2.5.0)
Requirement already satisfied: certifi>=2017.4.17 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (2025.7.14)
Collecting cachetools<6.0,>=2.0.0 (from google-auth)
  Downloading cachetools-5.5.2-py3-none-any.whl.metadata (5.4 kB)
Collecting pyasn1-modules>=0.2.1 (from google-auth)
  Downloading pyasn1_modules-0.4.2-py3-none-any.whl.metadata (3.5 kB)
Collecting rsa<5,>=3.1.4 (from google-auth)
  Downloading rsa-4.9.1-py3-none-any.whl.metadata (5.6 kB)
Collecting pyasn1>=0.1.3 (from rsa<5,>=3.1.4->google-auth)
  Downloading pyasn1-0.6.1-py3-none-any.whl.metadata (8.4 kB)
Downloading google_auth-2.40.3-py2.py3-none-any.whl (216 kB)
Downloading cachetools-5.5.2-py3-none-any.whl (10 kB)
Downloading rsa-4.9.1-py3-none-any.whl (34 kB)
Downloading pyasn1-0.6.1-py3-none-any.whl (83 kB)
Downloading pyasn1_modules-0.4.2-py3-none-any.whl (181 kB)
Installing collected packages: pyasn1, cachetools, rsa, pyasn1-modules, google-auth

Successfully installed cachetools-5.5.2 google-auth-2.40.3 pyasn1-0.6.1 pyasn1-modules-0.4.2 rsa-4.9.1
+ ansible-galaxy collection install google.cloud
Starting galaxy collection install process
Nothing to do. All requested collections are already installed. If you want to reinstall them, consider using `--force`.
Thu Jul 24 15:27:32 +0000 2025 Info [1870]: === install-deps.sh-1526 finished with exit_code=0 ===
Thu Jul 24 15:27:34 +0000 2025 Info [1870]: === start executing runner: roles.tar.gz-d489 ===
Thu Jul 24 15:27:34 +0000 2025 Info [1870]: === roles.tar.gz-d489 finished with exit_code=0 ===
Thu Jul 24 15:27:36 +0000 2025 Info [1870]: === start executing runner: unpack_roles.sh-994e ===
+ mkdir -p /tmp/vdi/roles
+ tar xzf /tmp/vdi/roles.tar.gz -C /tmp/vdi/roles
Thu Jul 24 15:27:36 +0000 2025 Info [1870]: === unpack_roles.sh-994e finished with exit_code=0 ===
Thu Jul 24 15:27:38 +0000 2025 Info [1870]: === start executing runner: vars.yaml-faf2 ===
Thu Jul 24 15:27:38 +0000 2025 Info [1870]: === vars.yaml-faf2 finished with exit_code=0 ===
Thu Jul 24 15:27:40 +0000 2025 Info [1870]: === start executing runner: install.yaml-f44d ===
Using /etc/ansible/ansible.cfg as config file

PLAY [localhost] ***************************************************************

TASK [Gathering Facts] *********************************************************
ok: [localhost]

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "exists": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: False

TASK [lock_manager : Load existing lock file] **********************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file load result] ******************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and lock_file_stat.stat.exists"
}

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "none",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:41Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "none",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: False
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": false
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for lock_manager:
  - not lock_file_exists: True
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for lock_manager:
  - current_role: not set
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: False
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [lock_manager : Set current role (only if not already set)] ***************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "lock_manager"
    },
    "changed": false
}

TASK [lock_manager : Debug lock manager role execution] ************************
ok: [localhost] => {}

MSG:

Lock manager role started - operation: check for role: lock_manager

TASK [lock_manager : Ensure lock directory exists] *****************************
changed: [localhost] => {
    "changed": true,
    "gid": 0,
    "group": "root",
    "mode": "0755",
    "owner": "root",
    "path": "/opt/vdi-setup",
    "size": 6,
    "state": "directory",
    "uid": 0
}

TASK [lock_manager : Debug lock directory status] ******************************
ok: [localhost] => {}

MSG:

Lock directory created: True

TASK [lock_manager : Include check lock tasks] *********************************
included: /tmp/vdi/roles/lock_manager/tasks/check_lock.yaml for localhost

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "exists": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: False

TASK [lock_manager : Load existing lock file] **********************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file load result] ******************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and lock_file_stat.stat.exists"
}

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "none",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:41Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "none",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: False
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": false
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for lock_manager:
  - not lock_file_exists: True
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for lock_manager:
  - current_role: lock_manager
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: False
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [lock_manager : Include create lock tasks] ********************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_operation | default('check') == 'create'",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Include cleanup lock tasks] *******************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_operation | default('check') == 'cleanup'",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock manager role completion] ***********************
ok: [localhost] => {}

MSG:

Lock manager role completed - operation: check

TASK [lock_manager : Mark lock_manager role as completed] **********************
included: /tmp/vdi/roles/lock_manager/tasks/create_lock.yaml for localhost

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: lock_manager

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "exists": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: False

TASK [lock_manager : Create initial lock file structure] ***********************
changed: [localhost] => {
    "changed": true,
    "checksum": "8479c862b92b39583c151fca822f92954c92eee0",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "e3c95caac8aea2fba82a6d39dec216d8",
    "mode": "0644",
    "owner": "root",
    "size": 909,
    "src": "/root/.ansible/tmp/ansible-tmp-1753370864.1744716-6171-78949705975838/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug lock file creation] *********************************
ok: [localhost] => {}

MSG:

Lock file created: True

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:41Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:41Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:41Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.002395",
    "end": "2025-07-24 15:27:44.996404",
    "rc": 0,
    "start": "2025-07-24 15:27:44.994009"
}

STDOUT:

2025-07-24T15:27:44Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:41Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:27:41Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": []
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:27:44Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:27:44Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": false
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:27:44Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for lock_manager:
  - completed: True
  - completed_at: 2025-07-24T15:27:44Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating lock_manager:
  - current_lock_data: completed_roles:
    base_os:
        completed: false
    lock_manager:
        completed: false
    secret_manager:
        completed: false
    user_provision:
        completed: false
    vdi_tool:
        completed: false
    vnc:
        completed: false
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:27:44Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users: []
    previous_users: []
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:27:44Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated: []

  - current_completed_roles: base_os:
    completed: false
lock_manager:
    completed: false
secret_manager:
    completed: false
user_provision:
    completed: false
vdi_tool:
    completed: false
vnc:
    completed: false

  - role_completed: True
  - current_role: lock_manager


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": false
            },
            "lock_manager": {
                "completed": false
            },
            "secret_manager": {
                "completed": false
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": false
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": false
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": []
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating lock_manager:
  - current_role: lock_manager
  - role_completed: True
  - completed_roles: {'base_os': {'completed': False}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': False}, 'user_provision': {'completed': False}, 'vnc': {'completed': False}, 'vdi_tool': {'completed': False}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": []
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for lock_manager:
  - current_users_updated: []
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:27:44Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": []
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:27:44Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [],
            "previous_users": [],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for lock_manager:
  - current_users: ['alice', 'bob']
  - previous_users: []
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": false
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: False
  - setup_status: configuring
  - completed_roles_count: 1
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "358a7f4095fbb49a0eedafd77e97040d1b9b5a26",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "2cf874286e9bf3b17fc771283955c695",
    "mode": "0644",
    "owner": "root",
    "size": 879,
    "src": "/root/.ansible/tmp/ansible-tmp-1753370865.96913-6272-170962703062563/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.005528",
    "end": "2025-07-24 15:27:46.510774",
    "rc": 0,
    "start": "2025-07-24 15:27:46.505246"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNToyNzo0NFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOiBbXQogICAgcmVtb3ZlZF91c2VyczogW10KICB1c2VyX3NlY3JldHNfc3RhdHVzOgogICAgbGFzdF9zZWNyZXRfY2hlY2s6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHVzZXJfc2VjcmV0c19oYXNoOiA2YTZhMDJkM2QwOTkzM2NhMjgyYWUyYjAyMzM2MzQzYzlkNzM3MDFlNDViZDgxNDc1ZmJkOTJkY2Y5ZDJmM2I2CiAgICB1c2Vyc191cGRhdGVkOgogICAgLSBhbGljZQogICAgLSBib2IK

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNToyNzo0NFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOiBbXQogICAgcmVtb3ZlZF91c2VyczogW10KICB1c2VyX3NlY3JldHNfc3RhdHVzOgogICAgbGFzdF9zZWNyZXRfY2hlY2s6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHVzZXJfc2VjcmV0c19oYXNoOiA2YTZhMDJkM2QwOTkzM2NhMjgyYWUyYjAyMzM2MzQzYzlkNzM3MDFlNDViZDgxNDc1ZmJkOTJkY2Y5ZDJmM2I2CiAgICB1c2Vyc191cGRhdGVkOgogICAgLSBhbGljZQogICAgLSBib2IK",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:04.460963",
    "end": "2025-07-24 15:27:51.159269",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:27:46.698306"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.050900",
    "end": "2025-07-24 15:27:51.433067",
    "rc": 0,
    "start": "2025-07-24 15:27:51.382167"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "exists": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: lock_manager
  - vdi_monitor_service_exists: False
  - lock_file_creation.changed: True
  - will_setup_monitor: True


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
included: /tmp/vdi/roles/lock_manager/tasks/monitor_setup.yaml for localhost

TASK [lock_manager : Create VDI monitor script directory] **********************
ok: [localhost] => {
    "changed": false,
    "gid": 0,
    "group": "root",
    "mode": "0755",
    "owner": "root",
    "path": "/usr/local/bin",
    "size": 6,
    "state": "directory",
    "uid": 0
}

TASK [lock_manager : Copy VDI monitor script] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "49f5302fb57094d20c194a1f7379da9d16209de7",
    "dest": "/usr/local/bin/vdi-monitor.sh",
    "gid": 0,
    "group": "root",
    "md5sum": "62d4f0ae8c6876764d097330ba1393cb",
    "mode": "0755",
    "owner": "root",
    "size": 5348,
    "src": "/root/.ansible/tmp/ansible-tmp-1753370871.9519365-6406-123074483660618/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Copy VDI monitor systemd service] *************************
changed: [localhost] => {
    "changed": true,
    "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
    "dest": "/etc/systemd/system/vdi-monitor.service",
    "gid": 0,
    "group": "root",
    "md5sum": "03b2639860cf4c6a87c36ae7f885909d",
    "mode": "0644",
    "owner": "root",
    "size": 283,
    "src": "/root/.ansible/tmp/ansible-tmp-1753370872.3131151-6428-31276884095225/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Create VDI monitor log directory] *************************
ok: [localhost] => {
    "changed": false,
    "gid": 0,
    "group": "root",
    "mode": "0755",
    "owner": "root",
    "path": "/var/log",
    "size": 4096,
    "state": "directory",
    "uid": 0
}

TASK [lock_manager : Create VDI monitor log files] *****************************
changed: [localhost] => (item=/var/log/vdi-monitor.log) => {
    "ansible_loop_var": "item",
    "changed": true,
    "dest": "/var/log/vdi-monitor.log",
    "gid": 0,
    "group": "root",
    "item": "/var/log/vdi-monitor.log",
    "mode": "0644",
    "owner": "root",
    "size": 0,
    "state": "file",
    "uid": 0
}
changed: [localhost] => (item=/var/log/ansible-vdi-reconfig.log) => {
    "ansible_loop_var": "item",
    "changed": true,
    "dest": "/var/log/ansible-vdi-reconfig.log",
    "gid": 0,
    "group": "root",
    "item": "/var/log/ansible-vdi-reconfig.log",
    "mode": "0644",
    "owner": "root",
    "size": 0,
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Reload systemd daemon] ************************************
ok: [localhost] => {
    "changed": false,
    "name": null,
    "status": {}
}

TASK [lock_manager : Enable VDI monitor service] *******************************
changed: [localhost] => {
    "changed": true,
    "enabled": true,
    "name": "vdi-monitor",
    "state": "started",
    "status": {
        "ActiveEnterTimestampMonotonic": "0",
        "ActiveExitTimestampMonotonic": "0",
        "ActiveState": "inactive",
        "After": "systemd-journald.socket network.target system.slice sysinit.target basic.target",
        "AllowIsolate": "no",
        "AllowedCPUs": "",
        "AllowedMemoryNodes": "",
        "AmbientCapabilities": "",
        "AssertResult": "no",
        "AssertTimestampMonotonic": "0",
        "Before": "shutdown.target",
        "BlockIOAccounting": "no",
        "BlockIOWeight": "[not set]",
        "CPUAccounting": "no",
        "CPUAffinity": "",
        "CPUAffinityFromNUMA": "no",
        "CPUQuotaPerSecUSec": "infinity",
        "CPUQuotaPeriodUSec": "infinity",
        "CPUSchedulingPolicy": "0",
        "CPUSchedulingPriority": "0",
        "CPUSchedulingResetOnFork": "no",
        "CPUShares": "[not set]",
        "CPUUsageNSec": "[not set]",
        "CPUWeight": "[not set]",
        "CacheDirectoryMode": "0755",
        "CanFreeze": "yes",
        "CanIsolate": "no",
        "CanReload": "no",
        "CanStart": "yes",
        "CanStop": "yes",
        "CapabilityBoundingSet": "cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap_ipc_owner cap_sys_module cap_sys_rawio cap_sys_chroot cap_sys_ptrace cap_sys_pacct cap_sys_admin cap_sys_boot cap_sys_nice cap_sys_resource cap_sys_time cap_sys_tty_config cap_mknod cap_lease cap_audit_write cap_audit_control cap_setfcap cap_mac_override cap_mac_admin cap_syslog cap_wake_alarm cap_block_suspend cap_audit_read cap_perfmon cap_bpf",
        "CollectMode": "inactive",
        "ConditionResult": "no",
        "ConditionTimestampMonotonic": "0",
        "ConfigurationDirectoryMode": "0755",
        "Conflicts": "shutdown.target",
        "ControlPID": "0",
        "DefaultDependencies": "yes",
        "DefaultMemoryLow": "0",
        "DefaultMemoryMin": "0",
        "Delegate": "no",
        "Description": "VDI Configuration Monitor",
        "DevicePolicy": "auto",
        "DynamicUser": "no",
        "EffectiveCPUs": "",
        "EffectiveMemoryNodes": "",
        "ExecMainCode": "0",
        "ExecMainExitTimestampMonotonic": "0",
        "ExecMainPID": "0",
        "ExecMainStartTimestampMonotonic": "0",
        "ExecMainStatus": "0",
        "ExecStart": "{ path=/usr/local/bin/vdi-monitor.sh ; argv[]=/usr/local/bin/vdi-monitor.sh ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "FailureAction": "none",
        "FileDescriptorStoreMax": "0",
        "FragmentPath": "/etc/systemd/system/vdi-monitor.service",
        "FreezerState": "running",
        "GID": "[not set]",
        "Group": "root",
        "GuessMainPID": "yes",
        "IOAccounting": "no",
        "IOSchedulingClass": "0",
        "IOSchedulingPriority": "0",
        "IOWeight": "[not set]",
        "IPAccounting": "no",
        "IPEgressBytes": "18446744073709551615",
        "IPEgressPackets": "18446744073709551615",
        "IPIngressBytes": "18446744073709551615",
        "IPIngressPackets": "18446744073709551615",
        "Id": "vdi-monitor.service",
        "IgnoreOnIsolate": "no",
        "IgnoreSIGPIPE": "yes",
        "InactiveEnterTimestampMonotonic": "0",
        "InactiveExitTimestampMonotonic": "0",
        "JobRunningTimeoutUSec": "infinity",
        "JobTimeoutAction": "none",
        "JobTimeoutUSec": "infinity",
        "KeyringMode": "private",
        "KillMode": "control-group",
        "KillSignal": "15",
        "LimitAS": "infinity",
        "LimitASSoft": "infinity",
        "LimitCORE": "infinity",
        "LimitCORESoft": "0",
        "LimitCPU": "infinity",
        "LimitCPUSoft": "infinity",
        "LimitDATA": "infinity",
        "LimitDATASoft": "infinity",
        "LimitFSIZE": "infinity",
        "LimitFSIZESoft": "infinity",
        "LimitLOCKS": "infinity",
        "LimitLOCKSSoft": "infinity",
        "LimitMEMLOCK": "65536",
        "LimitMEMLOCKSoft": "65536",
        "LimitMSGQUEUE": "819200",
        "LimitMSGQUEUESoft": "819200",
        "LimitNICE": "0",
        "LimitNICESoft": "0",
        "LimitNOFILE": "262144",
        "LimitNOFILESoft": "1024",
        "LimitNPROC": "127383",
        "LimitNPROCSoft": "127383",
        "LimitRSS": "infinity",
        "LimitRSSSoft": "infinity",
        "LimitRTPRIO": "0",
        "LimitRTPRIOSoft": "0",
        "LimitRTTIME": "infinity",
        "LimitRTTIMESoft": "infinity",
        "LimitSIGPENDING": "127383",
        "LimitSIGPENDINGSoft": "127383",
        "LimitSTACK": "infinity",
        "LimitSTACKSoft": "8388608",
        "LoadState": "loaded",
        "LockPersonality": "no",
        "LogLevelMax": "-1",
        "LogRateLimitBurst": "0",
        "LogRateLimitIntervalUSec": "0",
        "LogsDirectoryMode": "0755",
        "MainPID": "0",
        "MemoryAccounting": "yes",
        "MemoryCurrent": "[not set]",
        "MemoryDenyWriteExecute": "no",
        "MemoryHigh": "infinity",
        "MemoryLimit": "infinity",
        "MemoryLow": "0",
        "MemoryMax": "infinity",
        "MemoryMin": "0",
        "MemorySwapMax": "infinity",
        "MountAPIVFS": "no",
        "MountFlags": "",
        "NFileDescriptorStore": "0",
        "NRestarts": "0",
        "NUMAMask": "",
        "NUMAPolicy": "n/a",
        "Names": "vdi-monitor.service",
        "NeedDaemonReload": "no",
        "Nice": "0",
        "NoNewPrivileges": "no",
        "NonBlocking": "no",
        "NotifyAccess": "none",
        "OOMScoreAdjust": "0",
        "OnFailureJobMode": "replace",
        "PermissionsStartOnly": "no",
        "Perpetual": "no",
        "PrivateDevices": "no",
        "PrivateMounts": "no",
        "PrivateNetwork": "no",
        "PrivateTmp": "no",
        "PrivateUsers": "no",
        "ProtectControlGroups": "no",
        "ProtectHome": "no",
        "ProtectKernelModules": "no",
        "ProtectKernelTunables": "no",
        "ProtectSystem": "no",
        "RefuseManualStart": "no",
        "RefuseManualStop": "no",
        "RemainAfterExit": "no",
        "RemoveIPC": "no",
        "Requires": "sysinit.target system.slice",
        "Restart": "always",
        "RestartUSec": "30s",
        "RestrictNamespaces": "no",
        "RestrictRealtime": "no",
        "RestrictSUIDSGID": "no",
        "Result": "success",
        "RootDirectoryStartOnly": "no",
        "RuntimeDirectoryMode": "0755",
        "RuntimeDirectoryPreserve": "no",
        "RuntimeMaxUSec": "infinity",
        "SameProcessGroup": "no",
        "SecureBits": "0",
        "SendSIGHUP": "no",
        "SendSIGKILL": "yes",
        "Slice": "system.slice",
        "StandardError": "journal",
        "StandardInput": "null",
        "StandardInputData": "",
        "StandardOutput": "journal",
        "StartLimitAction": "none",
        "StartLimitBurst": "5",
        "StartLimitIntervalUSec": "10s",
        "StartupBlockIOWeight": "[not set]",
        "StartupCPUShares": "[not set]",
        "StartupCPUWeight": "[not set]",
        "StartupIOWeight": "[not set]",
        "StateChangeTimestampMonotonic": "0",
        "StateDirectoryMode": "0755",
        "StatusErrno": "0",
        "StopWhenUnneeded": "no",
        "SubState": "dead",
        "SuccessAction": "none",
        "SyslogFacility": "3",
        "SyslogLevel": "6",
        "SyslogLevelPrefix": "yes",
        "SyslogPriority": "30",
        "SystemCallErrorNumber": "0",
        "TTYReset": "no",
        "TTYVHangup": "no",
        "TTYVTDisallocate": "no",
        "TasksAccounting": "yes",
        "TasksCurrent": "[not set]",
        "TasksMax": "203813",
        "TimeoutStartUSec": "1min 30s",
        "TimeoutStopUSec": "1min 30s",
        "TimerSlackNSec": "50000",
        "Transient": "no",
        "Type": "simple",
        "UID": "[not set]",
        "UMask": "0022",
        "UnitFilePreset": "disabled",
        "UnitFileState": "disabled",
        "User": "root",
        "UtmpMode": "init",
        "Wants": "network.target",
        "WatchdogTimestampMonotonic": "0",
        "WatchdogUSec": "0"
    }
}

TASK [lock_manager : Debug VDI monitor setup] **********************************
ok: [localhost] => {}

MSG:

VDI monitor service setup complete:
  - Service: vdi-monitor.service
  - Script: /usr/local/bin/vdi-monitor.sh
  - Logs: /var/log/vdi-monitor.log, /var/log/ansible-vdi-reconfig.log
  - Service enabled and started


TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

TASK [base_os : DEBUG About to import lock_manager for base_os] ****************
ok: [localhost] => {}

MSG:

About to import lock_manager for base_os

TASK [base_os : Set current role for lock manager check] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "base_os"
    },
    "changed": false
}

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370866.5072315,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "358a7f4095fbb49a0eedafd77e97040d1b9b5a26",
        "ctime": 1753370866.2832148,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 891734,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370866.137204,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 879,
        "uid": 0,
        "version": "3120075969",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Load existing lock file] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Debug lock file load result] ******************************
ok: [localhost] => {}

MSG:

Lock file loaded successfully: True

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: True
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": true
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for base_os:
  - not lock_file_exists: False
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for base_os:
  - current_role: base_os
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: True
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [base_os : DEBUG Finished import_role for base_os] ************************
ok: [localhost] => {}

MSG:

Finished import_role for base_os

TASK [base_os : Set role_should_run from lock check result] ********************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [base_os : Skip base_os tasks if role should not run] *********************
skipping: [localhost] => {
    "false_condition": "not role_should_run"
}

TASK [base_os : Gather distribution facts] *************************************
ok: [localhost]

TASK [base_os : Check if NVIDIA GPU is present] ********************************
changed: [localhost] => {
    "changed": true,
    "cmd": "lspci | grep -i nvidia",
    "delta": "0:00:00.013393",
    "end": "2025-07-24 15:27:55.866012",
    "failed_when_result": false,
    "rc": 1,
    "start": "2025-07-24 15:27:55.852619"
}

MSG:

non-zero return code

TASK [base_os : Include Ubuntu-specific tasks] *********************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "ansible_facts.distribution == 'Ubuntu'",
    "skip_reason": "Conditional result was False"
}

TASK [base_os : Include Rocky Linux specific tasks] ****************************
included: /tmp/vdi/roles/base_os/tasks/rocky.yaml for localhost

TASK [base_os : Set Rocky Linux specific variables] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "gui_packages": [
            "@Xfce",
            "@base-x"
        ],
        "vnc_pkg": "tigervnc-server",
        "xorg_dev_packages": [
            "pkgconfig",
            "xorg-x11-server-devel",
            "xorg-x11-util-macros",
            "libglvnd-devel"
        ]
    },
    "changed": false
}

TASK [base_os : Update repository cache & install EPEL (Rocky Linux only)] *****
ok: [localhost] => {
    "changed": false,
    "rc": 0,
    "results": []
}

MSG:

Nothing to do

TASK [base_os : Install desktop prerequisites & VNC package (Rocky Linux)] *****
changed: [localhost] => {
    "changed": true,
    "rc": 0,
    "results": [
        "Group xfce-desktop installed.",
        "Group base-x installed.",
        "Installed: garcon-4.16.1-1.el8.x86_64",
        "Installed: desktop-file-utils-0.26-1.el8.x86_64",
        "Installed: libfontenc-devel-1.1.3-8.el8.x86_64",
        "Installed: accountsservice-0.6.55-4.el8.x86_64",
        "Installed: vte-profile-0.52.4-2.el8.x86_64",
        "Installed: accountsservice-libs-0.6.55-4.el8.x86_64",
        "Installed: vte291-0.52.4-2.el8.x86_64",
        "Installed: bluez-5.63-5.el8_10.x86_64",
        "Installed: bluez-libs-5.63-5.el8_10.x86_64",
        "Installed: adwaita-cursor-theme-3.28.0-3.el8.noarch",
        "Installed: bluez-obexd-5.63-5.el8_10.x86_64",
        "Installed: adwaita-gtk2-theme-3.22.3-4.el8.x86_64",
        "Installed: adwaita-icon-theme-3.28.0-3.el8.noarch",
        "Installed: ostree-libs-2022.2-8.el8.x86_64",
        "Installed: bolt-0.9.1-1.el8.x86_64",
        "Installed: libasyncns-0.8-14.el8.x86_64",
        "Installed: alsa-lib-1.2.10-2.el8.x86_64",
        "Installed: python3-pysocks-1.6.8-3.el8.noarch",
        "Installed: libavc1394-0.5.4-7.el8.x86_64",
        "Installed: wavpack-5.1.0-16.el8.x86_64",
        "Installed: thunar-archive-plugin-0.4.0-26.el8.x86_64",
        "Installed: thunar-volman-4.16.0-3.el8.x86_64",
        "Installed: poppler-20.11.0-12.el8_10.x86_64",
        "Installed: poppler-data-0.4.9-2.el8.noarch",
        "Installed: python3-requests-2.20.0-5.el8_10.noarch",
        "Installed: xfce-polkit-0.3-3.el8.x86_64",
        "Installed: xfce4-appfinder-4.16.1-3.el8.x86_64",
        "Installed: poppler-glib-20.11.0-12.el8_10.x86_64",
        "Installed: libquvi-0.9.4-12.el8.x86_64",
        "Installed: libquvi-scripts-0.9.20131130-9.el8.noarch",
        "Installed: hunspell-1.6.2-1.el8.x86_64",
        "Installed: libraw1394-2.1.2-5.el8.x86_64",
        "Installed: pangomm-2.40.1-6.el8.x86_64",
        "Installed: webkit2gtk3-2.48.3-1.el8_10.x86_64",
        "Installed: llvm-compat-libs-17.0.6-3.module+el8.10.0+1875+4f0b06db.x86_64",
        "Installed: libical-3.0.3-3.el8.x86_64",
        "Installed: xfce4-panel-4.16.3-1.el8.x86_64",
        "Installed: xfce4-power-manager-4.16.0-1.el8.x86_64",
        "Installed: xfce4-pulseaudio-plugin-0.4.3-3.el8.x86_64",
        "Installed: bzip2-devel-1.0.6-28.el8_10.x86_64",
        "Installed: sbc-1.3-9.el8.x86_64",
        "Installed: xfce4-screensaver-4.16.0-3.el8.x86_64",
        "Installed: pavucontrol-3.0-11.el8.x86_64",
        "Installed: xfce4-session-4.16.0-4.el8.x86_64",
        "Installed: xfce4-settings-4.16.5-2.el8.x86_64",
        "Installed: gnome-themes-standard-3.22.3-4.el8.x86_64",
        "Installed: xfce4-terminal-1.0.4-1.el8.x86_64",
        "Installed: hunspell-en-0.20140811.1-12.el8.noarch",
        "Installed: hunspell-en-GB-0.20140811.1-12.el8.noarch",
        "Installed: hunspell-en-US-0.20140811.1-12.el8.noarch",
        "Installed: mobile-broadband-provider-info-20210805-1.el8.noarch",
        "Installed: xfconf-4.16.0-1.el8.x86_64",
        "Installed: xfdesktop-4.16.0-3.el8.x86_64",
        "Installed: webkit2gtk3-jsc-2.48.3-1.el8_10.x86_64",
        "Installed: xfwm4-4.16.1-1.el8.x86_64",
        "Installed: libcanberra-0.30-18.el8.x86_64",
        "Installed: webrtc-audio-processing-0.3-10.el8.x86_64",
        "Installed: python3-urllib3-1.24.2-8.el8_10.noarch",
        "Installed: libmousepad0-0.5.6-1.el8.x86_64",
        "Installed: libcanberra-gtk3-0.30-18.el8.x86_64",
        "Installed: crda-3.18_2020.04.29-1.el8.noarch",
        "Installed: cairo-gobject-1.15.12-6.el8.x86_64",
        "Installed: tumbler-0.2.7-1.el8.x86_64",
        "Installed: woff2-1.0.2-5.el8.x86_64",
        "Installed: cairomm-1.12.0-8.el8.x86_64",
        "Installed: libmodman-2.0.1-17.el8.x86_64",
        "Installed: libXvMC-1.0.12-1.el8.x86_64",
        "Installed: aspell-12:0.60.6.1-22.el8.x86_64",
        "Installed: libdbusmenu-16.04.0-12.el8.x86_64",
        "Installed: libdbusmenu-gtk3-16.04.0-12.el8.x86_64",
        "Installed: xcb-util-0.4.0-10.el8.x86_64",
        "Installed: python3-chardet-3.0.4-7.el8.noarch",
        "Installed: lua-expat-1.3.0-12.el8.1.x86_64",
        "Installed: gsettings-desktop-schemas-3.32.0-6.el8.x86_64",
        "Installed: libdmx-1.1.4-3.el8.x86_64",
        "Installed: rocky-logos-86.3-1.el8.x86_64",
        "Installed: lua-socket-3.0-0.17.rc1.el8.x86_64",
        "Installed: libdrm-2.4.115-2.el8.x86_64",
        "Installed: xdg-desktop-portal-1.12.6-1.el8.x86_64",
        "Installed: libdrm-devel-2.4.115-2.el8.x86_64",
        "Installed: cheese-libs-2:3.28.0-4.el8_6.x86_64",
        "Installed: libdv-1.0.0-27.el8.x86_64",
        "Installed: libshout-2.2.2-19.el8.x86_64",
        "Installed: libdvdnav-5.0.3-8.el8.x86_64",
        "Installed: libsigc++20-2.10.0-6.el8.x86_64",
        "Installed: libdvdread-5.0.3-9.el8.x86_64",
        "Installed: xdg-desktop-portal-gtk-1.12.0-1.el8.x86_64",
        "Installed: samba-common-4.19.4-9.el8_10.noarch",
        "Installed: libepoxy-1.5.8-1.el8.x86_64",
        "Installed: python3-pycurl-7.43.0.2-4.el8.x86_64",
        "Installed: xorg-x11-drv-ati-19.1.0-1.el8.x86_64",
        "Installed: dejavu-fonts-common-2.35-7.el8.noarch",
        "Installed: libsndfile-1.0.28-16.el8_10.x86_64",
        "Installed: xorg-x11-drv-evdev-2.10.6-2.el8.x86_64",
        "Installed: dejavu-sans-mono-fonts-2.35-7.el8.noarch",
        "Installed: xorg-x11-drv-fbdev-0.5.0-2.el8.x86_64",
        "Installed: flac-libs-1.3.2-11.el8.x86_64",
        "Installed: libevdev-1.10.0-1.el8.x86_64",
        "Installed: nm-connection-editor-1.26.0-1.el8.x86_64",
        "Installed: flatpak-1.12.9-3.el8_10.x86_64",
        "Installed: libexif-0.6.22-5.el8_3.x86_64",
        "Installed: xorg-x11-drv-intel-2.99.917-41.20210115.el8.x86_64",
        "Installed: xorg-x11-drv-libinput-0.29.0-1.el8.x86_64",
        "Installed: xorg-x11-drv-nouveau-1:1.0.15-4.el8.1.x86_64",
        "Installed: xorg-x11-drv-qxl-0.1.5-11.el8.x86_64",
        "Installed: xorg-x11-drv-vesa-2.4.0-3.el8.x86_64",
        "Installed: xorg-x11-drv-vmware-13.2.1-8.el8.x86_64",
        "Installed: xorg-x11-drv-wacom-0.38.0-1.el8.x86_64",
        "Installed: xorg-x11-drv-wacom-serial-support-0.38.0-1.el8.x86_64",
        "Installed: flatpak-selinux-1.12.9-3.el8_10.noarch",
        "Installed: libsrtp-1.5.4-8.el8.x86_64",
        "Installed: sound-theme-freedesktop-0.8-9.el8.noarch",
        "Installed: flatpak-session-helper-1.12.9-3.el8_10.x86_64",
        "Installed: soundtouch-2.0.0-3.el8.x86_64",
        "Installed: iw-5.19-1.el8.1.x86_64",
        "Installed: libpciaccess-0.14-1.el8.x86_64",
        "Installed: libgdata-0.17.9-4.el8.x86_64",
        "Installed: at-spi2-atk-2.26.2-1.el8.x86_64",
        "Installed: libpng-devel-2:1.6.34-5.el8.x86_64",
        "Installed: at-spi2-core-2.28.0-1.el8.x86_64",
        "Installed: xorg-x11-proto-devel-2020.1-3.el8.noarch",
        "Installed: libproxy-0.4.15-5.5.el8_10.x86_64",
        "Installed: hyphen-2.8.8-9.el8.x86_64",
        "Installed: speex-1.2.0-1.el8.x86_64",
        "Installed: libglvnd-1:1.3.4-2.el8.x86_64",
        "Installed: speexdsp-1.2-0.13.rc3.el8.x86_64",
        "Installed: libglvnd-core-devel-1:1.3.4-2.el8.x86_64",
        "Installed: samba-client-libs-4.19.4-9.el8_10.x86_64",
        "Installed: atkmm-2.24.2-7.el8.x86_64",
        "Installed: libglvnd-devel-1:1.3.4-2.el8.x86_64",
        "Installed: libglvnd-egl-1:1.3.4-2.el8.x86_64",
        "Installed: libglvnd-gles-1:1.3.4-2.el8.x86_64",
        "Installed: clutter-1.26.2-8.el8.x86_64",
        "Installed: libglvnd-glx-1:1.3.4-2.el8.x86_64",
        "Installed: libtheora-1:1.1.1-21.el8.x86_64",
        "Installed: libglvnd-opengl-1:1.3.4-2.el8.x86_64",
        "Installed: clutter-gst3-3.0.26-1.el8.x86_64",
        "Installed: libgnomekbd-3.26.0-4.el8.x86_64",
        "Installed: clutter-gtk-1.8.4-3.el8.x86_64",
        "Installed: tigervnc-license-1.15.0-7.el8_10.noarch",
        "Installed: xorg-x11-server-Xorg-1.20.11-26.el8_10.x86_64",
        "Installed: gcr-3.28.0-1.el8.x86_64",
        "Installed: xorg-x11-server-Xwayland-21.1.3-18.el8_10.x86_64",
        "Installed: tigervnc-selinux-1.15.0-7.el8_10.noarch",
        "Installed: xorg-x11-server-common-1.20.11-26.el8_10.x86_64",
        "Installed: p11-kit-server-0.23.22-2.el8.x86_64",
        "Installed: xorg-x11-utils-7.5-28.el8.x86_64",
        "Installed: xorg-x11-xauth-1:1.0.9-12.el8.x86_64",
        "Installed: samba-common-libs-4.19.4-9.el8_10.x86_64",
        "Installed: xorg-x11-xinit-1.3.4-18.el8.x86_64",
        "Installed: xorg-x11-xinit-session-1.3.4-18.el8.x86_64",
        "Installed: xorg-x11-xkb-utils-7.7-28.el8.x86_64",
        "Installed: tigervnc-server-1.15.0-7.el8_10.x86_64",
        "Installed: libgtop2-2.38.0-3.el8.x86_64",
        "Installed: gdm-1:40.0-27.el8.x86_64",
        "Installed: tigervnc-server-minimal-1.15.0-7.el8_10.x86_64",
        "Installed: startup-notification-0.12-15.el8.x86_64",
        "Installed: cogl-1.22.2-10.el8.x86_64",
        "Installed: color-filesystem-1-20.el8.noarch",
        "Installed: colord-1.4.2-1.el8.x86_64",
        "Installed: libusbmuxd-1.0.10-9.el8.x86_64",
        "Installed: colord-gtk-0.1.26-8.el8.x86_64",
        "Installed: colord-libs-1.4.2-1.el8.x86_64",
        "Installed: libv4l-1.14.2-3.el8.x86_64",
        "Installed: keybinder3-0.3.2-4.el8.x86_64",
        "Installed: zenity-3.28.1-2.el8.x86_64",
        "Installed: ibus-1.5.19-15.el8_10.x86_64",
        "Installed: geoclue2-2.5.5-2.el8.x86_64",
        "Installed: ibus-gtk2-1.5.19-15.el8_10.x86_64",
        "Installed: geoclue2-libs-2.5.5-2.el8.x86_64",
        "Installed: ibus-gtk3-1.5.19-15.el8_10.x86_64",
        "Installed: geocode-glib-3.26.0-4.el8_10.x86_64",
        "Installed: ibus-libs-1.5.19-15.el8_10.x86_64",
        "Installed: lame-libs-3.100-6.el8.x86_64",
        "Installed: libgweather-3.28.2-4.el8.x86_64",
        "Installed: ibus-setup-1.5.19-15.el8_10.noarch",
        "Installed: libsmbclient-4.19.4-9.el8_10.x86_64",
        "Installed: mousepad-0.5.6-1.el8.x86_64",
        "Installed: switcheroo-control-1.1-5.el8.x86_64",
        "Installed: mesa-dri-drivers-23.1.4-4.el8_10.x86_64",
        "Installed: libiec61883-1.2.0-18.el8.x86_64",
        "Installed: mesa-filesystem-23.1.4-4.el8_10.x86_64",
        "Installed: libsoup-2.62.3-9.el8_10.x86_64",
        "Installed: mesa-libEGL-23.1.4-4.el8_10.x86_64",
        "Installed: libimobiledevice-1.2.0-16.el8.x86_64",
        "Installed: system-config-printer-libs-1.5.11-13.el8.noarch",
        "Installed: libinput-1.16.3-3.el8_6.x86_64",
        "Installed: mesa-libGL-23.1.4-4.el8_10.x86_64",
        "Installed: freetype-devel-2.9.1-10.el8_10.x86_64",
        "Installed: mesa-libGL-devel-23.1.4-4.el8_10.x86_64",
        "Installed: enchant2-2.2.3-3.el8.x86_64",
        "Installed: taglib-1.11.1-8.el8.x86_64",
        "Installed: fuse-2.9.7-19.el8.x86_64",
        "Installed: pulseaudio-14.0-4.el8.x86_64",
        "Installed: iio-sensor-proxy-2.4-3.el8.x86_64",
        "Installed: pulseaudio-libs-14.0-4.el8.x86_64",
        "Installed: rest-0.8.1-2.el8.x86_64",
        "Installed: pulseaudio-libs-glib2-14.0-4.el8.x86_64",
        "Installed: pulseaudio-module-bluetooth-14.0-4.el8.x86_64",
        "Installed: libappstream-glib-0.7.14-3.el8.x86_64",
        "Installed: grilo-0.3.6-3.el8.x86_64",
        "Installed: pinentry-gtk-1.1.0-2.el8.x86_64",
        "Installed: totem-pl-parser-3.26.1-2.el8.x86_64",
        "Installed: mesa-libgbm-23.1.4-4.el8_10.x86_64",
        "Installed: pipewire-0.3.6-1.el8.x86_64",
        "Installed: evolution-data-server-3.28.5-24.el8.x86_64",
        "Installed: libXfont2-devel-2.0.3-2.el8.x86_64",
        "Installed: evolution-data-server-langpacks-3.28.5-24.el8.noarch",
        "Installed: gsm-1.0.17-5.el8.x86_64",
        "Installed: evolution-data-server-ui-3.28.5-24.el8.x86_64",
        "Installed: mesa-libglapi-23.1.4-4.el8_10.x86_64",
        "Installed: pipewire-libs-0.3.6-1.el8.x86_64",
        "Installed: rocky-backgrounds-86.3-1.el8.noarch",
        "Installed: mesa-libxatracker-23.1.4-4.el8_10.x86_64",
        "Installed: pixman-devel-0.38.4-4.el8.x86_64",
        "Installed: gstreamer1-1.16.1-2.el8.x86_64",
        "Installed: libstemmer-0-10.585svn.el8.x86_64",
        "Installed: libvisual-1:0.4.0-25.el8.x86_64",
        "Installed: gstreamer1-plugins-bad-free-1.16.1-5.el8_10.x86_64",
        "Installed: Thunar-4.16.8-1.el8.x86_64",
        "Installed: libxfce4ui-4.16.0-2.el8.x86_64",
        "Installed: gstreamer1-plugins-base-1.16.1-5.el8_10.x86_64",
        "Installed: exo-4.16.2-1.el8.x86_64",
        "Installed: libxfce4util-4.16.0-4.el8.x86_64",
        "Installed: twolame-libs-0.3.13-12.el8.x86_64",
        "Installed: libvorbis-1:1.3.6-2.el8.x86_64",
        "Installed: gjs-1.56.2-6.el8.x86_64",
        "Installed: glib-networking-2.56.1-1.1.el8.x86_64",
        "Installed: gstreamer1-plugins-good-1.16.1-5.el8_10.x86_64",
        "Installed: libvpx-1.7.0-12.el8_10.x86_64",
        "Installed: libwacom-1.6-3.el8.x86_64",
        "Installed: libwacom-data-1.6-3.el8.noarch",
        "Installed: ModemManager-glib-1.20.2-1.el8.x86_64",
        "Installed: libwayland-client-1.21.0-1.el8.x86_64",
        "Installed: libwayland-cursor-1.21.0-1.el8.x86_64",
        "Installed: libwayland-egl-1.21.0-1.el8.x86_64",
        "Installed: libwayland-server-1.21.0-1.el8.x86_64",
        "Installed: plymouth-graphics-libs-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: glibmm24-2.56.0-2.el8.x86_64",
        "Installed: gtk3-3.22.30-12.el8_10.x86_64",
        "Installed: plymouth-plugin-label-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: glx-utils-8.4.0-5.20181118git1830dcb.el8.x86_64",
        "Installed: xorg-x11-server-devel-1.20.11-26.el8_10.x86_64",
        "Installed: plymouth-plugin-two-step-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: xorg-x11-util-macros-1.19.2-1.el8.noarch",
        "Installed: libX11-devel-1.6.8-9.el8_10.x86_64",
        "Installed: plymouth-system-theme-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: gnome-bluetooth-1:3.34.3-1.el8.x86_64",
        "Installed: gtkmm30-3.22.2-3.el8.x86_64",
        "Installed: gnome-bluetooth-libs-1:3.34.3-1.el8.x86_64",
        "Installed: gtksourceview3-3.24.9-1.el8.x86_64",
        "Installed: libX11-xcb-1.6.8-9.el8_10.x86_64",
        "Installed: libwnck3-3.24.1-2.el8.x86_64",
        "Installed: libXScrnSaver-1.2.3-1.el8.x86_64",
        "Installed: plymouth-theme-charge-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: plymouth-theme-spinner-0.9.4-11.20200615git1e36e30.el8.x86_64",
        "Installed: rtkit-0.11-19.el8.x86_64",
        "Installed: NetworkManager-wifi-1:1.40.16-19.el8_10.x86_64",
        "Installed: gnome-control-center-3.28.2-37.el8.x86_64",
        "Installed: gnome-control-center-filesystem-3.28.2-37.el8.noarch",
        "Installed: libXau-devel-1.0.9-3.el8.x86_64",
        "Installed: gnome-desktop3-3.32.2-3.el8.x86_64",
        "Installed: libnma-1.8.38-1.el8.x86_64",
        "Installed: libnotify-0.7.7-6.el8.x86_64",
        "Installed: libxcb-devel-1.13.1-1.el8.x86_64",
        "Installed: upower-0.99.7-4.el8_7.x86_64",
        "Installed: liboauth-1.0.3-9.el8.x86_64",
        "Installed: libxkbcommon-x11-0.9.1-1.el8.x86_64",
        "Installed: libxkbfile-1.1.0-1.el8.x86_64",
        "Installed: libogg-2:1.3.2-10.el8.x86_64",
        "Installed: libxklavier-5.4-11.el8.x86_64",
        "Installed: wpa_supplicant-1:2.10-2.el8.x86_64",
        "Installed: libXdmcp-1.1.3-1.el8.x86_64",
        "Installed: gnome-keyring-3.28.2-2.el8_10.x86_64",
        "Installed: gnome-keyring-pam-3.28.2-2.el8_10.x86_64",
        "Installed: python3-idna-2.5-7.el8_10.noarch",
        "Installed: gnome-menus-3.13.3-12.el8.x86_64",
        "Installed: GConf2-3.2.6-22.el8.x86_64",
        "Installed: gnome-online-accounts-3.28.2-7.el8.x86_64",
        "Installed: libXfont2-2.0.3-2.el8.x86_64",
        "Installed: libxshmfence-1.3-2.el8.x86_64",
        "Installed: mpg123-libs-1.32.9-1.el8_10.x86_64",
        "Installed: gnome-session-3.28.1-21.el8.x86_64",
        "Installed: python3-cairo-1.16.3-6.el8.x86_64",
        "Installed: gnome-session-wayland-session-3.28.1-21.el8.x86_64",
        "Installed: gnome-session-xsession-3.28.1-21.el8.x86_64",
        "Installed: gnome-settings-daemon-3.32.0-20.el8.x86_64",
        "Installed: libwbclient-4.19.4-9.el8_10.x86_64",
        "Installed: gnome-shell-3.32.2-57.el8_10.x86_64",
        "Installed: iso-codes-3.79-2.el8.noarch",
        "Installed: libpciaccess-devel-0.14-1.el8.x86_64",
        "Installed: mtdev-1.1.5-12.el8.x86_64",
        "Installed: cups-pk-helper-0.2.6-5.el8.x86_64",
        "Installed: openssh-askpass-8.0p1-25.el8_10.x86_64",
        "Installed: mutter-3.32.2-73.el8_10.x86_64",
        "Installed: python3-cups-1.9.72-21.el8.rocky.x86_64",
        "Installed: libXres-1.2.0-4.el8.x86_64",
        "Installed: libplist-2.0.0-10.el8.x86_64",
        "Installed: opus-1.3-0.4.beta.el8.x86_64",
        "Installed: avahi-glib-0.7-27.el8_10.1.x86_64",
        "Installed: vino-3.22.0-11.el8.x86_64",
        "Installed: harfbuzz-icu-1.7.5-4.el8.x86_64",
        "Installed: libXtst-1.2.3-7.el8.x86_64",
        "Installed: orc-0.4.28-4.el8_10.x86_64",
        "Installed: libXv-1.0.11-7.el8.x86_64",
        "Installed: abattis-cantarell-fonts-0.0.25-6.el8.noarch",
        "Installed: dbus-x11-1:1.12.8-26.el8.x86_64",
        "Installed: dconf-0.28.0-4.el8.x86_64",
        "Installed: libXxf86dga-1.1.5-1.el8.x86_64",
        "Installed: python3-gobject-3.28.3-2.el8.x86_64"
    ]
}

TASK [base_os : Include Debian-specific tasks] *********************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "ansible_facts.distribution == 'Debian'",
    "skip_reason": "Conditional result was False"
}

TASK [base_os : Ensure requests package is installed] **************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "/usr/local/ghpc-venv/bin/python3",
        "-m",
        "pip.__main__",
        "install",
        "requests"
    ],
    "name": [
        "requests"
    ],
    "requirements": null,
    "state": "present",
    "version": null,
    "virtualenv": null
}

STDOUT:

Requirement already satisfied: requests in /usr/local/ghpc-venv/lib64/python3.12/site-packages (2.32.4)
Requirement already satisfied: charset_normalizer<4,>=2 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (3.4.2)
Requirement already satisfied: idna<4,>=2.5 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (3.10)
Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (2.5.0)
Requirement already satisfied: certifi>=2017.4.17 in /usr/local/ghpc-venv/lib64/python3.12/site-packages (from requests) (2025.7.14)


TASK [base_os : Ensure Python & tooling are installed] *************************
ok: [localhost] => {
    "changed": false,
    "rc": 0,
    "results": []
}

MSG:

Nothing to do

TASK [base_os : Provision GPU setup] *******************************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "nvidia_gpu_present.rc == 0",
    "skip_reason": "Conditional result was False"
}

TASK [base_os : Set current role for lock manager completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "base_os",
        "role_completed": true
    },
    "changed": false
}

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: base_os

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370866.5072315,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "358a7f4095fbb49a0eedafd77e97040d1b9b5a26",
        "ctime": 1753370866.2832148,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 891734,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370866.137204,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 879,
        "uid": 0,
        "version": "3120075969",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Create initial lock file structure] ***********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file creation] *********************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and not lock_file_stat.stat.exists"
}

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:27:44Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.002192",
    "end": "2025-07-24 15:29:50.438490",
    "rc": 0,
    "start": "2025-07-24 15:29:50.436298"
}

STDOUT:

2025-07-24T15:29:50Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:27:44Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:27:44Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:29:50Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:29:50Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": false
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:29:50Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for base_os:
  - completed: True
  - completed_at: 2025-07-24T15:29:50Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating base_os:
  - current_lock_data: completed_roles:
    base_os:
        completed: false
    lock_manager:
        completed: true
        completed_at: '2025-07-24T15:27:44Z'
    secret_manager:
        completed: false
    user_provision:
        completed: false
    vdi_tool:
        completed: false
    vnc:
        completed: false
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:29:50Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users:
    - alice
    - bob
    previous_users: []
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:29:50Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated:
    - alice
    - bob

  - current_completed_roles: base_os:
    completed: false
lock_manager:
    completed: true
    completed_at: '2025-07-24T15:27:44Z'
secret_manager:
    completed: false
user_provision:
    completed: false
vdi_tool:
    completed: false
vnc:
    completed: false

  - role_completed: True
  - current_role: base_os


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": false
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": false
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": false
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating base_os:
  - current_role: base_os
  - role_completed: True
  - completed_roles: {'base_os': {'completed': True, 'completed_at': '2025-07-24T15:29:50Z'}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': False}, 'user_provision': {'completed': False}, 'vdi_tool': {'completed': False}, 'vnc': {'completed': False}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for base_os:
  - current_users_updated: ['alice', 'bob']
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:29:50Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:29:50Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for base_os:
  - current_users: ['alice', 'bob']
  - previous_users: ['alice', 'bob']
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": false
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: False
  - setup_status: configuring
  - completed_roles_count: 2
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "9dd77a3585697aef08aed09e819bb4819f75aeb3",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "31b80e47ec3641c2918f8ff0403d2956",
    "mode": "0644",
    "owner": "root",
    "size": 940,
    "src": "/root/.ansible/tmp/ansible-tmp-1753370991.526421-18369-193730364017589/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.003801",
    "end": "2025-07-24 15:29:52.075433",
    "rc": 0,
    "start": "2025-07-24 15:29:52.071632"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IGZhbHNlCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:04.336413",
    "end": "2025-07-24 15:29:56.603337",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:29:52.266924"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.039517",
    "end": "2025-07-24 15:29:56.877395",
    "rc": 0,
    "start": "2025-07-24 15:29:56.837878"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370874.1548011,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
        "ctime": 1753370872.6256874,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 285214140,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370872.4766762,
        "nlink": 1,
        "path": "/etc/systemd/system/vdi-monitor.service",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 283,
        "uid": 0,
        "version": "1338188335",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: base_os
  - vdi_monitor_service_exists: True
  - lock_file_creation.changed: False
  - will_setup_monitor: False


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not vdi_monitor_service_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Set current role for lock manager check] ****************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "secret_manager"
    },
    "changed": false
}

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370992.073591,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "9dd77a3585697aef08aed09e819bb4819f75aeb3",
        "ctime": 1753370991.845574,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 185115083,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370991.6915624,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 940,
        "uid": 0,
        "version": "3443573269",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Load existing lock file] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Debug lock file load result] ******************************
ok: [localhost] => {}

MSG:

Lock file loaded successfully: True

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: True
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": true
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for secret_manager:
  - not lock_file_exists: False
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for secret_manager:
  - current_role: secret_manager
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: True
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [secret_manager : Set role_should_run from lock check result] *************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [secret_manager : Skip secret_manager tasks if role should not run] *******
skipping: [localhost] => {
    "false_condition": "not role_should_run"
}

TASK [secret_manager : Generate random database password] **********************
ok: [localhost] => {
    "ansible_facts": {
        "database_password": "H95L0yeLji7pzjDCOuemJDzEwoASP7Nq"
    },
    "changed": false
}

TASK [secret_manager : Generate random webapp admin password] ******************
ok: [localhost] => {
    "ansible_facts": {
        "webapp_admin_password": "n7d53VAcYV4xT86sDI8mNKO7BHsIIfa0"
    },
    "changed": false
}

TASK [secret_manager : Compute Webapp admin password hash to save to Webapp server] ***
ok: [localhost] => {
    "ansible_facts": {
        "webapp_admin_hash": "E4440760F8847690907CADBB2B87C3E21015556DB4DAEA4A0D9C5D5F85DD6EA9"
    },
    "changed": false
}

TASK [secret_manager : Get access token for Secret Manager API] ****************
ok: [localhost] => {
    "changed": false,
    "connection": "Close",
    "content": "{\"access_token\":\"ya29.c.c0ASRK0Gb5OH5v-xtWlMorXSZswjZqBApOSzy3U4RHvOuuIn3lLmwmFBxGPcpUUw72yV0h0ow9Xuo-4544iIzBnhfADz7iDQ09v99UJ3y8RTi6yqwoXjOBcbI1Xqkj1gPMgVsUBGPfooSczQEcQPj27MBL6rLrDadQnacLMKVzogosGtpxH3Kf-a5lztK5AmcyYrgGxfyFqtPbF34J9J-88UghA5vbVdYScappzlkaxWbwoAmK2xW0Z40kE2uz91P2wwgcG1JUAcR6QgOc2_NarPeRkZ1_kOl8COE6l05gNix4hcH5j8PBTsaoUHre-vE-j6gAJRIe2uMUlVa7Mm3CkuJqrfxR3hNXUpsu6mdsTJEDvJz02U4uIMwYrupU58mzflgo1q0al4hW0UEVWwE411P2y-gSmWQY71t8ynep0kpl-alZF3zxk-mhFkfurxl06mj9I9pq7cYb9-Zu3B-S7qv5pmg6ISQQVk33QgXO15n913orUWhFf2qlVtOqMhzgsgF12iB6rwXtts4y1ceodU6JaqkWf3wsF0uQarJwbb7eYg5jBzVjcxwcuy2Y7bhOqfIa0X88nW7_WgqUXXe7FBIQYfJoJ0U1aZjS3Frwicnjr4gMBoW9OQuQcX-ygjUXBmWMXxWpmW5tOnB1xcQxey-jbeypuys1ou0JFIql8Q4iIJyQvWBuchJXaWsyfooRJfr_mXSpf6f2fm0dW1kV3abBx_jIisS7UnUq8hnZyieo515yZ1_ktq-1gicxlum3SltkiSbmYxnJ12vaM3W-t74bi1JRZV2jJess0vFssRrapFzBoQzfUUbuR21hh1ImdmQ6_YlhUh9IJcX-qkk_X24nXuQfdSUptj0WXx14cWs6cfQ_b5-qfnFyymtlcMuS3i7mg3z1vghaf2-24J5IUUYxxOaqJ7_J48pVzaXpJnypnymuU_lp-w88jk_I0zYtUiSuFq5SrsY9_aIQqtOY40pyZdmYO2zg5w4fBpzShjhfpXMI8BicoUz\",\"expires_in\":3599,\"token_type\":\"Bearer\"}",
    "content_length": "1083",
    "content_type": "application/json",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:29:58 GMT",
    "elapsed": 0,
    "json": {
        "access_token": "ya29.c.c0ASRK0Gb5OH5v-xtWlMorXSZswjZqBApOSzy3U4RHvOuuIn3lLmwmFBxGPcpUUw72yV0h0ow9Xuo-4544iIzBnhfADz7iDQ09v99UJ3y8RTi6yqwoXjOBcbI1Xqkj1gPMgVsUBGPfooSczQEcQPj27MBL6rLrDadQnacLMKVzogosGtpxH3Kf-a5lztK5AmcyYrgGxfyFqtPbF34J9J-88UghA5vbVdYScappzlkaxWbwoAmK2xW0Z40kE2uz91P2wwgcG1JUAcR6QgOc2_NarPeRkZ1_kOl8COE6l05gNix4hcH5j8PBTsaoUHre-vE-j6gAJRIe2uMUlVa7Mm3CkuJqrfxR3hNXUpsu6mdsTJEDvJz02U4uIMwYrupU58mzflgo1q0al4hW0UEVWwE411P2y-gSmWQY71t8ynep0kpl-alZF3zxk-mhFkfurxl06mj9I9pq7cYb9-Zu3B-S7qv5pmg6ISQQVk33QgXO15n913orUWhFf2qlVtOqMhzgsgF12iB6rwXtts4y1ceodU6JaqkWf3wsF0uQarJwbb7eYg5jBzVjcxwcuy2Y7bhOqfIa0X88nW7_WgqUXXe7FBIQYfJoJ0U1aZjS3Frwicnjr4gMBoW9OQuQcX-ygjUXBmWMXxWpmW5tOnB1xcQxey-jbeypuys1ou0JFIql8Q4iIJyQvWBuchJXaWsyfooRJfr_mXSpf6f2fm0dW1kV3abBx_jIisS7UnUq8hnZyieo515yZ1_ktq-1gicxlum3SltkiSbmYxnJ12vaM3W-t74bi1JRZV2jJess0vFssRrapFzBoQzfUUbuR21hh1ImdmQ6_YlhUh9IJcX-qkk_X24nXuQfdSUptj0WXx14cWs6cfQ_b5-qfnFyymtlcMuS3i7mg3z1vghaf2-24J5IUUYxxOaqJ7_J48pVzaXpJnypnymuU_lp-w88jk_I0zYtUiSuFq5SrsY9_aIQqtOY40pyZdmYO2zg5w4fBpzShjhfpXMI8BicoUz",
        "expires_in": 3599,
        "token_type": "Bearer"
    },
    "metadata_flavor": "Google",
    "redirected": false,
    "server": "Metadata Server for VM",
    "status": 200,
    "url": "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

OK (1083 bytes)

TASK [secret_manager : Create a GCP secret for webapp server login] ************
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "date": "Thu, 24 Jul 2025 15:29:58 GMT",
    "elapsed": 0,
    "json": {
        "error": {
            "code": 409,
            "message": "Secret [projects/748006908949/secrets/webapp-server-password-vdi-test-scott] already exists.",
            "status": "ALREADY_EXISTS"
        }
    },
    "redirected": false,
    "server": "ESF",
    "status": 409,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets?secretId=webapp-server-password-vdi-test-scott",
    "vary": "Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

HTTP Error 409: Conflict

TASK [secret_manager : Add webapp password version to secret] ******************
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:29:59 GMT",
    "elapsed": 0,
    "json": {
        "createTime": "2025-07-24T15:29:59.522597Z",
        "etag": "\"163aae7f960525\"",
        "name": "projects/748006908949/secrets/webapp-server-password-vdi-test-scott/versions/82",
        "replicationStatus": {
            "automatic": {}
        },
        "state": "ENABLED"
    },
    "redirected": false,
    "server": "ESF",
    "status": 200,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets/webapp-server-password-vdi-test-scott:addVersion",
    "vary": "X-Origin, Referer, Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

OK (unknown bytes)

TASK [secret_manager : Create a GCP secret for database password] **************
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "date": "Thu, 24 Jul 2025 15:29:59 GMT",
    "elapsed": 0,
    "json": {
        "error": {
            "code": 409,
            "message": "Secret [projects/748006908949/secrets/db-password-vdi-test-scott] already exists.",
            "status": "ALREADY_EXISTS"
        }
    },
    "redirected": false,
    "server": "ESF",
    "status": 409,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets?secretId=db-password-vdi-test-scott",
    "vary": "Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

HTTP Error 409: Conflict

TASK [secret_manager : Add database password version to secret] ****************
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:30:00 GMT",
    "elapsed": 0,
    "json": {
        "createTime": "2025-07-24T15:30:00.398932Z",
        "etag": "\"163aae7fa36454\"",
        "name": "projects/748006908949/secrets/db-password-vdi-test-scott/versions/82",
        "replicationStatus": {
            "automatic": {}
        },
        "state": "ENABLED"
    },
    "redirected": false,
    "server": "ESF",
    "status": 200,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets/db-password-vdi-test-scott:addVersion",
    "vary": "X-Origin, Referer, Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

OK (unknown bytes)

TASK [secret_manager : Generate per-user secrets and enrich list] **************
included: /tmp/vdi/roles/secret_manager/tasks/user_secret_tasks.yaml for localhost => (item={'username': 'alice', 'port': 5901})
included: /tmp/vdi/roles/secret_manager/tasks/user_secret_tasks.yaml for localhost => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob'})

TASK [secret_manager : Compute default secret_name if none provided] ***********
ok: [localhost] => {
    "ansible_facts": {
        "secret_name": "vdi-user-password-alice-vdi-test-scott"
    },
    "changed": false
}

TASK [secret_manager : Determine password source for user alice] ***************
ok: [localhost] => {
    "ansible_facts": {
        "password_source": "generate"
    },
    "changed": false
}

TASK [secret_manager : Clean password source value] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "password_source": "generate"
    },
    "changed": false
}

TASK [secret_manager : Debug password source for alice] ************************
ok: [localhost] => {}

MSG:

Password source for alice:
  - password_source: "generate"
  - secret_name: not set
  - password: not set


TASK [secret_manager : Fetch existing Secret Manager password for user alice] ***
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"secret\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Debug Secret Manager fetch result for alice] ************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and password_source == \"secret\""
}

TASK [secret_manager : Set VDI user password from Secret Manager] **************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"secret\" and sm_result.status == 200",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Check if password has actually changed for alice] *******
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"secret\" and sm_result.status == 200",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Debug password change detection for alice] **************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and password_source == \"secret\""
}

TASK [secret_manager : Generate random password for user alice] ****************
ok: [localhost] => {
    "ansible_facts": {
        "vdiuser_password": "xc61q4jU3mUCo84M"
    },
    "changed": false
}

TASK [secret_manager : Set user password from provided value] ******************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Create secret for user alice (provided password)] *******
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Store provided password in Secret Manager for user alice] ***
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Create secret for user alice] ***************************
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "date": "Thu, 24 Jul 2025 15:30:01 GMT",
    "elapsed": 0,
    "json": {
        "error": {
            "code": 409,
            "message": "Secret [projects/748006908949/secrets/vdi-user-password-alice-vdi-test-scott] already exists.",
            "status": "ALREADY_EXISTS"
        }
    },
    "redirected": false,
    "server": "ESF",
    "status": 409,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets?secretId=vdi-user-password-alice-vdi-test-scott",
    "vary": "Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

HTTP Error 409: Conflict

TASK [secret_manager : Store generated password in Secret Manager for user alice] ***
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content_type": "application/json; charset=UTF-8",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:30:01 GMT",
    "elapsed": 0,
    "json": {
        "createTime": "2025-07-24T15:30:01.698173Z",
        "etag": "\"163aae7fb7377d\"",
        "name": "projects/748006908949/secrets/vdi-user-password-alice-vdi-test-scott/versions/63",
        "replicationStatus": {
            "automatic": {}
        },
        "state": "ENABLED"
    },
    "redirected": false,
    "server": "ESF",
    "status": 200,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets/vdi-user-password-alice-vdi-test-scott:addVersion",
    "vary": "X-Origin, Referer, Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

OK (unknown bytes)

TASK [secret_manager : Set VNC configuration for user] *************************
ok: [localhost] => {
    "ansible_facts": {
        "vnc_config": {
            "display_number": 1,
            "vncserver_password": "4JB1YHUQ"
        }
    },
    "changed": false
}

TASK [secret_manager : Build enriched user list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_users_updated": [
            {
                "display_number": 1,
                "password": "xc61q4jU3mUCo84M",
                "port": 5901,
                "username": "alice",
                "vncserver_password": "4JB1YHUQ"
            }
        ]
    },
    "changed": false
}

TASK [secret_manager : Compute default secret_name if none provided] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "item.secret_name is not defined",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Determine password source for user bob] *****************
ok: [localhost] => {
    "ansible_facts": {
        "password_source": "secret"
    },
    "changed": false
}

TASK [secret_manager : Clean password source value] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "password_source": "secret"
    },
    "changed": false
}

TASK [secret_manager : Debug password source for bob] **************************
ok: [localhost] => {}

MSG:

Password source for bob:
  - password_source: "secret"
  - secret_name: a-password-for-bob
  - password: not set


TASK [secret_manager : Fetch existing Secret Manager password for user bob] ****
ok: [localhost] => {
    "accept_ranges": "none",
    "changed": false,
    "connection": "close",
    "content": "{\n  \"name\": \"projects/748006908949/secrets/a-password-for-bob/versions/4\",\n  \"payload\": {\n    \"data\": \"QjBicDRzc3cwcmQxMjM=\",\n    \"dataCrc32c\": \"3219829350\"\n  }\n}\n",
    "content_type": "application/json; charset=UTF-8",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:30:02 GMT",
    "elapsed": 0,
    "failed_when_result": false,
    "json": {
        "name": "projects/748006908949/secrets/a-password-for-bob/versions/4",
        "payload": {
            "data": "QjBicDRzc3cwcmQxMjM=",
            "dataCrc32c": "3219829350"
        }
    },
    "redirected": false,
    "server": "ESF",
    "status": 200,
    "transfer_encoding": "chunked",
    "url": "https://secretmanager.googleapis.com/v1/projects/hpc-discovery-external/secrets/a-password-for-bob/versions/latest:access",
    "vary": "X-Origin, Referer, Origin,Accept-Encoding",
    "x_content_type_options": "nosniff",
    "x_frame_options": "SAMEORIGIN",
    "x_xss_protection": "0"
}

MSG:

OK (unknown bytes)

TASK [secret_manager : Debug Secret Manager fetch result for bob] **************
ok: [localhost] => {}

MSG:

Secret Manager fetch for bob:
  - status: 200
  - success: True
  - user_config_changed: True
  - password_source: secret


TASK [secret_manager : Set VDI user password from Secret Manager] **************
ok: [localhost] => {
    "ansible_facts": {
        "vdiuser_password": "B0bp4ssw0rd123"
    },
    "changed": false
}

TASK [secret_manager : Check if password has actually changed for bob] *********
ok: [localhost] => {
    "ansible_facts": {
        "password_actually_changed": true
    },
    "changed": false
}

TASK [secret_manager : Debug password change detection for bob] ****************
ok: [localhost] => {}

MSG:

Password change detection for bob:
  - user_config_changed: True
  - password_source: secret
  - sm_result_status: 200
  - password_actually_changed: True


TASK [secret_manager : Generate random password for user bob] ******************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"generate\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Set user password from provided value] ******************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Create secret for user bob (provided password)] *********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Store provided password in Secret Manager for user bob] ***
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"password\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Create secret for user bob] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"generate\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Store generated password in Secret Manager for user bob] ***
skipping: [localhost] => {
    "changed": false,
    "false_condition": "password_source == \"generate\"",
    "skip_reason": "Conditional result was False"
}

TASK [secret_manager : Set VNC configuration for user] *************************
ok: [localhost] => {
    "ansible_facts": {
        "vnc_config": {
            "display_number": 2,
            "vncserver_password": "7DmxvFp2"
        }
    },
    "changed": false
}

TASK [secret_manager : Build enriched user list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_users_updated": [
            {
                "display_number": 1,
                "password": "xc61q4jU3mUCo84M",
                "port": 5901,
                "username": "alice",
                "vncserver_password": "4JB1YHUQ"
            },
            {
                "display_number": 2,
                "password": "B0bp4ssw0rd123",
                "port": 5902,
                "secret_name": "a-password-for-bob",
                "username": "bob",
                "vncserver_password": "7DmxvFp2"
            }
        ]
    },
    "changed": false
}

TASK [secret_manager : Set enriched vdi_users_updated variable] ****************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_users_updated": [
            {
                "display_number": 1,
                "password": "xc61q4jU3mUCo84M",
                "port": 5901,
                "username": "alice",
                "vncserver_password": "4JB1YHUQ"
            },
            {
                "display_number": 2,
                "password": "B0bp4ssw0rd123",
                "port": 5902,
                "secret_name": "a-password-for-bob",
                "username": "bob",
                "vncserver_password": "7DmxvFp2"
            }
        ]
    },
    "changed": false
}

TASK [secret_manager : Set current role for lock manager completion] ***********
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "secret_manager",
        "role_completed": true
    },
    "changed": false
}

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: secret_manager

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370992.073591,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "9dd77a3585697aef08aed09e819bb4819f75aeb3",
        "ctime": 1753370991.845574,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 185115083,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370991.6915624,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 940,
        "uid": 0,
        "version": "3443573269",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Create initial lock file structure] ***********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file creation] *********************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and not lock_file_stat.stat.exists"
}

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:29:50Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.002549",
    "end": "2025-07-24 15:30:03.439894",
    "rc": 0,
    "start": "2025-07-24 15:30:03.437345"
}

STDOUT:

2025-07-24T15:30:03Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:29:50Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:29:50Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:30:03Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:03Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": false
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:30:03Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for secret_manager:
  - completed: True
  - completed_at: 2025-07-24T15:30:03Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating secret_manager:
  - current_lock_data: completed_roles:
    base_os:
        completed: true
        completed_at: '2025-07-24T15:29:50Z'
    lock_manager:
        completed: true
        completed_at: '2025-07-24T15:27:44Z'
    secret_manager:
        completed: false
    user_provision:
        completed: false
    vdi_tool:
        completed: false
    vnc:
        completed: false
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:30:03Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users:
    - alice
    - bob
    previous_users:
    - alice
    - bob
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:30:03Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated:
    - alice
    - bob

  - current_completed_roles: base_os:
    completed: true
    completed_at: '2025-07-24T15:29:50Z'
lock_manager:
    completed: true
    completed_at: '2025-07-24T15:27:44Z'
secret_manager:
    completed: false
user_provision:
    completed: false
vdi_tool:
    completed: false
vnc:
    completed: false

  - role_completed: True
  - current_role: secret_manager


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": false
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating secret_manager:
  - current_role: secret_manager
  - role_completed: True
  - completed_roles: {'base_os': {'completed': True, 'completed_at': '2025-07-24T15:29:50Z'}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': True, 'completed_at': '2025-07-24T15:30:03Z'}, 'user_provision': {'completed': False}, 'vdi_tool': {'completed': False}, 'vnc': {'completed': False}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for secret_manager:
  - current_users_updated: ['alice', 'bob']
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:30:03Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:30:03Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for secret_manager:
  - current_users: ['alice', 'bob']
  - previous_users: ['alice', 'bob']
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": false
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: False
  - setup_status: configuring
  - completed_roles_count: 3
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "9205f17d8ce64bf55a046c433f6f24c4efa12eae",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "8a1ac8aa138bd51d4b3fd6f087ff52cb",
    "mode": "0644",
    "owner": "root",
    "size": 982,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371004.5096657-25387-190441536237874/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.003695",
    "end": "2025-07-24 15:30:05.054073",
    "rc": 0,
    "start": "2025-07-24 15:30:05.050378"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiBmYWxzZQogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:04.452715",
    "end": "2025-07-24 15:30:09.703135",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:30:05.250420"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.039944",
    "end": "2025-07-24 15:30:09.991625",
    "rc": 0,
    "start": "2025-07-24 15:30:09.951681"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370874.1548011,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
        "ctime": 1753370872.6256874,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 285214140,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370872.4766762,
        "nlink": 1,
        "path": "/etc/systemd/system/vdi-monitor.service",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 283,
        "uid": 0,
        "version": "1338188335",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: secret_manager
  - vdi_monitor_service_exists: True
  - lock_file_creation.changed: False
  - will_setup_monitor: False


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not vdi_monitor_service_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

TASK [user_provision : Set current role for lock manager check] ****************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "user_provision"
    },
    "changed": false
}

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371005.05256,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "9205f17d8ce64bf55a046c433f6f24c4efa12eae",
        "ctime": 1753371004.8265433,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 51539232,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371004.6825325,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 982,
        "uid": 0,
        "version": "2720298527",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Load existing lock file] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Debug lock file load result] ******************************
ok: [localhost] => {}

MSG:

Lock file loaded successfully: True

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: True
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": true
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for user_provision:
  - not lock_file_exists: False
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for user_provision:
  - current_role: user_provision
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: True
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [user_provision : Set role_should_run from lock check result] *************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [user_provision : Skip user_provision tasks if role should not run] *******
skipping: [localhost] => {
    "false_condition": "not role_should_run"
}

TASK [user_provision : Ensure 'wheel' group is present] ************************
ok: [localhost] => {
    "changed": false,
    "gid": 10,
    "name": "wheel",
    "state": "present",
    "system": false
}

TASK [user_provision : Ensure VDI user group exists] ***************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "name": "vdiusers",
    "state": "present",
    "system": false
}

TASK [user_provision : Provision local users] **********************************
included: /tmp/vdi/roles/user_provision/tasks/local_users.yaml for localhost => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1})
included: /tmp/vdi/roles/user_provision/tasks/local_users.yaml for localhost => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2})

TASK [user_provision : Check if user exists] ***********************************
fatal: [localhost]: FAILED! => {
    "changed": false
}

MSG:

One or more supplied key could not be found in the database.
...ignoring

TASK [user_provision : Set user exists status for debug] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "user_exists_status": false
    },
    "changed": false
}

TASK [user_provision : Set user exists status for debug (success case)] ********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "debug | default(false) and user_exists_check is not failed",
    "skip_reason": "Conditional result was False"
}

TASK [user_provision : Debug user provision for alice] *************************
ok: [localhost] => {}

MSG:

Provisioning user alice:
  - user_secrets_changed: True
  - password_actually_changed: True
  - password_update_mode: always
  - user_exists: False


TASK [user_provision : Create VDI user alice] **********************************
[DEPRECATION WARNING]: Encryption using the Python crypt module is deprecated.
The Python crypt module is deprecated and will be removed from Python 3.13.
Install the passlib library for continued encryption functionality. This
feature will be removed in version 2.17. Deprecation warnings can be disabled
by setting deprecation_warnings=False in ansible.cfg.
changed: [localhost] => {
    "changed": true,
    "comment": "",
    "create_home": true,
    "group": 1002,
    "groups": "vdiusers,wheel",
    "home": "/home/alice",
    "name": "alice",
    "password": "NOT_LOGGING_PASSWORD",
    "shell": "/bin/bash",
    "state": "present",
    "system": false,
    "uid": 1000
}

TASK [user_provision : Ensure .ssh directory for alice] ************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0700",
    "owner": "alice",
    "path": "/home/alice/.ssh",
    "size": 6,
    "state": "directory",
    "uid": 1000
}

TASK [user_provision : Generate SSH key pair for alice] ************************
changed: [localhost] => {
    "changed": true,
    "comment": "",
    "filename": "/home/alice/.ssh/id_rsa",
    "fingerprint": "SHA256:4q3JaXL5hMpzved5z0zkLeFXpxKwhFioOkCgEo9i81A",
    "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCxte3GQvt8uFeofNaIUfEMGldCrg9DN8/rUTHzq/dicUI3WuaQKWMC+22TAd7xMernwPlsCUfl3+o5RI1g8vwOGyXmF8dlXKbcokBL2976Ek+7jsibyqzcGiBRKPpN2Rc37L6VMaXupQ+kor/d0zSJXfLVewaWoQcOCktTVFwek7mpVHDbwBAFHN9ruR4M7ItDaJg6fOpD3/cgaegz+L0IIATbXXYGxYTQXnRMEvydcsDFWY8bXKON+YBtZhglc8Y7DJadM2J3S7ZxGwCU2dA4dTRYDTHIeLno0CbWul++qnyRW3OHj0DtdYqtrwi/CnstwYmJ5E9vPctdcGJokw1CYKomgrlpernuRytxrlt2SA6UHyX9VfSiBSuRDkMsyLF3Y/m/nYiDwDjp68XStRt6TmkZNb6zzJnKcRjKmaNiRi5Q1fBULcW4+UWC17SoMX4a74+6WMAtWwDVZvC+UwiCHEJRCKmAMFEE1EDMSsBLX223qXEBIDaXGoyErbezNr3ZUUPR5ZABIfhQW/LwGMW1+WE+k/pFoKeMicHc0EpdNfcZoHEqHKPoKsZl0U8FWJVjLWQO8jVQlUHLhapzA/6vU/JHnpRZ1PrUH6v0PNPjgDhoaaOo7HfdlVKJFNuPV1jC5re1lmBHnZLzyLr8dojaAjElnTr8RRKRHE2X8KTg4w==",
    "size": 4096,
    "type": "rsa"
}

TASK [user_provision : Add public key to authorized_keys for alice] ************
changed: [localhost] => {
    "changed": true,
    "comment": null,
    "exclusive": false,
    "follow": false,
    "key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCxte3GQvt8uFeofNaIUfEMGldCrg9DN8/rUTHzq/dicUI3WuaQKWMC+22TAd7xMernwPlsCUfl3+o5RI1g8vwOGyXmF8dlXKbcokBL2976Ek+7jsibyqzcGiBRKPpN2Rc37L6VMaXupQ+kor/d0zSJXfLVewaWoQcOCktTVFwek7mpVHDbwBAFHN9ruR4M7ItDaJg6fOpD3/cgaegz+L0IIATbXXYGxYTQXnRMEvydcsDFWY8bXKON+YBtZhglc8Y7DJadM2J3S7ZxGwCU2dA4dTRYDTHIeLno0CbWul++qnyRW3OHj0DtdYqtrwi/CnstwYmJ5E9vPctdcGJokw1CYKomgrlpernuRytxrlt2SA6UHyX9VfSiBSuRDkMsyLF3Y/m/nYiDwDjp68XStRt6TmkZNb6zzJnKcRjKmaNiRi5Q1fBULcW4+UWC17SoMX4a74+6WMAtWwDVZvC+UwiCHEJRCKmAMFEE1EDMSsBLX223qXEBIDaXGoyErbezNr3ZUUPR5ZABIfhQW/LwGMW1+WE+k/pFoKeMicHc0EpdNfcZoHEqHKPoKsZl0U8FWJVjLWQO8jVQlUHLhapzA/6vU/JHnpRZ1PrUH6v0PNPjgDhoaaOo7HfdlVKJFNuPV1jC5re1lmBHnZLzyLr8dojaAjElnTr8RRKRHE2X8KTg4w==",
    "key_options": null,
    "keyfile": "/home/alice/.ssh/authorized_keys",
    "manage_dir": true,
    "path": null,
    "state": "present",
    "user": "alice",
    "validate_certs": true
}

TASK [user_provision : Get users to remove from lock file] *********************
ok: [localhost] => {
    "ansible_facts": {
        "users_to_remove": []
    },
    "changed": false
}

TASK [user_provision : Debug local user cleanup] *******************************
ok: [localhost] => {}

MSG:

Local user cleanup:
  - users_to_remove: []


TASK [user_provision : Remove local user accounts] *****************************
skipping: [localhost] => {
    "changed": false,
    "skipped_reason": "No items in the list"
}

TASK [user_provision : Check if user exists] ***********************************
fatal: [localhost]: FAILED! => {
    "changed": false
}

MSG:

One or more supplied key could not be found in the database.
...ignoring

TASK [user_provision : Set user exists status for debug] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "user_exists_status": false
    },
    "changed": false
}

TASK [user_provision : Set user exists status for debug (success case)] ********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "debug | default(false) and user_exists_check is not failed",
    "skip_reason": "Conditional result was False"
}

TASK [user_provision : Debug user provision for bob] ***************************
ok: [localhost] => {}

MSG:

Provisioning user bob:
  - user_secrets_changed: True
  - password_actually_changed: True
  - password_update_mode: always
  - user_exists: False


TASK [user_provision : Create VDI user bob] ************************************
[DEPRECATION WARNING]: Encryption using the Python crypt module is deprecated.
The Python crypt module is deprecated and will be removed from Python 3.13.
Install the passlib library for continued encryption functionality. This
feature will be removed in version 2.17. Deprecation warnings can be disabled
by setting deprecation_warnings=False in ansible.cfg.
changed: [localhost] => {
    "changed": true,
    "comment": "",
    "create_home": true,
    "group": 1003,
    "groups": "vdiusers,wheel",
    "home": "/home/bob",
    "name": "bob",
    "password": "NOT_LOGGING_PASSWORD",
    "shell": "/bin/bash",
    "state": "present",
    "system": false,
    "uid": 1001
}

TASK [user_provision : Ensure .ssh directory for bob] **************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0700",
    "owner": "bob",
    "path": "/home/bob/.ssh",
    "size": 6,
    "state": "directory",
    "uid": 1001
}

TASK [user_provision : Generate SSH key pair for bob] **************************
changed: [localhost] => {
    "changed": true,
    "comment": "",
    "filename": "/home/bob/.ssh/id_rsa",
    "fingerprint": "SHA256:lKDSzJMXof3DNSJMGYZaAIQO6AFMq0pI5o2to6VG4ic",
    "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCzDZtYeeQAFPzpE14NfR0OHKtADWTNEfulc02pYEGcm+fBptIrFd4IH4J8CF26rUGcdryQ+blRc4UtyUyrIZurK9Q+I8kIM0ggxnLmCM6rs2ycKAayJQihQI8wIa8mQr2OYea4g44fdZr79tZSpGkCmeT9zE432nPDtBxfXw9/zOm+d086lejm/CWxRFidGGiiodWLJR3Sg0VqChij9+TKfplAZCtfuNcKJGywEVkpvNBZ3webAmqDKwgN1Q5cM6H4DntC2FT9jBx6IqCOmXQzQSVjO5BGU1djBLWL/ANJQ9pTfiPxLee4Jl1rT89UhnnN4dJMCrKkEVz4Sf82MUU+S2mnfnlk6U3NSXPfsruy0puttwN0FPjWeq5f5vNCCwuI9PBbmbS4++QyqSgE5JN+C46SlOnxyMQxM0bp5VTmB8AyjXiN5JrTUHlf+H0JIAqspHMEAVaD8jiM0CZ4Oh7Z/t71ZGIMWvY/93IKk5uVEizpazBS42TgmbprjGMTbTLKi3w8oAAQulNR3pnfyt4XekFbmVXlKK12A1nmQgaGx2naUm1bmtUT4yiRb1VDHKHS8+SGjLkKzgud/tkodFMUUhbCNlTgRjhJ78VIkYCIDyymNANbd2cB4wk9tpw845mau47Lvw6tUl33Anh97HUCl5CUI/lcLgOAXpasdD1JnQ==",
    "size": 4096,
    "type": "rsa"
}

TASK [user_provision : Add public key to authorized_keys for bob] **************
changed: [localhost] => {
    "changed": true,
    "comment": null,
    "exclusive": false,
    "follow": false,
    "key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCzDZtYeeQAFPzpE14NfR0OHKtADWTNEfulc02pYEGcm+fBptIrFd4IH4J8CF26rUGcdryQ+blRc4UtyUyrIZurK9Q+I8kIM0ggxnLmCM6rs2ycKAayJQihQI8wIa8mQr2OYea4g44fdZr79tZSpGkCmeT9zE432nPDtBxfXw9/zOm+d086lejm/CWxRFidGGiiodWLJR3Sg0VqChij9+TKfplAZCtfuNcKJGywEVkpvNBZ3webAmqDKwgN1Q5cM6H4DntC2FT9jBx6IqCOmXQzQSVjO5BGU1djBLWL/ANJQ9pTfiPxLee4Jl1rT89UhnnN4dJMCrKkEVz4Sf82MUU+S2mnfnlk6U3NSXPfsruy0puttwN0FPjWeq5f5vNCCwuI9PBbmbS4++QyqSgE5JN+C46SlOnxyMQxM0bp5VTmB8AyjXiN5JrTUHlf+H0JIAqspHMEAVaD8jiM0CZ4Oh7Z/t71ZGIMWvY/93IKk5uVEizpazBS42TgmbprjGMTbTLKi3w8oAAQulNR3pnfyt4XekFbmVXlKK12A1nmQgaGx2naUm1bmtUT4yiRb1VDHKHS8+SGjLkKzgud/tkodFMUUhbCNlTgRjhJ78VIkYCIDyymNANbd2cB4wk9tpw845mau47Lvw6tUl33Anh97HUCl5CUI/lcLgOAXpasdD1JnQ==",
    "key_options": null,
    "keyfile": "/home/bob/.ssh/authorized_keys",
    "manage_dir": true,
    "path": null,
    "state": "present",
    "user": "bob",
    "validate_certs": true
}

TASK [user_provision : Get users to remove from lock file] *********************
ok: [localhost] => {
    "ansible_facts": {
        "users_to_remove": []
    },
    "changed": false
}

TASK [user_provision : Debug local user cleanup] *******************************
ok: [localhost] => {}

MSG:

Local user cleanup:
  - users_to_remove: []


TASK [user_provision : Remove local user accounts] *****************************
skipping: [localhost] => {
    "changed": false,
    "skipped_reason": "No items in the list"
}

TASK [user_provision : Provision OS Login users] *******************************
skipping: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "user_provision | lower == 'os_login'",
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "user_provision | lower == 'os_login'",
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => {
    "changed": false
}

MSG:

All items skipped

TASK [user_provision : Set current role for lock manager completion] ***********
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "user_provision",
        "role_completed": true
    },
    "changed": false
}

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: user_provision

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371005.05256,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "9205f17d8ce64bf55a046c433f6f24c4efa12eae",
        "ctime": 1753371004.8265433,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 51539232,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371004.6825325,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 982,
        "uid": 0,
        "version": "2720298527",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Create initial lock file structure] ***********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file creation] *********************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and not lock_file_stat.stat.exists"
}

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:03Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.002381",
    "end": "2025-07-24 15:30:16.755905",
    "rc": 0,
    "start": "2025-07-24 15:30:16.753524"
}

STDOUT:

2025-07-24T15:30:16Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:03Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:03Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:30:16Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:16Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": false
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:30:16Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for user_provision:
  - completed: True
  - completed_at: 2025-07-24T15:30:16Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating user_provision:
  - current_lock_data: completed_roles:
    base_os:
        completed: true
        completed_at: '2025-07-24T15:29:50Z'
    lock_manager:
        completed: true
        completed_at: '2025-07-24T15:27:44Z'
    secret_manager:
        completed: true
        completed_at: '2025-07-24T15:30:03Z'
    user_provision:
        completed: false
    vdi_tool:
        completed: false
    vnc:
        completed: false
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:30:16Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users:
    - alice
    - bob
    previous_users:
    - alice
    - bob
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:30:16Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated:
    - alice
    - bob

  - current_completed_roles: base_os:
    completed: true
    completed_at: '2025-07-24T15:29:50Z'
lock_manager:
    completed: true
    completed_at: '2025-07-24T15:27:44Z'
secret_manager:
    completed: true
    completed_at: '2025-07-24T15:30:03Z'
user_provision:
    completed: false
vdi_tool:
    completed: false
vnc:
    completed: false

  - role_completed: True
  - current_role: user_provision


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": false
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:16Z"
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating user_provision:
  - current_role: user_provision
  - role_completed: True
  - completed_roles: {'base_os': {'completed': True, 'completed_at': '2025-07-24T15:29:50Z'}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': True, 'completed_at': '2025-07-24T15:30:03Z'}, 'user_provision': {'completed': True, 'completed_at': '2025-07-24T15:30:16Z'}, 'vdi_tool': {'completed': False}, 'vnc': {'completed': False}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for user_provision:
  - current_users_updated: ['alice', 'bob']
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:30:16Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:30:16Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for user_provision:
  - current_users: ['alice', 'bob']
  - previous_users: ['alice', 'bob']
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": false
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: False
  - setup_status: configuring
  - completed_roles_count: 4
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "ca35350cf060981f0667398fcb15c8e12423a97e",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "7ed7d0c10ced955765662b1feee9212a",
    "mode": "0644",
    "owner": "root",
    "size": 1024,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371017.8474565-25936-21002111182327/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.003777",
    "end": "2025-07-24 15:30:18.389398",
    "rc": 0,
    "start": "2025-07-24 15:30:18.385621"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDoxNlonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDoxNlonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiBmYWxzZQogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDoxNlonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDoxNlonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:04.229183",
    "end": "2025-07-24 15:30:22.808719",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:30:18.579536"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.040331",
    "end": "2025-07-24 15:30:23.092904",
    "rc": 0,
    "start": "2025-07-24 15:30:23.052573"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370874.1548011,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
        "ctime": 1753370872.6256874,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 285214140,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370872.4766762,
        "nlink": 1,
        "path": "/etc/systemd/system/vdi-monitor.service",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 283,
        "uid": 0,
        "version": "1338188335",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: user_provision
  - vdi_monitor_service_exists: True
  - lock_file_creation.changed: False
  - will_setup_monitor: False


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not vdi_monitor_service_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

TASK [vnc : Set current role for lock manager check] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "vnc"
    },
    "changed": false
}

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371018.3885562,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "ca35350cf060981f0667398fcb15c8e12423a97e",
        "ctime": 1753371018.1625395,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 117754419,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371018.0155284,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 1024,
        "uid": 0,
        "version": "3086664638",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Load existing lock file] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Debug lock file load result] ******************************
ok: [localhost] => {}

MSG:

Lock file loaded successfully: True

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: True
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": true
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for vnc:
  - not lock_file_exists: False
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for vnc:
  - current_role: vnc
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: True
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [vnc : Set role_should_run from lock check result] ************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [vnc : Skip vnc tasks if role should not run] *****************************
skipping: [localhost] => {
    "false_condition": "not role_should_run"
}

TASK [vnc : Install TigerVNC] **************************************************
included: /tmp/vdi/roles/vnc/tasks/tigervnc.yaml for localhost

TASK [vnc : Configure per-user VNC settings] ***********************************
included: /tmp/vdi/roles/vnc/tasks/vnc_user_config.yaml for localhost => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1})
included: /tmp/vdi/roles/vnc/tasks/vnc_user_config.yaml for localhost => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2})

TASK [vnc : Ensure VNC configuration directory exists] *************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0700",
    "owner": "alice",
    "path": "/home/alice/.vnc",
    "size": 6,
    "state": "directory",
    "uid": 1000
}

TASK [vnc : Write VNC xstartup for alice (Ubuntu/Debian)] **********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "skip_reason": "Conditional result was False"
}

TASK [vnc : Write VNC password file for alice] *********************************
changed: [localhost] => {
    "changed": true,
    "cmd": "echo \"4JB1YHUQ\" | vncpasswd -f > \"/home/alice/.vnc/passwd\"\n",
    "delta": "0:00:00.009600",
    "end": "2025-07-24 15:30:24.957369",
    "rc": 0,
    "start": "2025-07-24 15:30:24.947769"
}

TASK [vnc : Fix passwd file permissions] ***************************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0600",
    "owner": "alice",
    "path": "/home/alice/.vnc/passwd",
    "size": 8,
    "state": "file",
    "uid": 1000
}

TASK [vnc : Copy per-user VNC config] ******************************************
changed: [localhost] => {
    "changed": true,
    "checksum": "e5a3133663f35d3a79dc06917090845ab424c412",
    "dest": "/home/alice/.vnc/config",
    "gid": 1001,
    "group": "vdiusers",
    "md5sum": "15686602524e414a443391251ac46b4a",
    "mode": "0644",
    "owner": "alice",
    "size": 32,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371025.2160182-26228-110817536086157/source",
    "state": "file",
    "uid": 1000
}

TASK [vnc : Ensure VNC configuration directory exists] *************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0700",
    "owner": "bob",
    "path": "/home/bob/.vnc",
    "size": 6,
    "state": "directory",
    "uid": 1001
}

TASK [vnc : Write VNC xstartup for bob (Ubuntu/Debian)] ************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "skip_reason": "Conditional result was False"
}

TASK [vnc : Write VNC password file for bob] ***********************************
changed: [localhost] => {
    "changed": true,
    "cmd": "echo \"7DmxvFp2\" | vncpasswd -f > \"/home/bob/.vnc/passwd\"\n",
    "delta": "0:00:00.007207",
    "end": "2025-07-24 15:30:26.051034",
    "rc": 0,
    "start": "2025-07-24 15:30:26.043827"
}

TASK [vnc : Fix passwd file permissions] ***************************************
changed: [localhost] => {
    "changed": true,
    "gid": 1001,
    "group": "vdiusers",
    "mode": "0600",
    "owner": "bob",
    "path": "/home/bob/.vnc/passwd",
    "size": 8,
    "state": "file",
    "uid": 1001
}

TASK [vnc : Copy per-user VNC config] ******************************************
changed: [localhost] => {
    "changed": true,
    "checksum": "e5a3133663f35d3a79dc06917090845ab424c412",
    "dest": "/home/bob/.vnc/config",
    "gid": 1001,
    "group": "vdiusers",
    "md5sum": "15686602524e414a443391251ac46b4a",
    "mode": "0644",
    "owner": "bob",
    "size": 32,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371026.302065-26344-216915276880984/source",
    "state": "file",
    "uid": 1001
}

TASK [vnc : Template TigerVNC users file] **************************************
changed: [localhost] => {
    "changed": true,
    "checksum": "07719f46faaccbdf742785d5d2310a55a7352cdb",
    "dest": "/etc/tigervnc/vncserver.users",
    "gid": 0,
    "group": "root",
    "md5sum": "4e1b63b33d08dda6c1a7dde083fe9854",
    "mode": "0644",
    "owner": "root",
    "size": 16,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371026.663593-26366-244603176491990/source",
    "state": "file",
    "uid": 0
}

TASK [vnc : Deploy per-user TigerVNC systemd unit (Ubuntu/Debian)] *************
skipping: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => {
    "changed": false
}

MSG:

All items skipped

TASK [vnc : Deploy TigerVNC systemd unit (Rocky)] ******************************
changed: [localhost] => {
    "changed": true,
    "checksum": "bd078a72af7384ad8cc0fdd595ea34d71f75969c",
    "dest": "/etc/systemd/system/vncserver@.service",
    "gid": 0,
    "group": "root",
    "md5sum": "a6a8e5fa35e07463b97f8750bab854fa",
    "mode": "0644",
    "owner": "root",
    "size": 268,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371027.0719545-26392-180913534199741/source",
    "state": "file",
    "uid": 0
}

TASK [vnc : Reload systemd daemon] *********************************************
ok: [localhost] => {
    "changed": false,
    "name": null,
    "status": {}
}

TASK [vnc : Enable & start TigerVNC (Ubuntu/Debian)] ***************************
skipping: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2})  => {
    "ansible_loop_var": "item",
    "changed": false,
    "false_condition": "ansible_distribution in [\"Ubuntu\", \"Debian\"]",
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "skip_reason": "Conditional result was False"
}
skipping: [localhost] => {
    "changed": false
}

MSG:

All items skipped

TASK [vnc : Enable & start TigerVNC (Rocky)] ***********************************
changed: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "enabled": true,
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "name": "vncserver@:1",
    "state": "started",
    "status": {
        "ActiveEnterTimestampMonotonic": "0",
        "ActiveExitTimestampMonotonic": "0",
        "ActiveState": "inactive",
        "After": "syslog.target basic.target sysinit.target system-vncserver.slice network.target systemd-journald.socket",
        "AllowIsolate": "no",
        "AllowedCPUs": "",
        "AllowedMemoryNodes": "",
        "AmbientCapabilities": "",
        "AssertResult": "no",
        "AssertTimestampMonotonic": "0",
        "Before": "shutdown.target",
        "BlockIOAccounting": "no",
        "BlockIOWeight": "[not set]",
        "CPUAccounting": "no",
        "CPUAffinity": "",
        "CPUAffinityFromNUMA": "no",
        "CPUQuotaPerSecUSec": "infinity",
        "CPUQuotaPeriodUSec": "infinity",
        "CPUSchedulingPolicy": "0",
        "CPUSchedulingPriority": "0",
        "CPUSchedulingResetOnFork": "no",
        "CPUShares": "[not set]",
        "CPUUsageNSec": "[not set]",
        "CPUWeight": "[not set]",
        "CacheDirectoryMode": "0755",
        "CanFreeze": "yes",
        "CanIsolate": "no",
        "CanReload": "no",
        "CanStart": "yes",
        "CanStop": "yes",
        "CapabilityBoundingSet": "cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap_ipc_owner cap_sys_module cap_sys_rawio cap_sys_chroot cap_sys_ptrace cap_sys_pacct cap_sys_admin cap_sys_boot cap_sys_nice cap_sys_resource cap_sys_time cap_sys_tty_config cap_mknod cap_lease cap_audit_write cap_audit_control cap_setfcap cap_mac_override cap_mac_admin cap_syslog cap_wake_alarm cap_block_suspend cap_audit_read cap_perfmon cap_bpf",
        "CollectMode": "inactive",
        "ConditionResult": "no",
        "ConditionTimestampMonotonic": "0",
        "ConfigurationDirectoryMode": "0755",
        "Conflicts": "shutdown.target",
        "ControlPID": "0",
        "DefaultDependencies": "yes",
        "DefaultMemoryLow": "0",
        "DefaultMemoryMin": "0",
        "Delegate": "no",
        "Description": "TigerVNC server for user :1",
        "DevicePolicy": "auto",
        "DynamicUser": "no",
        "EffectiveCPUs": "",
        "EffectiveMemoryNodes": "",
        "ExecMainCode": "0",
        "ExecMainExitTimestampMonotonic": "0",
        "ExecMainPID": "0",
        "ExecMainStartTimestampMonotonic": "0",
        "ExecMainStatus": "0",
        "ExecStart": "{ path=/usr/libexec/vncsession-start ; argv[]=/usr/libexec/vncsession-start :1 ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "ExecStop": "{ path=/bin/true ; argv[]=/bin/true ; ignore_errors=yes ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "FailureAction": "none",
        "FileDescriptorStoreMax": "0",
        "FragmentPath": "/etc/systemd/system/vncserver@.service",
        "FreezerState": "running",
        "GID": "[not set]",
        "GuessMainPID": "yes",
        "IOAccounting": "no",
        "IOSchedulingClass": "0",
        "IOSchedulingPriority": "0",
        "IOWeight": "[not set]",
        "IPAccounting": "no",
        "IPEgressBytes": "18446744073709551615",
        "IPEgressPackets": "18446744073709551615",
        "IPIngressBytes": "18446744073709551615",
        "IPIngressPackets": "18446744073709551615",
        "Id": "vncserver@:1.service",
        "IgnoreOnIsolate": "no",
        "IgnoreSIGPIPE": "yes",
        "InactiveEnterTimestampMonotonic": "0",
        "InactiveExitTimestampMonotonic": "0",
        "JobRunningTimeoutUSec": "infinity",
        "JobTimeoutAction": "none",
        "JobTimeoutUSec": "infinity",
        "KeyringMode": "private",
        "KillMode": "control-group",
        "KillSignal": "15",
        "LimitAS": "infinity",
        "LimitASSoft": "infinity",
        "LimitCORE": "infinity",
        "LimitCORESoft": "0",
        "LimitCPU": "infinity",
        "LimitCPUSoft": "infinity",
        "LimitDATA": "infinity",
        "LimitDATASoft": "infinity",
        "LimitFSIZE": "infinity",
        "LimitFSIZESoft": "infinity",
        "LimitLOCKS": "infinity",
        "LimitLOCKSSoft": "infinity",
        "LimitMEMLOCK": "65536",
        "LimitMEMLOCKSoft": "65536",
        "LimitMSGQUEUE": "819200",
        "LimitMSGQUEUESoft": "819200",
        "LimitNICE": "0",
        "LimitNICESoft": "0",
        "LimitNOFILE": "262144",
        "LimitNOFILESoft": "1024",
        "LimitNPROC": "127383",
        "LimitNPROCSoft": "127383",
        "LimitRSS": "infinity",
        "LimitRSSSoft": "infinity",
        "LimitRTPRIO": "0",
        "LimitRTPRIOSoft": "0",
        "LimitRTTIME": "infinity",
        "LimitRTTIMESoft": "infinity",
        "LimitSIGPENDING": "127383",
        "LimitSIGPENDINGSoft": "127383",
        "LimitSTACK": "infinity",
        "LimitSTACKSoft": "8388608",
        "LoadState": "loaded",
        "LockPersonality": "no",
        "LogLevelMax": "-1",
        "LogRateLimitBurst": "0",
        "LogRateLimitIntervalUSec": "0",
        "LogsDirectoryMode": "0755",
        "MainPID": "0",
        "MemoryAccounting": "yes",
        "MemoryCurrent": "[not set]",
        "MemoryDenyWriteExecute": "no",
        "MemoryHigh": "infinity",
        "MemoryLimit": "infinity",
        "MemoryLow": "0",
        "MemoryMax": "infinity",
        "MemoryMin": "0",
        "MemorySwapMax": "infinity",
        "MountAPIVFS": "no",
        "MountFlags": "",
        "NFileDescriptorStore": "0",
        "NRestarts": "0",
        "NUMAMask": "",
        "NUMAPolicy": "n/a",
        "Names": "vncserver@:1.service",
        "NeedDaemonReload": "no",
        "Nice": "0",
        "NoNewPrivileges": "no",
        "NonBlocking": "no",
        "NotifyAccess": "none",
        "OOMScoreAdjust": "0",
        "OnFailureJobMode": "replace",
        "PIDFile": "/run/vncsession-:1.pid",
        "PermissionsStartOnly": "no",
        "Perpetual": "no",
        "PrivateDevices": "no",
        "PrivateMounts": "no",
        "PrivateNetwork": "no",
        "PrivateTmp": "no",
        "PrivateUsers": "no",
        "ProtectControlGroups": "no",
        "ProtectHome": "no",
        "ProtectKernelModules": "no",
        "ProtectKernelTunables": "no",
        "ProtectSystem": "no",
        "RefuseManualStart": "no",
        "RefuseManualStop": "no",
        "RemainAfterExit": "no",
        "RemoveIPC": "no",
        "Requires": "sysinit.target system-vncserver.slice",
        "Restart": "always",
        "RestartUSec": "15s",
        "RestrictNamespaces": "no",
        "RestrictRealtime": "no",
        "RestrictSUIDSGID": "no",
        "Result": "success",
        "RootDirectoryStartOnly": "no",
        "RuntimeDirectoryMode": "0755",
        "RuntimeDirectoryPreserve": "no",
        "RuntimeMaxUSec": "infinity",
        "SameProcessGroup": "no",
        "SecureBits": "0",
        "SendSIGHUP": "no",
        "SendSIGKILL": "yes",
        "Slice": "system-vncserver.slice",
        "StandardError": "inherit",
        "StandardInput": "null",
        "StandardInputData": "",
        "StandardOutput": "journal",
        "StartLimitAction": "none",
        "StartLimitBurst": "5",
        "StartLimitIntervalUSec": "10s",
        "StartupBlockIOWeight": "[not set]",
        "StartupCPUShares": "[not set]",
        "StartupCPUWeight": "[not set]",
        "StartupIOWeight": "[not set]",
        "StateChangeTimestampMonotonic": "0",
        "StateDirectoryMode": "0755",
        "StatusErrno": "0",
        "StopWhenUnneeded": "no",
        "SubState": "dead",
        "SuccessAction": "none",
        "SyslogFacility": "3",
        "SyslogLevel": "6",
        "SyslogLevelPrefix": "yes",
        "SyslogPriority": "30",
        "SystemCallErrorNumber": "0",
        "TTYReset": "no",
        "TTYVHangup": "no",
        "TTYVTDisallocate": "no",
        "TasksAccounting": "yes",
        "TasksCurrent": "[not set]",
        "TasksMax": "203813",
        "TimeoutStartUSec": "1min 30s",
        "TimeoutStopUSec": "1min 30s",
        "TimerSlackNSec": "50000",
        "Transient": "no",
        "Type": "forking",
        "UID": "[not set]",
        "UMask": "0022",
        "UnitFilePreset": "disabled",
        "UnitFileState": "disabled",
        "UtmpMode": "init",
        "WatchdogTimestampMonotonic": "0",
        "WatchdogUSec": "0"
    }
}
changed: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "enabled": true,
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "name": "vncserver@:2",
    "state": "started",
    "status": {
        "ActiveEnterTimestampMonotonic": "0",
        "ActiveExitTimestampMonotonic": "0",
        "ActiveState": "inactive",
        "After": "syslog.target sysinit.target basic.target system-vncserver.slice systemd-journald.socket network.target",
        "AllowIsolate": "no",
        "AllowedCPUs": "",
        "AllowedMemoryNodes": "",
        "AmbientCapabilities": "",
        "AssertResult": "no",
        "AssertTimestampMonotonic": "0",
        "Before": "shutdown.target",
        "BlockIOAccounting": "no",
        "BlockIOWeight": "[not set]",
        "CPUAccounting": "no",
        "CPUAffinity": "",
        "CPUAffinityFromNUMA": "no",
        "CPUQuotaPerSecUSec": "infinity",
        "CPUQuotaPeriodUSec": "infinity",
        "CPUSchedulingPolicy": "0",
        "CPUSchedulingPriority": "0",
        "CPUSchedulingResetOnFork": "no",
        "CPUShares": "[not set]",
        "CPUUsageNSec": "[not set]",
        "CPUWeight": "[not set]",
        "CacheDirectoryMode": "0755",
        "CanFreeze": "yes",
        "CanIsolate": "no",
        "CanReload": "no",
        "CanStart": "yes",
        "CanStop": "yes",
        "CapabilityBoundingSet": "cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap_ipc_owner cap_sys_module cap_sys_rawio cap_sys_chroot cap_sys_ptrace cap_sys_pacct cap_sys_admin cap_sys_boot cap_sys_nice cap_sys_resource cap_sys_time cap_sys_tty_config cap_mknod cap_lease cap_audit_write cap_audit_control cap_setfcap cap_mac_override cap_mac_admin cap_syslog cap_wake_alarm cap_block_suspend cap_audit_read cap_perfmon cap_bpf",
        "CollectMode": "inactive",
        "ConditionResult": "no",
        "ConditionTimestampMonotonic": "0",
        "ConfigurationDirectoryMode": "0755",
        "Conflicts": "shutdown.target",
        "ControlPID": "0",
        "DefaultDependencies": "yes",
        "DefaultMemoryLow": "0",
        "DefaultMemoryMin": "0",
        "Delegate": "no",
        "Description": "TigerVNC server for user :2",
        "DevicePolicy": "auto",
        "DynamicUser": "no",
        "EffectiveCPUs": "",
        "EffectiveMemoryNodes": "",
        "ExecMainCode": "0",
        "ExecMainExitTimestampMonotonic": "0",
        "ExecMainPID": "0",
        "ExecMainStartTimestampMonotonic": "0",
        "ExecMainStatus": "0",
        "ExecStart": "{ path=/usr/libexec/vncsession-start ; argv[]=/usr/libexec/vncsession-start :2 ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "ExecStop": "{ path=/bin/true ; argv[]=/bin/true ; ignore_errors=yes ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "FailureAction": "none",
        "FileDescriptorStoreMax": "0",
        "FragmentPath": "/etc/systemd/system/vncserver@.service",
        "FreezerState": "running",
        "GID": "[not set]",
        "GuessMainPID": "yes",
        "IOAccounting": "no",
        "IOSchedulingClass": "0",
        "IOSchedulingPriority": "0",
        "IOWeight": "[not set]",
        "IPAccounting": "no",
        "IPEgressBytes": "18446744073709551615",
        "IPEgressPackets": "18446744073709551615",
        "IPIngressBytes": "18446744073709551615",
        "IPIngressPackets": "18446744073709551615",
        "Id": "vncserver@:2.service",
        "IgnoreOnIsolate": "no",
        "IgnoreSIGPIPE": "yes",
        "InactiveEnterTimestampMonotonic": "0",
        "InactiveExitTimestampMonotonic": "0",
        "JobRunningTimeoutUSec": "infinity",
        "JobTimeoutAction": "none",
        "JobTimeoutUSec": "infinity",
        "KeyringMode": "private",
        "KillMode": "control-group",
        "KillSignal": "15",
        "LimitAS": "infinity",
        "LimitASSoft": "infinity",
        "LimitCORE": "infinity",
        "LimitCORESoft": "0",
        "LimitCPU": "infinity",
        "LimitCPUSoft": "infinity",
        "LimitDATA": "infinity",
        "LimitDATASoft": "infinity",
        "LimitFSIZE": "infinity",
        "LimitFSIZESoft": "infinity",
        "LimitLOCKS": "infinity",
        "LimitLOCKSSoft": "infinity",
        "LimitMEMLOCK": "65536",
        "LimitMEMLOCKSoft": "65536",
        "LimitMSGQUEUE": "819200",
        "LimitMSGQUEUESoft": "819200",
        "LimitNICE": "0",
        "LimitNICESoft": "0",
        "LimitNOFILE": "262144",
        "LimitNOFILESoft": "1024",
        "LimitNPROC": "127383",
        "LimitNPROCSoft": "127383",
        "LimitRSS": "infinity",
        "LimitRSSSoft": "infinity",
        "LimitRTPRIO": "0",
        "LimitRTPRIOSoft": "0",
        "LimitRTTIME": "infinity",
        "LimitRTTIMESoft": "infinity",
        "LimitSIGPENDING": "127383",
        "LimitSIGPENDINGSoft": "127383",
        "LimitSTACK": "infinity",
        "LimitSTACKSoft": "8388608",
        "LoadState": "loaded",
        "LockPersonality": "no",
        "LogLevelMax": "-1",
        "LogRateLimitBurst": "0",
        "LogRateLimitIntervalUSec": "0",
        "LogsDirectoryMode": "0755",
        "MainPID": "0",
        "MemoryAccounting": "yes",
        "MemoryCurrent": "[not set]",
        "MemoryDenyWriteExecute": "no",
        "MemoryHigh": "infinity",
        "MemoryLimit": "infinity",
        "MemoryLow": "0",
        "MemoryMax": "infinity",
        "MemoryMin": "0",
        "MemorySwapMax": "infinity",
        "MountAPIVFS": "no",
        "MountFlags": "",
        "NFileDescriptorStore": "0",
        "NRestarts": "0",
        "NUMAMask": "",
        "NUMAPolicy": "n/a",
        "Names": "vncserver@:2.service",
        "NeedDaemonReload": "no",
        "Nice": "0",
        "NoNewPrivileges": "no",
        "NonBlocking": "no",
        "NotifyAccess": "none",
        "OOMScoreAdjust": "0",
        "OnFailureJobMode": "replace",
        "PIDFile": "/run/vncsession-:2.pid",
        "PermissionsStartOnly": "no",
        "Perpetual": "no",
        "PrivateDevices": "no",
        "PrivateMounts": "no",
        "PrivateNetwork": "no",
        "PrivateTmp": "no",
        "PrivateUsers": "no",
        "ProtectControlGroups": "no",
        "ProtectHome": "no",
        "ProtectKernelModules": "no",
        "ProtectKernelTunables": "no",
        "ProtectSystem": "no",
        "RefuseManualStart": "no",
        "RefuseManualStop": "no",
        "RemainAfterExit": "no",
        "RemoveIPC": "no",
        "Requires": "system-vncserver.slice sysinit.target",
        "Restart": "always",
        "RestartUSec": "15s",
        "RestrictNamespaces": "no",
        "RestrictRealtime": "no",
        "RestrictSUIDSGID": "no",
        "Result": "success",
        "RootDirectoryStartOnly": "no",
        "RuntimeDirectoryMode": "0755",
        "RuntimeDirectoryPreserve": "no",
        "RuntimeMaxUSec": "infinity",
        "SameProcessGroup": "no",
        "SecureBits": "0",
        "SendSIGHUP": "no",
        "SendSIGKILL": "yes",
        "Slice": "system-vncserver.slice",
        "StandardError": "inherit",
        "StandardInput": "null",
        "StandardInputData": "",
        "StandardOutput": "journal",
        "StartLimitAction": "none",
        "StartLimitBurst": "5",
        "StartLimitIntervalUSec": "10s",
        "StartupBlockIOWeight": "[not set]",
        "StartupCPUShares": "[not set]",
        "StartupCPUWeight": "[not set]",
        "StartupIOWeight": "[not set]",
        "StateChangeTimestampMonotonic": "0",
        "StateDirectoryMode": "0755",
        "StatusErrno": "0",
        "StopWhenUnneeded": "no",
        "SubState": "dead",
        "SuccessAction": "none",
        "SyslogFacility": "3",
        "SyslogLevel": "6",
        "SyslogLevelPrefix": "yes",
        "SyslogPriority": "30",
        "SystemCallErrorNumber": "0",
        "TTYReset": "no",
        "TTYVHangup": "no",
        "TTYVTDisallocate": "no",
        "TasksAccounting": "yes",
        "TasksCurrent": "[not set]",
        "TasksMax": "203813",
        "TimeoutStartUSec": "1min 30s",
        "TimeoutStopUSec": "1min 30s",
        "TimerSlackNSec": "50000",
        "Transient": "no",
        "Type": "forking",
        "UID": "[not set]",
        "UMask": "0022",
        "UnitFilePreset": "disabled",
        "UnitFileState": "disabled",
        "UtmpMode": "init",
        "WatchdogTimestampMonotonic": "0",
        "WatchdogUSec": "0"
    }
}

TASK [vnc : Install TightVNC] **************************************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "vnc_flavor | lower == 'tightvnc'",
    "skip_reason": "Conditional result was False"
}

TASK [vnc : Set current role for lock manager completion] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "vnc",
        "role_completed": true
    },
    "changed": false
}

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: vnc

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371018.3885562,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "ca35350cf060981f0667398fcb15c8e12423a97e",
        "ctime": 1753371018.1625395,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 117754419,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371018.0155284,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 1024,
        "uid": 0,
        "version": "3086664638",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Create initial lock file structure] ***********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file creation] *********************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and not lock_file_stat.stat.exists"
}

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:16Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.020571",
    "end": "2025-07-24 15:30:30.669137",
    "rc": 0,
    "start": "2025-07-24 15:30:30.648566"
}

STDOUT:

2025-07-24T15:30:30Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:16Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:16Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:30:30Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:30Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": false
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:30:30Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for vnc:
  - completed: True
  - completed_at: 2025-07-24T15:30:30Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating vnc:
  - current_lock_data: completed_roles:
    base_os:
        completed: true
        completed_at: '2025-07-24T15:29:50Z'
    lock_manager:
        completed: true
        completed_at: '2025-07-24T15:27:44Z'
    secret_manager:
        completed: true
        completed_at: '2025-07-24T15:30:03Z'
    user_provision:
        completed: true
        completed_at: '2025-07-24T15:30:16Z'
    vdi_tool:
        completed: false
    vnc:
        completed: false
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:30:30Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users:
    - alice
    - bob
    previous_users:
    - alice
    - bob
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:30:30Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated:
    - alice
    - bob

  - current_completed_roles: base_os:
    completed: true
    completed_at: '2025-07-24T15:29:50Z'
lock_manager:
    completed: true
    completed_at: '2025-07-24T15:27:44Z'
secret_manager:
    completed: true
    completed_at: '2025-07-24T15:30:03Z'
user_provision:
    completed: true
    completed_at: '2025-07-24T15:30:16Z'
vdi_tool:
    completed: false
vnc:
    completed: false

  - role_completed: True
  - current_role: vnc


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:16Z"
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": false
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:16Z"
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:30Z"
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating vnc:
  - current_role: vnc
  - role_completed: True
  - completed_roles: {'base_os': {'completed': True, 'completed_at': '2025-07-24T15:29:50Z'}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': True, 'completed_at': '2025-07-24T15:30:03Z'}, 'user_provision': {'completed': True, 'completed_at': '2025-07-24T15:30:16Z'}, 'vdi_tool': {'completed': False}, 'vnc': {'completed': True, 'completed_at': '2025-07-24T15:30:30Z'}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for vnc:
  - current_users_updated: ['alice', 'bob']
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:30:30Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:30:30Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for vnc:
  - current_users: ['alice', 'bob']
  - previous_users: ['alice', 'bob']
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": false
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: False
  - setup_status: configuring
  - completed_roles_count: 5
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "542bc16243f6f0f5bd20bfbc7c7d0ae70dfc3965",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "51acde48f43e59dc50980ecbe5a85b15",
    "mode": "0644",
    "owner": "root",
    "size": 1066,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371032.3061836-27078-30129676363744/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.003949",
    "end": "2025-07-24 15:30:32.886270",
    "rc": 0,
    "start": "2025-07-24 15:30:32.882321"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MzBaJwogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDozMFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDozMFonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogZmFsc2UKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MzBaJwogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMDozMFonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogY29uZmlndXJpbmcKICB1c2VyX21hbmFnZW1lbnQ6CiAgICBjdXJyZW50X3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHByZXZpb3VzX3VzZXJzOgogICAgLSBhbGljZQogICAgLSBib2IKICAgIHJlbW92ZWRfdXNlcnM6IFtdCiAgdXNlcl9zZWNyZXRzX3N0YXR1czoKICAgIGxhc3Rfc2VjcmV0X2NoZWNrOiAnMjAyNS0wNy0yNFQxNTozMDozMFonCiAgICB1c2VyX3NlY3JldHNfaGFzaDogNmE2YTAyZDNkMDk5MzNjYTI4MmFlMmIwMjMzNjM0M2M5ZDczNzAxZTQ1YmQ4MTQ3NWZiZDkyZGNmOWQyZjNiNgogICAgdXNlcnNfdXBkYXRlZDoKICAgIC0gYWxpY2UKICAgIC0gYm9iCg==",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:05.181207",
    "end": "2025-07-24 15:30:38.265496",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:30:33.084289"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.040227",
    "end": "2025-07-24 15:30:38.534489",
    "rc": 0,
    "start": "2025-07-24 15:30:38.494262"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370874.1548011,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
        "ctime": 1753370872.6256874,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 285214140,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370872.4766762,
        "nlink": 1,
        "path": "/etc/systemd/system/vdi-monitor.service",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 283,
        "uid": 0,
        "version": "1338188335",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: vnc
  - vdi_monitor_service_exists: True
  - lock_file_creation.changed: False
  - will_setup_monitor: False


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not vdi_monitor_service_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

TASK [vdi_tool : Set current role for lock manager check] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "vdi_tool"
    },
    "changed": false
}

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371032.8846393,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "542bc16243f6f0f5bd20bfbc7c7d0ae70dfc3965",
        "ctime": 1753371032.652622,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 419489989,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371032.49061,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 1066,
        "uid": 0,
        "version": "68461029",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Load existing lock file] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Debug lock file load result] ******************************
ok: [localhost] => {}

MSG:

Lock file loaded successfully: True

TASK [lock_manager : Calculate current deployment hash] ************************
ok: [localhost] => {
    "ansible_facts": {
        "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab"
    },
    "changed": false
}

TASK [lock_manager : Debug deployment hash calculation] ************************
ok: [localhost] => {}

MSG:

Current deployment hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
Deployment components:
  - deployment_name: vdi-test-scott
  - project_id: hpc-discovery-external
  - vdi_tool: guacamole
  - vnc_flavor: tigervnc
  - user_provision: local_users
  - vdi_webapp_port: 8081
  - vdi_resolution: 1920x1080
  - vdi_users count: 2


TASK [lock_manager : Calculate current user secrets hash] **********************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets hash calculation] **********************
ok: [localhost] => {}

MSG:

Current user secrets hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
User configuration components:
  - vdi_users (blueprint): [{"username": "alice", "port": 5901}, {"username": "bob", "port": 5902, "secret_name": "a-password-for-bob"}]


TASK [lock_manager : Set default values for missing lock file] *****************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file status] ***********************************
ok: [localhost] => {}

MSG:

Lock file status:
  - exists: True
  - deployment_hash: none
  - user_secrets_hash: none
  - force_rerun: False


TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_file_exists": true
    },
    "changed": false
}

TASK [lock_manager : Check if current role is completed] ***********************
ok: [localhost] => {
    "ansible_facts": {
        "current_role_completed": false
    },
    "changed": false
}

TASK [lock_manager : Check if deployment hash matches] *************************
ok: [localhost] => {
    "ansible_facts": {
        "deployment_hash_matches": false
    },
    "changed": false
}

TASK [lock_manager : Check if force rerun is enabled] **************************
ok: [localhost] => {
    "ansible_facts": {
        "force_rerun_enabled": false
    },
    "changed": false
}

TASK [lock_manager : Determine if role should run] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [lock_manager : Debug role should run calculation] ************************
ok: [localhost] => {}

MSG:

Role should run calculation for vdi_tool:
  - not lock_file_exists: False
  - not current_role_completed: True
  - not deployment_hash_matches: True
  - force_rerun_enabled: False
  - role_should_run: True


TASK [lock_manager : Debug role execution decision] ****************************
ok: [localhost] => {}

MSG:

Role execution decision for vdi_tool:
  - current_role: vdi_tool
  - ansible_role_name: lock_manager
  - role_should_run: True
  - lock_file_exists: True
  - current_role_completed: False
  - deployment_hash_matches: False
  - force_rerun_enabled: False


TASK [lock_manager : Check if user configuration has changed] ******************
ok: [localhost] => {
    "ansible_facts": {
        "user_config_changed": true
    },
    "changed": false
}

TASK [lock_manager : Set user secrets changed flag (will be updated by secret_manager role)] ***
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_changed": true
    },
    "changed": false
}

TASK [lock_manager : Debug user secrets change detection] **********************
ok: [localhost] => {}

MSG:

User configuration change detection:
  - user_config_changed: True
  - user_secrets_changed: True
  - stored_hash: none
  - current_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [lock_manager : Set lock check result] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "lock_check_result": {
            "current_deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "current_user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "existing_deployment_hash": "none",
            "existing_user_secrets_hash": "none",
            "force_rerun": false,
            "role_should_run": true,
            "user_secrets_changed": true
        }
    },
    "changed": false
}

TASK [lock_manager : Debug final lock check result] ****************************
ok: [localhost] => {}

MSG:

Final lock check result:
  - role_should_run: True
  - deployment_hash_changed: True
  - user_secrets_changed: True
  - force_rerun: False


TASK [vdi_tool : Set role_should_run from lock check result] *******************
ok: [localhost] => {
    "ansible_facts": {
        "role_should_run": true
    },
    "changed": false
}

TASK [vdi_tool : Skip vdi_tool tasks if role should not run] *******************
skipping: [localhost] => {
    "false_condition": "not role_should_run"
}

TASK [vdi_tool : Install Guacamole] ********************************************
included: /tmp/vdi/roles/vdi_tool/tasks/guacamole.yaml for localhost

TASK [vdi_tool : Ensure PostgreSQL data & init directories exist] **************
changed: [localhost] => (item=/opt/guacamole-db/data) => {
    "ansible_loop_var": "item",
    "changed": true,
    "gid": 0,
    "group": "root",
    "item": "/opt/guacamole-db/data",
    "mode": "0755",
    "owner": "root",
    "path": "/opt/guacamole-db/data",
    "size": 6,
    "state": "directory",
    "uid": 0
}
changed: [localhost] => (item=/opt/guacamole-db/initdb) => {
    "ansible_loop_var": "item",
    "changed": true,
    "gid": 0,
    "group": "root",
    "item": "/opt/guacamole-db/initdb",
    "mode": "0755",
    "owner": "root",
    "path": "/opt/guacamole-db/initdb",
    "size": 6,
    "state": "directory",
    "uid": 0
}

TASK [vdi_tool : Check Docker service status] **********************************
ok: [localhost] => {
    "ansible_facts": {
        "services": {
            "NetworkManager-dispatcher.service": {
                "name": "NetworkManager-dispatcher.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "NetworkManager-wait-online.service": {
                "name": "NetworkManager-wait-online.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "NetworkManager.service": {
                "name": "NetworkManager.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "accounts-daemon.service": {
                "name": "accounts-daemon.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "acpid.service": {
                "name": "acpid.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "apt-daily.service": {
                "name": "apt-daily.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "arp-ethers.service": {
                "name": "arp-ethers.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "atd.service": {
                "name": "atd.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "auditd.service": {
                "name": "auditd.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "auth-rpcgss-module.service": {
                "name": "auth-rpcgss-module.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "auto-cpufreq.service": {
                "name": "auto-cpufreq.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "autovt@.service": {
                "name": "autovt@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "enabled"
            },
            "bluetooth.service": {
                "name": "bluetooth.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "bolt.service": {
                "name": "bolt.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "btattach-bcm@.service": {
                "name": "btattach-bcm@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "canberra-system-bootup.service": {
                "name": "canberra-system-bootup.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "canberra-system-shutdown-reboot.service": {
                "name": "canberra-system-shutdown-reboot.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "canberra-system-shutdown.service": {
                "name": "canberra-system-shutdown.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "chrony-dnssrv@.service": {
                "name": "chrony-dnssrv@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "chrony-wait.service": {
                "name": "chrony-wait.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "chronyd.service": {
                "name": "chronyd.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "colord.service": {
                "name": "colord.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "console-getty.service": {
                "name": "console-getty.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "container-getty@.service": {
                "name": "container-getty@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "containerd.service": {
                "name": "containerd.service",
                "source": "systemd",
                "state": "running",
                "status": "disabled"
            },
            "cpupower.service": {
                "name": "cpupower.service",
                "source": "systemd",
                "state": "stopped",
                "status": "disabled"
            },
            "crond.service": {
                "name": "crond.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "daos_agent.service": {
                "name": "daos_agent.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "dbus-org.bluez.service": {
                "name": "dbus-org.bluez.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "dbus-org.freedesktop.hostname1.service": {
                "name": "dbus-org.freedesktop.hostname1.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dbus-org.freedesktop.locale1.service": {
                "name": "dbus-org.freedesktop.locale1.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dbus-org.freedesktop.login1.service": {
                "name": "dbus-org.freedesktop.login1.service",
                "source": "systemd",
                "state": "active",
                "status": "static"
            },
            "dbus-org.freedesktop.nm-dispatcher.service": {
                "name": "dbus-org.freedesktop.nm-dispatcher.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "dbus-org.freedesktop.portable1.service": {
                "name": "dbus-org.freedesktop.portable1.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dbus-org.freedesktop.timedate1.service": {
                "name": "dbus-org.freedesktop.timedate1.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "dbus.service": {
                "name": "dbus.service",
                "source": "systemd",
                "state": "running",
                "status": "static"
            },
            "debug-shell.service": {
                "name": "debug-shell.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "display-manager.service": {
                "name": "display-manager.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "dnf-automatic-download.service": {
                "name": "dnf-automatic-download.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dnf-automatic-install.service": {
                "name": "dnf-automatic-install.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dnf-automatic-notifyonly.service": {
                "name": "dnf-automatic-notifyonly.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dnf-automatic.service": {
                "name": "dnf-automatic.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dnf-makecache.service": {
                "name": "dnf-makecache.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dnf-system-upgrade-cleanup.service": {
                "name": "dnf-system-upgrade-cleanup.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "dnf-system-upgrade.service": {
                "name": "dnf-system-upgrade.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "docker.service": {
                "name": "docker.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "dracut-cmdline.service": {
                "name": "dracut-cmdline.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-initqueue.service": {
                "name": "dracut-initqueue.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-mount.service": {
                "name": "dracut-mount.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-pre-mount.service": {
                "name": "dracut-pre-mount.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-pre-pivot.service": {
                "name": "dracut-pre-pivot.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-pre-trigger.service": {
                "name": "dracut-pre-trigger.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-pre-udev.service": {
                "name": "dracut-pre-udev.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-shutdown-onfailure.service": {
                "name": "dracut-shutdown-onfailure.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "dracut-shutdown.service": {
                "name": "dracut-shutdown.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "ebtables.service": {
                "name": "ebtables.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "emergency.service": {
                "name": "emergency.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "firewalld.service": {
                "name": "firewalld.service",
                "source": "systemd",
                "state": "stopped",
                "status": "masked"
            },
            "flatpak-system-helper.service": {
                "name": "flatpak-system-helper.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "fstrim.service": {
                "name": "fstrim.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "fwupd-offline-update.service": {
                "name": "fwupd-offline-update.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "fwupd-refresh.service": {
                "name": "fwupd-refresh.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "fwupd.service": {
                "name": "fwupd.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "gce-workload-cert-refresh.service": {
                "name": "gce-workload-cert-refresh.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "gdm.service": {
                "name": "gdm.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "geoclue.service": {
                "name": "geoclue.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "getty@.service": {
                "name": "getty@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "enabled"
            },
            "getty@tty1.service": {
                "name": "getty@tty1.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "google-disk-expand.service": {
                "name": "google-disk-expand.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "google-guest-agent-manager.service": {
                "name": "google-guest-agent-manager.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "google-guest-agent.service": {
                "name": "google-guest-agent.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "google-guest-compat-manager.service": {
                "name": "google-guest-compat-manager.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "google-hpc-firstrun.service": {
                "name": "google-hpc-firstrun.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "google-hpc-multiqueue.service": {
                "name": "google-hpc-multiqueue.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "google-osconfig-agent.service": {
                "name": "google-osconfig-agent.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "google-oslogin-cache.service": {
                "name": "google-oslogin-cache.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "google-shutdown-scripts.service": {
                "name": "google-shutdown-scripts.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "google-startup-scripts.service": {
                "name": "google-startup-scripts.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "grub-boot-indeterminate.service": {
                "name": "grub-boot-indeterminate.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "gssproxy.service": {
                "name": "gssproxy.service",
                "source": "systemd",
                "state": "running",
                "status": "disabled"
            },
            "halt-local.service": {
                "name": "halt-local.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "hwloc-dump-hwdata.service": {
                "name": "hwloc-dump-hwdata.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "iio-sensor-proxy.service": {
                "name": "iio-sensor-proxy.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "import-state.service": {
                "name": "import-state.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "initrd-cleanup.service": {
                "name": "initrd-cleanup.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "initrd-parse-etc.service": {
                "name": "initrd-parse-etc.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "initrd-switch-root.service": {
                "name": "initrd-switch-root.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "initrd-udevadm-cleanup-db.service": {
                "name": "initrd-udevadm-cleanup-db.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "iprdump.service": {
                "name": "iprdump.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "iprinit.service": {
                "name": "iprinit.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "iprupdate.service": {
                "name": "iprupdate.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "kdump.service": {
                "name": "kdump.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "kmod-static-nodes.service": {
                "name": "kmod-static-nodes.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "kvm_stat.service": {
                "name": "kvm_stat.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "ldconfig.service": {
                "name": "ldconfig.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "loadmodules.service": {
                "name": "loadmodules.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "man-db-cache-update.service": {
                "name": "man-db-cache-update.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "man-db-restart-cache-update.service": {
                "name": "man-db-restart-cache-update.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "mdadm-grow-continue@.service": {
                "name": "mdadm-grow-continue@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "mdadm-last-resort@.service": {
                "name": "mdadm-last-resort@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "mdcheck_continue.service": {
                "name": "mdcheck_continue.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "mdcheck_start.service": {
                "name": "mdcheck_start.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "mdmon@.service": {
                "name": "mdmon@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "mdmonitor-oneshot.service": {
                "name": "mdmonitor-oneshot.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "mdmonitor.service": {
                "name": "mdmonitor.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "messagebus.service": {
                "name": "messagebus.service",
                "source": "systemd",
                "state": "active",
                "status": "static"
            },
            "modprobe@efi_pstore.service": {
                "name": "modprobe@efi_pstore.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "mount-localssd-raid.service": {
                "name": "mount-localssd-raid.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "network.service": {
                "name": "network.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "networking.service": {
                "name": "networking.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "nfs-blkmap.service": {
                "name": "nfs-blkmap.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "nfs-convert.service": {
                "name": "nfs-convert.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "nfs-idmapd.service": {
                "name": "nfs-idmapd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "nfs-mountd.service": {
                "name": "nfs-mountd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "nfs-server.service": {
                "name": "nfs-server.service",
                "source": "systemd",
                "state": "stopped",
                "status": "disabled"
            },
            "nfs-utils.service": {
                "name": "nfs-utils.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "nfsdcld.service": {
                "name": "nfsdcld.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "nftables.service": {
                "name": "nftables.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "nis-domainname.service": {
                "name": "nis-domainname.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "ntpd.service": {
                "name": "ntpd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "ntpdate.service": {
                "name": "ntpdate.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "nvmefc-boot-connections.service": {
                "name": "nvmefc-boot-connections.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "nvmf-autoconnect.service": {
                "name": "nvmf-autoconnect.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "nvmf-connect@.service": {
                "name": "nvmf-connect@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "pesign.service": {
                "name": "pesign.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-halt.service": {
                "name": "plymouth-halt.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-kexec.service": {
                "name": "plymouth-kexec.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-poweroff.service": {
                "name": "plymouth-poweroff.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-quit-wait.service": {
                "name": "plymouth-quit-wait.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "plymouth-quit.service": {
                "name": "plymouth-quit.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "plymouth-read-write.service": {
                "name": "plymouth-read-write.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "plymouth-reboot.service": {
                "name": "plymouth-reboot.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-start.service": {
                "name": "plymouth-start.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "plymouth-switch-root-initramfs.service": {
                "name": "plymouth-switch-root-initramfs.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "plymouth-switch-root.service": {
                "name": "plymouth-switch-root.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "polkit.service": {
                "name": "polkit.service",
                "source": "systemd",
                "state": "running",
                "status": "static"
            },
            "power-profiles-daemon.service": {
                "name": "power-profiles-daemon.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "qemu-guest-agent.service": {
                "name": "qemu-guest-agent.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "quotaon.service": {
                "name": "quotaon.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "rc-local.service": {
                "name": "rc-local.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "rdisc.service": {
                "name": "rdisc.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "rdma-load-modules@.service": {
                "name": "rdma-load-modules@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "rdma-ndd.service": {
                "name": "rdma-ndd.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "rescue.service": {
                "name": "rescue.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "rngd.service": {
                "name": "rngd.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "rpc-gssd.service": {
                "name": "rpc-gssd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "rpc-statd-notify.service": {
                "name": "rpc-statd-notify.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "rpc-statd.service": {
                "name": "rpc-statd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "rpcbind.service": {
                "name": "rpcbind.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "rsyslog.service": {
                "name": "rsyslog.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "rtkit-daemon.service": {
                "name": "rtkit-daemon.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "selinux-autorelabel-mark.service": {
                "name": "selinux-autorelabel-mark.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "selinux-autorelabel.service": {
                "name": "selinux-autorelabel.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "serial-getty@.service": {
                "name": "serial-getty@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "indirect"
            },
            "serial-getty@ttyS0.service": {
                "name": "serial-getty@ttyS0.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "serial-getty@ttyS1.service": {
                "name": "serial-getty@ttyS1.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "sntp.service": {
                "name": "sntp.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "sshd-keygen@.service": {
                "name": "sshd-keygen@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "disabled"
            },
            "sshd-keygen@ecdsa.service": {
                "name": "sshd-keygen@ecdsa.service",
                "source": "systemd",
                "state": "stopped",
                "status": "inactive"
            },
            "sshd-keygen@ed25519.service": {
                "name": "sshd-keygen@ed25519.service",
                "source": "systemd",
                "state": "stopped",
                "status": "inactive"
            },
            "sshd-keygen@rsa.service": {
                "name": "sshd-keygen@rsa.service",
                "source": "systemd",
                "state": "stopped",
                "status": "inactive"
            },
            "sshd.service": {
                "name": "sshd.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "sshd@.service": {
                "name": "sshd@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "sssd-autofs.service": {
                "name": "sssd-autofs.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd-kcm.service": {
                "name": "sssd-kcm.service",
                "source": "systemd",
                "state": "stopped",
                "status": "indirect"
            },
            "sssd-nss.service": {
                "name": "sssd-nss.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd-pac.service": {
                "name": "sssd-pac.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd-pam.service": {
                "name": "sssd-pam.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd-ssh.service": {
                "name": "sssd-ssh.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd-sudo.service": {
                "name": "sssd-sudo.service",
                "source": "systemd",
                "state": "inactive",
                "status": "indirect"
            },
            "sssd.service": {
                "name": "sssd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "switcheroo-control.service": {
                "name": "switcheroo-control.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "syslog.service": {
                "name": "syslog.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "system-update-cleanup.service": {
                "name": "system-update-cleanup.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-ask-password-console.service": {
                "name": "systemd-ask-password-console.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-ask-password-plymouth.service": {
                "name": "systemd-ask-password-plymouth.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-ask-password-wall.service": {
                "name": "systemd-ask-password-wall.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-backlight@.service": {
                "name": "systemd-backlight@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "systemd-binfmt.service": {
                "name": "systemd-binfmt.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-coredump@.service": {
                "name": "systemd-coredump@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "systemd-exit.service": {
                "name": "systemd-exit.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-firstboot.service": {
                "name": "systemd-firstboot.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-fsck-root.service": {
                "name": "systemd-fsck-root.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-fsck@.service": {
                "name": "systemd-fsck@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "systemd-fsck@dev-disk-by\\x2duuid-580C\\x2d02F4.service": {
                "name": "systemd-fsck@dev-disk-by\\x2duuid-580C\\x2d02F4.service",
                "source": "systemd",
                "state": "stopped",
                "status": "active"
            },
            "systemd-halt.service": {
                "name": "systemd-halt.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-hibernate-resume@.service": {
                "name": "systemd-hibernate-resume@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "systemd-hibernate.service": {
                "name": "systemd-hibernate.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-hostnamed.service": {
                "name": "systemd-hostnamed.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-hwdb-update.service": {
                "name": "systemd-hwdb-update.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-hybrid-sleep.service": {
                "name": "systemd-hybrid-sleep.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-initctl.service": {
                "name": "systemd-initctl.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-journal-catalog-update.service": {
                "name": "systemd-journal-catalog-update.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-journal-flush.service": {
                "name": "systemd-journal-flush.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-journald.service": {
                "name": "systemd-journald.service",
                "source": "systemd",
                "state": "running",
                "status": "static"
            },
            "systemd-kexec.service": {
                "name": "systemd-kexec.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-localed.service": {
                "name": "systemd-localed.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-logind.service": {
                "name": "systemd-logind.service",
                "source": "systemd",
                "state": "running",
                "status": "static"
            },
            "systemd-machine-id-commit.service": {
                "name": "systemd-machine-id-commit.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-modules-load.service": {
                "name": "systemd-modules-load.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-networkd.service": {
                "name": "systemd-networkd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "systemd-portabled.service": {
                "name": "systemd-portabled.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-poweroff.service": {
                "name": "systemd-poweroff.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-pstore.service": {
                "name": "systemd-pstore.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "systemd-quotacheck.service": {
                "name": "systemd-quotacheck.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-random-seed.service": {
                "name": "systemd-random-seed.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-reboot.service": {
                "name": "systemd-reboot.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-remount-fs.service": {
                "name": "systemd-remount-fs.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-resolved.service": {
                "name": "systemd-resolved.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "systemd-rfkill.service": {
                "name": "systemd-rfkill.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-suspend-then-hibernate.service": {
                "name": "systemd-suspend-then-hibernate.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-suspend.service": {
                "name": "systemd-suspend.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-sysctl.service": {
                "name": "systemd-sysctl.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-sysusers.service": {
                "name": "systemd-sysusers.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-timedated.service": {
                "name": "systemd-timedated.service",
                "source": "systemd",
                "state": "inactive",
                "status": "masked"
            },
            "systemd-timesyncd.service": {
                "name": "systemd-timesyncd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "systemd-tmpfiles-clean.service": {
                "name": "systemd-tmpfiles-clean.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-tmpfiles-setup-dev.service": {
                "name": "systemd-tmpfiles-setup-dev.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-tmpfiles-setup.service": {
                "name": "systemd-tmpfiles-setup.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-udev-settle.service": {
                "name": "systemd-udev-settle.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "systemd-udev-trigger.service": {
                "name": "systemd-udev-trigger.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-udevd.service": {
                "name": "systemd-udevd.service",
                "source": "systemd",
                "state": "running",
                "status": "static"
            },
            "systemd-update-done.service": {
                "name": "systemd-update-done.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-update-utmp-runlevel.service": {
                "name": "systemd-update-utmp-runlevel.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-update-utmp.service": {
                "name": "systemd-update-utmp.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-user-sessions.service": {
                "name": "systemd-user-sessions.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-vconsole-setup.service": {
                "name": "systemd-vconsole-setup.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "systemd-volatile-root.service": {
                "name": "systemd-volatile-root.service",
                "source": "systemd",
                "state": "inactive",
                "status": "static"
            },
            "tcsd.service": {
                "name": "tcsd.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "teamd@.service": {
                "name": "teamd@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "timedatex.service": {
                "name": "timedatex.service",
                "source": "systemd",
                "state": "inactive",
                "status": "enabled"
            },
            "tlp.service": {
                "name": "tlp.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "tuned.service": {
                "name": "tuned.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "udisks2.service": {
                "name": "udisks2.service",
                "source": "systemd",
                "state": "stopped",
                "status": "enabled"
            },
            "unbound-anchor.service": {
                "name": "unbound-anchor.service",
                "source": "systemd",
                "state": "stopped",
                "status": "static"
            },
            "upower.service": {
                "name": "upower.service",
                "source": "systemd",
                "state": "running",
                "status": "disabled"
            },
            "user-runtime-dir@.service": {
                "name": "user-runtime-dir@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "user-runtime-dir@1000.service": {
                "name": "user-runtime-dir@1000.service",
                "source": "systemd",
                "state": "stopped",
                "status": "active"
            },
            "user-runtime-dir@1001.service": {
                "name": "user-runtime-dir@1001.service",
                "source": "systemd",
                "state": "stopped",
                "status": "active"
            },
            "user-runtime-dir@87404603.service": {
                "name": "user-runtime-dir@87404603.service",
                "source": "systemd",
                "state": "stopped",
                "status": "active"
            },
            "user@.service": {
                "name": "user@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "user@1000.service": {
                "name": "user@1000.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "user@1001.service": {
                "name": "user@1001.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "user@87404603.service": {
                "name": "user@87404603.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "vdi-monitor.service": {
                "name": "vdi-monitor.service",
                "source": "systemd",
                "state": "running",
                "status": "enabled"
            },
            "vncserver@.service": {
                "name": "vncserver@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "indirect"
            },
            "vncserver@:1.service": {
                "name": "vncserver@:1.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "vncserver@:2.service": {
                "name": "vncserver@:2.service",
                "source": "systemd",
                "state": "running",
                "status": "active"
            },
            "wacom-inputattach@.service": {
                "name": "wacom-inputattach@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "wpa_supplicant.service": {
                "name": "wpa_supplicant.service",
                "source": "systemd",
                "state": "inactive",
                "status": "disabled"
            },
            "xvnc@.service": {
                "name": "xvnc@.service",
                "source": "systemd",
                "state": "unknown",
                "status": "static"
            },
            "ypbind.service": {
                "name": "ypbind.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "yppasswdd.service": {
                "name": "yppasswdd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "ypserv.service": {
                "name": "ypserv.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            },
            "ypxfrd.service": {
                "name": "ypxfrd.service",
                "source": "systemd",
                "state": "stopped",
                "status": "not-found"
            }
        }
    },
    "changed": false
}

TASK [vdi_tool : Ensure Docker service is running] *****************************
ok: [localhost] => {
    "changed": false,
    "enabled": true,
    "name": "docker",
    "state": "started",
    "status": {
        "ActiveEnterTimestamp": "Thu 2025-07-24 15:27:29 UTC",
        "ActiveEnterTimestampMonotonic": "259862320",
        "ActiveExitTimestampMonotonic": "0",
        "ActiveState": "active",
        "After": "network-online.target containerd.service sysinit.target systemd-journald.socket basic.target docker.socket firewalld.service time-set.target system.slice nss-lookup.target mount-localssd-raid.service",
        "AllowIsolate": "no",
        "AllowedCPUs": "",
        "AllowedMemoryNodes": "",
        "AmbientCapabilities": "",
        "AssertResult": "yes",
        "AssertTimestamp": "Thu 2025-07-24 15:27:26 UTC",
        "AssertTimestampMonotonic": "257032900",
        "Before": "shutdown.target multi-user.target",
        "BlockIOAccounting": "no",
        "BlockIOWeight": "[not set]",
        "CPUAccounting": "no",
        "CPUAffinity": "",
        "CPUAffinityFromNUMA": "no",
        "CPUQuotaPerSecUSec": "infinity",
        "CPUQuotaPeriodUSec": "infinity",
        "CPUSchedulingPolicy": "0",
        "CPUSchedulingPriority": "0",
        "CPUSchedulingResetOnFork": "no",
        "CPUShares": "[not set]",
        "CPUUsageNSec": "[not set]",
        "CPUWeight": "[not set]",
        "CacheDirectoryMode": "0755",
        "CanFreeze": "yes",
        "CanIsolate": "no",
        "CanReload": "yes",
        "CanStart": "yes",
        "CanStop": "yes",
        "CapabilityBoundingSet": "cap_chown cap_dac_override cap_dac_read_search cap_fowner cap_fsetid cap_kill cap_setgid cap_setuid cap_setpcap cap_linux_immutable cap_net_bind_service cap_net_broadcast cap_net_admin cap_net_raw cap_ipc_lock cap_ipc_owner cap_sys_module cap_sys_rawio cap_sys_chroot cap_sys_ptrace cap_sys_pacct cap_sys_admin cap_sys_boot cap_sys_nice cap_sys_resource cap_sys_time cap_sys_tty_config cap_mknod cap_lease cap_audit_write cap_audit_control cap_setfcap cap_mac_override cap_mac_admin cap_syslog cap_wake_alarm cap_block_suspend cap_audit_read cap_perfmon cap_bpf",
        "CollectMode": "inactive",
        "ConditionResult": "yes",
        "ConditionTimestamp": "Thu 2025-07-24 15:27:26 UTC",
        "ConditionTimestampMonotonic": "257032900",
        "ConfigurationDirectoryMode": "0755",
        "Conflicts": "shutdown.target",
        "ControlGroup": "/system.slice/docker.service",
        "ControlPID": "0",
        "DefaultDependencies": "yes",
        "DefaultMemoryLow": "0",
        "DefaultMemoryMin": "0",
        "Delegate": "yes",
        "DelegateControllers": "cpu cpuacct cpuset io blkio memory devices pids",
        "Description": "Docker Application Container Engine",
        "DevicePolicy": "auto",
        "Documentation": "https://docs.docker.com",
        "DropInPaths": "/etc/systemd/system/docker.service.d/data-root.conf",
        "DynamicUser": "no",
        "EffectiveCPUs": "",
        "EffectiveMemoryNodes": "",
        "ExecMainCode": "0",
        "ExecMainExitTimestampMonotonic": "0",
        "ExecMainPID": "5274",
        "ExecMainStartTimestamp": "Thu 2025-07-24 15:27:26 UTC",
        "ExecMainStartTimestampMonotonic": "257033635",
        "ExecMainStatus": "0",
        "ExecReload": "{ path=/bin/kill ; argv[]=/bin/kill -s HUP $MAINPID ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "ExecStart": "{ path=/usr/bin/dockerd ; argv[]=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }",
        "FailureAction": "none",
        "FileDescriptorStoreMax": "0",
        "FragmentPath": "/usr/lib/systemd/system/docker.service",
        "FreezerState": "running",
        "GID": "[not set]",
        "GuessMainPID": "yes",
        "IOAccounting": "no",
        "IOSchedulingClass": "0",
        "IOSchedulingPriority": "0",
        "IOWeight": "[not set]",
        "IPAccounting": "no",
        "IPEgressBytes": "18446744073709551615",
        "IPEgressPackets": "18446744073709551615",
        "IPIngressBytes": "18446744073709551615",
        "IPIngressPackets": "18446744073709551615",
        "Id": "docker.service",
        "IgnoreOnIsolate": "no",
        "IgnoreSIGPIPE": "yes",
        "InactiveEnterTimestampMonotonic": "0",
        "InactiveExitTimestamp": "Thu 2025-07-24 15:27:26 UTC",
        "InactiveExitTimestampMonotonic": "257033661",
        "InvocationID": "2c563fb7673f41a09f94812ff7281e0d",
        "JobRunningTimeoutUSec": "infinity",
        "JobTimeoutAction": "none",
        "JobTimeoutUSec": "infinity",
        "KeyringMode": "private",
        "KillMode": "process",
        "KillSignal": "15",
        "LimitAS": "infinity",
        "LimitASSoft": "infinity",
        "LimitCORE": "infinity",
        "LimitCORESoft": "infinity",
        "LimitCPU": "infinity",
        "LimitCPUSoft": "infinity",
        "LimitDATA": "infinity",
        "LimitDATASoft": "infinity",
        "LimitFSIZE": "infinity",
        "LimitFSIZESoft": "infinity",
        "LimitLOCKS": "infinity",
        "LimitLOCKSSoft": "infinity",
        "LimitMEMLOCK": "65536",
        "LimitMEMLOCKSoft": "65536",
        "LimitMSGQUEUE": "819200",
        "LimitMSGQUEUESoft": "819200",
        "LimitNICE": "0",
        "LimitNICESoft": "0",
        "LimitNOFILE": "262144",
        "LimitNOFILESoft": "1024",
        "LimitNPROC": "infinity",
        "LimitNPROCSoft": "infinity",
        "LimitRSS": "infinity",
        "LimitRSSSoft": "infinity",
        "LimitRTPRIO": "0",
        "LimitRTPRIOSoft": "0",
        "LimitRTTIME": "infinity",
        "LimitRTTIMESoft": "infinity",
        "LimitSIGPENDING": "127383",
        "LimitSIGPENDINGSoft": "127383",
        "LimitSTACK": "infinity",
        "LimitSTACKSoft": "8388608",
        "LoadState": "loaded",
        "LockPersonality": "no",
        "LogLevelMax": "-1",
        "LogRateLimitBurst": "0",
        "LogRateLimitIntervalUSec": "0",
        "LogsDirectoryMode": "0755",
        "MainPID": "5274",
        "MemoryAccounting": "yes",
        "MemoryCurrent": "31453184",
        "MemoryDenyWriteExecute": "no",
        "MemoryHigh": "infinity",
        "MemoryLimit": "infinity",
        "MemoryLow": "0",
        "MemoryMax": "infinity",
        "MemoryMin": "0",
        "MemorySwapMax": "infinity",
        "MountAPIVFS": "no",
        "MountFlags": "",
        "NFileDescriptorStore": "0",
        "NRestarts": "0",
        "NUMAMask": "",
        "NUMAPolicy": "n/a",
        "Names": "docker.service",
        "NeedDaemonReload": "no",
        "Nice": "0",
        "NoNewPrivileges": "no",
        "NonBlocking": "no",
        "NotifyAccess": "main",
        "OOMScoreAdjust": "-500",
        "OnFailureJobMode": "replace",
        "PermissionsStartOnly": "no",
        "Perpetual": "no",
        "PrivateDevices": "no",
        "PrivateMounts": "no",
        "PrivateNetwork": "no",
        "PrivateTmp": "no",
        "PrivateUsers": "no",
        "ProtectControlGroups": "no",
        "ProtectHome": "no",
        "ProtectKernelModules": "no",
        "ProtectKernelTunables": "no",
        "ProtectSystem": "no",
        "RefuseManualStart": "no",
        "RefuseManualStop": "no",
        "RemainAfterExit": "no",
        "RemoveIPC": "no",
        "Requires": "system.slice sysinit.target docker.socket",
        "Restart": "always",
        "RestartUSec": "2s",
        "RestrictNamespaces": "no",
        "RestrictRealtime": "no",
        "RestrictSUIDSGID": "no",
        "Result": "success",
        "RootDirectoryStartOnly": "no",
        "RuntimeDirectoryMode": "0755",
        "RuntimeDirectoryPreserve": "no",
        "RuntimeMaxUSec": "infinity",
        "SameProcessGroup": "no",
        "SecureBits": "0",
        "SendSIGHUP": "no",
        "SendSIGKILL": "yes",
        "Slice": "system.slice",
        "StandardError": "inherit",
        "StandardInput": "null",
        "StandardInputData": "",
        "StandardOutput": "journal",
        "StartLimitAction": "none",
        "StartLimitBurst": "3",
        "StartLimitIntervalUSec": "1min",
        "StartupBlockIOWeight": "[not set]",
        "StartupCPUShares": "[not set]",
        "StartupCPUWeight": "[not set]",
        "StartupIOWeight": "[not set]",
        "StateChangeTimestamp": "Thu 2025-07-24 15:27:29 UTC",
        "StateChangeTimestampMonotonic": "259862320",
        "StateDirectoryMode": "0755",
        "StatusErrno": "0",
        "StopWhenUnneeded": "no",
        "SubState": "running",
        "SuccessAction": "none",
        "SyslogFacility": "3",
        "SyslogLevel": "6",
        "SyslogLevelPrefix": "yes",
        "SyslogPriority": "30",
        "SystemCallErrorNumber": "0",
        "TTYReset": "no",
        "TTYVHangup": "no",
        "TTYVTDisallocate": "no",
        "TasksAccounting": "yes",
        "TasksCurrent": "10",
        "TasksMax": "infinity",
        "TimeoutStartUSec": "infinity",
        "TimeoutStopUSec": "1min 30s",
        "TimerSlackNSec": "50000",
        "Transient": "no",
        "TriggeredBy": "docker.socket",
        "Type": "notify",
        "UID": "[not set]",
        "UMask": "0022",
        "UnitFilePreset": "disabled",
        "UnitFileState": "enabled",
        "UtmpMode": "init",
        "WantedBy": "multi-user.target",
        "Wants": "network-online.target containerd.service",
        "WatchdogTimestamp": "Thu 2025-07-24 15:27:29 UTC",
        "WatchdogTimestampMonotonic": "259862318",
        "WatchdogUSec": "0"
    }
}

TASK [vdi_tool : Wait for Docker daemon to be ready] ***************************
ok: [localhost] => {
    "changed": false,
    "elapsed": 0,
    "gid": 988,
    "group": "docker",
    "match_groupdict": {},
    "match_groups": [],
    "mode": "0660",
    "owner": "root",
    "path": "/var/run/docker.sock",
    "port": null,
    "search_regex": null,
    "size": 0,
    "state": "file",
    "uid": 0
}

TASK [vdi_tool : Test Docker connectivity] *************************************
changed: [localhost] => {
    "attempts": 1,
    "changed": true,
    "cmd": [
        "docker",
        "version"
    ],
    "delta": "0:00:00.019833",
    "end": "2025-07-24 15:31:01.979111",
    "rc": 0,
    "start": "2025-07-24 15:31:01.959278"
}

STDOUT:

Client: Docker Engine - Community
 Version:           28.3.2
 API version:       1.51
 Go version:        go1.24.5
 Git commit:        578ccf6
 Built:             Wed Jul  9 16:15:41 2025
 OS/Arch:           linux/amd64
 Context:           default

Server: Docker Engine - Community
 Engine:
  Version:          28.3.2
  API version:      1.51 (minimum version 1.24)
  Go version:       go1.24.5
  Git commit:       e77ff99
  Built:            Wed Jul  9 16:14:23 2025
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.7.27
  GitCommit:        05044ec0a9a75232cad458027ca83437aae3f4da
 runc:
  Version:          1.2.5
  GitCommit:        v1.2.5-0-g59923ef
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0

TASK [vdi_tool : Enable pgcrypto extension for initdb] *************************
changed: [localhost] => {
    "changed": true,
    "checksum": "a127ec70504ae55424b5bfdba85a53ce3fe2e710",
    "dest": "/opt/guacamole-db/initdb/00-enable-pgcrypto.sql",
    "gid": 0,
    "group": "root",
    "md5sum": "5759c18ba008c3af3b174a99dfedc20e",
    "mode": "0644",
    "owner": "root",
    "size": 82,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371062.0273864-27523-222276405449246/source",
    "state": "file",
    "uid": 0
}

TASK [vdi_tool : Template per-user Guacamole user SQL] *************************
changed: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "checksum": "11e358d1c93056ca1f3197b5a7aa118878d69048",
    "dest": "/opt/guacamole-db/initdb/02-alice_user.sql",
    "gid": 0,
    "group": "root",
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "md5sum": "2203ca51f69a089f76a44664596df631",
    "mode": "0644",
    "owner": "root",
    "size": 734,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371062.378293-27545-63386938039965/source",
    "state": "file",
    "uid": 0
}
changed: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "checksum": "9eabaa254800e4e435f8c70b918a4a6b428b6fbd",
    "dest": "/opt/guacamole-db/initdb/02-bob_user.sql",
    "gid": 0,
    "group": "root",
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "md5sum": "73275e670b160e53c0acca30b52ae218",
    "mode": "0644",
    "owner": "root",
    "size": 726,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371062.7223604-27545-271943085306166/source",
    "state": "file",
    "uid": 0
}

TASK [vdi_tool : Template per-user SQL for Guacamole connections] **************
changed: [localhost] => (item={'username': 'alice', 'port': 5901, 'password': 'xc61q4jU3mUCo84M', 'vncserver_password': '4JB1YHUQ', 'display_number': 1}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "checksum": "a2f7d7fd0c1e596f84464e301312c00e0fa12a11",
    "dest": "/opt/guacamole-db/initdb/03-alice_connection.sql",
    "gid": 0,
    "group": "root",
    "item": {
        "display_number": 1,
        "password": "xc61q4jU3mUCo84M",
        "port": 5901,
        "username": "alice",
        "vncserver_password": "4JB1YHUQ"
    },
    "md5sum": "7df88ce1ea5f854682df295bfe2e301f",
    "mode": "0644",
    "owner": "root",
    "size": 6583,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371063.081999-27587-195959994230920/source",
    "state": "file",
    "uid": 0
}
changed: [localhost] => (item={'username': 'bob', 'port': 5902, 'secret_name': 'a-password-for-bob', 'password': 'B0bp4ssw0rd123', 'vncserver_password': '7DmxvFp2', 'display_number': 2}) => {
    "ansible_loop_var": "item",
    "changed": true,
    "checksum": "291f5f0588de9e18befd6b849591ee5eab224333",
    "dest": "/opt/guacamole-db/initdb/03-bob_connection.sql",
    "gid": 0,
    "group": "root",
    "item": {
        "display_number": 2,
        "password": "B0bp4ssw0rd123",
        "port": 5902,
        "secret_name": "a-password-for-bob",
        "username": "bob",
        "vncserver_password": "7DmxvFp2"
    },
    "md5sum": "1ae0fd1017d8d23d1acd289524cc7b5c",
    "mode": "0644",
    "owner": "root",
    "size": 6547,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371063.4521995-27587-78729102064992/source",
    "state": "file",
    "uid": 0
}

TASK [vdi_tool : Template user cleanup SQL for removed users] ******************
changed: [localhost] => {
    "changed": true,
    "checksum": "eed1f453966cbb3acf4a3266ca3b5998416a3706",
    "dest": "/opt/guacamole-db/initdb/04-user_cleanup.sql",
    "gid": 0,
    "group": "root",
    "md5sum": "b582c47aac06c808a4bb374e7dbad148",
    "mode": "0644",
    "owner": "root",
    "size": 3166,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371063.8163276-27629-260203219362437/source",
    "state": "file",
    "uid": 0
}

TASK [vdi_tool : Generate combined initdb.sql] *********************************
changed: [localhost] => {
    "changed": true,
    "cmd": "docker run --rm  -v /opt/guacamole-db/initdb:/opt/guacamole-db/initdb  guacamole/guacamole:latest  /opt/guacamole/bin/initdb.sh --postgresql  > /opt/guacamole-db/initdb/01-initdb.sql\n",
    "delta": "0:00:12.451850",
    "end": "2025-07-24 15:31:16.794061",
    "rc": 0,
    "start": "2025-07-24 15:31:04.342211"
}

STDERR:

Unable to find image 'guacamole/guacamole:latest' locally
latest: Pulling from guacamole/guacamole
32f112e3802c: Pulling fs layer
ea8f5ca39c1a: Pulling fs layer
a4f9b8cc7730: Pulling fs layer
4e45d9955da7: Pulling fs layer
59425f3d7529: Pulling fs layer
a875e361a596: Pulling fs layer
4f4fb700ef54: Pulling fs layer
cdbfaaae41bb: Pulling fs layer
f5cb881fc6db: Pulling fs layer
de7057472cfc: Pulling fs layer
7c43b83d031a: Pulling fs layer
8a4673b53887: Pulling fs layer
8630345c18ca: Pulling fs layer
a875e361a596: Waiting
4f4fb700ef54: Waiting
cdbfaaae41bb: Waiting
f5cb881fc6db: Waiting
de7057472cfc: Waiting
7c43b83d031a: Waiting
8a4673b53887: Waiting
8630345c18ca: Waiting
4e45d9955da7: Waiting
59425f3d7529: Waiting
ea8f5ca39c1a: Verifying Checksum
ea8f5ca39c1a: Download complete
32f112e3802c: Verifying Checksum
32f112e3802c: Download complete
4e45d9955da7: Download complete
59425f3d7529: Verifying Checksum
59425f3d7529: Download complete
a875e361a596: Verifying Checksum
a875e361a596: Download complete
4f4fb700ef54: Verifying Checksum
4f4fb700ef54: Download complete
cdbfaaae41bb: Verifying Checksum
cdbfaaae41bb: Download complete
de7057472cfc: Verifying Checksum
de7057472cfc: Download complete
f5cb881fc6db: Verifying Checksum
f5cb881fc6db: Download complete
32f112e3802c: Pull complete
8a4673b53887: Download complete
8630345c18ca: Download complete
ea8f5ca39c1a: Pull complete
a4f9b8cc7730: Verifying Checksum
a4f9b8cc7730: Download complete
7c43b83d031a: Verifying Checksum
7c43b83d031a: Download complete
a4f9b8cc7730: Pull complete
4e45d9955da7: Pull complete
59425f3d7529: Pull complete
a875e361a596: Pull complete
4f4fb700ef54: Pull complete
cdbfaaae41bb: Pull complete
f5cb881fc6db: Pull complete
de7057472cfc: Pull complete
7c43b83d031a: Pull complete
8a4673b53887: Pull complete
8630345c18ca: Pull complete
Digest: sha256:4cec231c1fe46367e1e3da80a12f0f59c48aebde9e6a97cdaf2a8fcf92376b4a
Status: Downloaded newer image for guacamole/guacamole:latest

TASK [vdi_tool : Update guacadmin password hash in 01-initdb.sql] **************
changed: [localhost] => {
    "changed": true,
    "rc": 0
}

MSG:

1 replacements made

TASK [vdi_tool : Remove salt from guacadmin in 01-initdb.sql] ******************
changed: [localhost] => {
    "changed": true,
    "rc": 0
}

MSG:

1 replacements made

TASK [vdi_tool : Pull required Docker images] **********************************
changed: [localhost] => (item=postgres:latest) => {
    "ansible_loop_var": "item",
    "changed": true,
    "cmd": [
        "docker",
        "pull",
        "postgres:latest"
    ],
    "delta": "0:00:05.944704",
    "end": "2025-07-24 15:31:23.396321",
    "item": "postgres:latest",
    "rc": 0,
    "start": "2025-07-24 15:31:17.451617"
}

STDOUT:

latest: Pulling from library/postgres
59e22667830b: Pulling fs layer
c2922dd5c76b: Pulling fs layer
28b0f0abf5b3: Pulling fs layer
a623957f847d: Pulling fs layer
bfabbcdba989: Pulling fs layer
0e5bba37029a: Pulling fs layer
1ed9ff0b5160: Pulling fs layer
06b2fd76987c: Pulling fs layer
9e482b60495e: Pulling fs layer
4a43c57a903d: Pulling fs layer
dcce1c0b58a8: Pulling fs layer
38072b29d55e: Pulling fs layer
d98e5494f240: Pulling fs layer
017403a0b5e1: Pulling fs layer
0e5bba37029a: Waiting
1ed9ff0b5160: Waiting
06b2fd76987c: Waiting
9e482b60495e: Waiting
4a43c57a903d: Waiting
dcce1c0b58a8: Waiting
38072b29d55e: Waiting
d98e5494f240: Waiting
017403a0b5e1: Waiting
a623957f847d: Waiting
bfabbcdba989: Waiting
c2922dd5c76b: Verifying Checksum
c2922dd5c76b: Download complete
28b0f0abf5b3: Verifying Checksum
28b0f0abf5b3: Download complete
a623957f847d: Verifying Checksum
a623957f847d: Download complete
59e22667830b: Verifying Checksum
59e22667830b: Download complete
bfabbcdba989: Verifying Checksum
bfabbcdba989: Download complete
0e5bba37029a: Verifying Checksum
0e5bba37029a: Download complete
1ed9ff0b5160: Verifying Checksum
1ed9ff0b5160: Download complete
06b2fd76987c: Verifying Checksum
06b2fd76987c: Download complete
4a43c57a903d: Verifying Checksum
4a43c57a903d: Download complete
dcce1c0b58a8: Download complete
38072b29d55e: Download complete
d98e5494f240: Verifying Checksum
d98e5494f240: Download complete
59e22667830b: Pull complete
c2922dd5c76b: Pull complete
017403a0b5e1: Verifying Checksum
017403a0b5e1: Download complete
28b0f0abf5b3: Pull complete
a623957f847d: Pull complete
bfabbcdba989: Pull complete
0e5bba37029a: Pull complete
1ed9ff0b5160: Pull complete
06b2fd76987c: Pull complete
9e482b60495e: Verifying Checksum
9e482b60495e: Download complete
9e482b60495e: Pull complete
4a43c57a903d: Pull complete
dcce1c0b58a8: Pull complete
38072b29d55e: Pull complete
d98e5494f240: Pull complete
017403a0b5e1: Pull complete
Digest: sha256:4d89c904835259bc58876520e56267ca07a4ebd6a027f7814bbbf91b50d685be
Status: Downloaded newer image for postgres:latest
docker.io/library/postgres:latest
changed: [localhost] => (item=guacamole/guacd:latest) => {
    "ansible_loop_var": "item",
    "changed": true,
    "cmd": [
        "docker",
        "pull",
        "guacamole/guacd:latest"
    ],
    "delta": "0:00:04.829341",
    "end": "2025-07-24 15:31:28.396327",
    "item": "guacamole/guacd:latest",
    "rc": 0,
    "start": "2025-07-24 15:31:23.566986"
}

STDOUT:

latest: Pulling from guacamole/guacd
44cf07d57ee4: Pulling fs layer
2c7959c3f8de: Pulling fs layer
d977524fd227: Pulling fs layer
26483f1a0b5c: Pulling fs layer
e2df05816112: Pulling fs layer
596f1cdf21db: Pulling fs layer
26483f1a0b5c: Waiting
596f1cdf21db: Waiting
e2df05816112: Waiting
2c7959c3f8de: Download complete
44cf07d57ee4: Download complete
44cf07d57ee4: Pull complete
26483f1a0b5c: Verifying Checksum
26483f1a0b5c: Download complete
e2df05816112: Verifying Checksum
e2df05816112: Download complete
2c7959c3f8de: Pull complete
596f1cdf21db: Verifying Checksum
596f1cdf21db: Download complete
d977524fd227: Download complete
d977524fd227: Pull complete
26483f1a0b5c: Pull complete
e2df05816112: Pull complete
596f1cdf21db: Pull complete
Digest: sha256:f70aa3356d1ae6ba7cff608309684c1736c7ae7b2b2e201e8e29281f2591227f
Status: Downloaded newer image for guacamole/guacd:latest
docker.io/guacamole/guacd:latest
changed: [localhost] => (item=guacamole/guacamole:latest) => {
    "ansible_loop_var": "item",
    "changed": true,
    "cmd": [
        "docker",
        "pull",
        "guacamole/guacamole:latest"
    ],
    "delta": "0:00:00.359246",
    "end": "2025-07-24 15:31:28.927638",
    "item": "guacamole/guacamole:latest",
    "rc": 0,
    "start": "2025-07-24 15:31:28.568392"
}

STDOUT:

latest: Pulling from guacamole/guacamole
Digest: sha256:4cec231c1fe46367e1e3da80a12f0f59c48aebde9e6a97cdaf2a8fcf92376b4a
Status: Image is up to date for guacamole/guacamole:latest
docker.io/guacamole/guacamole:latest

TASK [vdi_tool : Create a dedicated Docker network] ****************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "network",
        "create",
        "guac_net"
    ],
    "delta": "0:00:00.062475",
    "end": "2025-07-24 15:31:29.181269",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:31:29.118794"
}

STDOUT:

e0275c25416d70f991c99ebe7fb8ee8b8ca67ff902b5ea23f21f58461ec48bff

TASK [vdi_tool : Start Guacamole PostgreSQL container] *************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "run",
        "-d",
        "--name",
        "guac_db",
        "--network",
        "guac_net",
        "-e",
        "POSTGRES_USER=guacamole_db",
        "-e",
        "POSTGRES_PASSWORD=H95L0yeLji7pzjDCOuemJDzEwoASP7Nq",
        "-e",
        "POSTGRES_DB=guacamole_db",
        "-v",
        "/opt/guacamole-db/data:/var/lib/postgresql/data",
        "-v",
        "/opt/guacamole-db/initdb:/docker-entrypoint-initdb.d",
        "--restart",
        "always",
        "postgres:latest"
    ],
    "delta": "0:00:07.462040",
    "end": "2025-07-24 15:31:36.839313",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:31:29.377273"
}

STDOUT:

7f665322894de32870a3505d6da6ae46f83ea5d228a347e7ea1a71240c15015e

TASK [vdi_tool : Wait for PostgreSQL container to be ready] ********************
fatal: [localhost]: FAILED! => {
    "changed": false,
    "elapsed": 60
}

MSG:

Timeout when waiting for 127.0.0.1:5432
...ignoring

TASK [vdi_tool : Wait for PostgreSQL via Docker exec] **************************
changed: [localhost] => {
    "attempts": 1,
    "changed": true,
    "cmd": [
        "docker",
        "exec",
        "guac_db",
        "pg_isready",
        "-U",
        "guacamole_db"
    ],
    "delta": "0:00:00.088759",
    "end": "2025-07-24 15:32:37.343504",
    "rc": 0,
    "start": "2025-07-24 15:32:37.254745"
}

STDOUT:

/var/run/postgresql:5432 - accepting connections

TASK [vdi_tool : Check if database needs re-initialization due to user changes] ***
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "docker",
        "exec",
        "guac_db",
        "psql",
        "-U",
        "guacamole_db",
        "-d",
        "guacamole_db",
        "-c",
        "SELECT COUNT(*) FROM guacamole_entity WHERE type='USER' AND name != 'guacadmin';"
    ],
    "delta": "0:00:00.083631",
    "end": "2025-07-24 15:32:37.618923",
    "rc": 0,
    "start": "2025-07-24 15:32:37.535292"
}

STDOUT:

 count
-------
     2
(1 row)

TASK [vdi_tool : Debug user configuration status] ******************************
ok: [localhost] => {}

MSG:

Database user check: count
-------
     2
(1 row)
Current users in config: 2
Lock file exists: True
User secrets hash changed: True
User secrets hash (stored): none
User secrets hash (current): 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6


TASK [vdi_tool : Check if user configuration has changed] **********************
ok: [localhost] => {
    "ansible_facts": {
        "users_changed": true
    },
    "changed": false
}

TASK [vdi_tool : Debug user change detection] **********************************
ok: [localhost] => {}

MSG:

Users changed: True

TASK [vdi_tool : Stop Guacamole containers] ************************************
fatal: [localhost]: FAILED! => {
    "changed": true,
    "cmd": [
        "docker",
        "stop",
        "guac_app",
        "guacd"
    ],
    "delta": "0:00:00.013660",
    "end": "2025-07-24 15:32:37.908714",
    "rc": 1,
    "start": "2025-07-24 15:32:37.895054"
}

STDERR:

Error response from daemon: No such container: guac_app
Error response from daemon: No such container: guacd


MSG:

non-zero return code
...ignoring

TASK [vdi_tool : Remove Guacamole containers] **********************************
fatal: [localhost]: FAILED! => {
    "changed": true,
    "cmd": [
        "docker",
        "rm",
        "guac_app",
        "guacd"
    ],
    "delta": "0:00:00.012838",
    "end": "2025-07-24 15:32:38.111949",
    "rc": 1,
    "start": "2025-07-24 15:32:38.099111"
}

STDERR:

Error response from daemon: No such container: guac_app
Error response from daemon: No such container: guacd


MSG:

non-zero return code
...ignoring

TASK [vdi_tool : Stop and remove PostgreSQL container] *************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "stop",
        "guac_db"
    ],
    "delta": "0:00:00.134068",
    "end": "2025-07-24 15:32:38.439413",
    "rc": 0,
    "start": "2025-07-24 15:32:38.305345"
}

STDOUT:

guac_db

TASK [vdi_tool : Remove PostgreSQL container] **********************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "rm",
        "guac_db"
    ],
    "delta": "0:00:00.018178",
    "end": "2025-07-24 15:32:38.655370",
    "rc": 0,
    "start": "2025-07-24 15:32:38.637192"
}

STDOUT:

guac_db

TASK [vdi_tool : Backup existing database data] ********************************
fatal: [localhost]: FAILED! => {
    "changed": true,
    "cmd": [
        "tar",
        "-czf",
        "/opt/guacamole-db/backup-$(date",
        "+%Y%m%d-%H%M%S).tar.gz",
        "-C",
        "/opt/guacamole-db",
        "data/"
    ],
    "delta": "0:00:00.927459",
    "end": "2025-07-24 15:32:39.776351",
    "rc": 2,
    "start": "2025-07-24 15:32:38.848892"
}

STDERR:

tar: +%Y%m%d-%H%M%S).tar.gz: Cannot stat: No such file or directory
tar: Exiting with failure status due to previous errors


MSG:

non-zero return code
...ignoring

TASK [vdi_tool : Remove existing database data] ********************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "rm",
        "-rf",
        "/opt/guacamole-db/data/*"
    ],
    "delta": "0:00:00.002506",
    "end": "2025-07-24 15:32:39.973183",
    "rc": 0,
    "start": "2025-07-24 15:32:39.970677"
}

TASK [vdi_tool : Start Guacamole PostgreSQL container (re-initialized)] ********
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "run",
        "-d",
        "--name",
        "guac_db",
        "--network",
        "guac_net",
        "-e",
        "POSTGRES_USER=guacamole_db",
        "-e",
        "POSTGRES_PASSWORD=H95L0yeLji7pzjDCOuemJDzEwoASP7Nq",
        "-e",
        "POSTGRES_DB=guacamole_db",
        "-v",
        "/opt/guacamole-db/data:/var/lib/postgresql/data",
        "-v",
        "/opt/guacamole-db/initdb:/docker-entrypoint-initdb.d",
        "--restart",
        "always",
        "postgres:latest"
    ],
    "delta": "0:00:00.214960",
    "end": "2025-07-24 15:32:40.389033",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:32:40.174073"
}

STDOUT:

f5711132145daa089efb4d0a763437ab81d2f13cdde1644b2472b45869dd4c81

TASK [vdi_tool : Wait for PostgreSQL to be ready after re-initialization] ******
changed: [localhost] => {
    "attempts": 1,
    "changed": true,
    "cmd": [
        "docker",
        "exec",
        "guac_db",
        "pg_isready",
        "-U",
        "guacamole_db"
    ],
    "delta": "0:00:00.084157",
    "end": "2025-07-24 15:32:40.671774",
    "rc": 0,
    "start": "2025-07-24 15:32:40.587617"
}

STDOUT:

/var/run/postgresql:5432 - accepting connections

TASK [vdi_tool : Start guacd container] ****************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "run",
        "-d",
        "--name",
        "guacd",
        "--network",
        "guac_net",
        "-p",
        "4822:4822",
        "--restart",
        "always",
        "guacamole/guacd:latest"
    ],
    "delta": "0:00:00.199585",
    "end": "2025-07-24 15:32:41.064927",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:32:40.865342"
}

STDOUT:

809f2c58fa7ebb5c36b56d14a529a6261f8fe3e30e1b6993d36b92d9cf905269

TASK [vdi_tool : Start Guacamole webapp container] *****************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "docker",
        "run",
        "-d",
        "--name",
        "guac_app",
        "--network",
        "guac_net",
        "-p",
        "8081:8080",
        "-e",
        "POSTGRES_HOSTNAME=guac_db",
        "-e",
        "POSTGRES_PORT=5432",
        "-e",
        "POSTGRES_DATABASE=guacamole_db",
        "-e",
        "POSTGRES_USER=guacamole_db",
        "-e",
        "POSTGRES_PASSWORD=H95L0yeLji7pzjDCOuemJDzEwoASP7Nq",
        "-e",
        "POSTGRES_AUTO_CREATE_ACCOUNTS=true",
        "-e",
        "GUACD_HOSTNAME=guacd",
        "-e",
        "GUACD_PORT=4822",
        "--restart",
        "always",
        "guacamole/guacamole:latest"
    ],
    "delta": "0:00:00.203470",
    "end": "2025-07-24 15:32:41.469743",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:32:41.266273"
}

STDOUT:

671a01e330bf70d61b6a5aa26d573704e651f02a8b292abd5a8fb656bd885675

TASK [vdi_tool : Debug container status before waiting for Guacamole] **********
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "docker",
        "ps"
    ],
    "delta": "0:00:00.015784",
    "end": "2025-07-24 15:32:41.680190",
    "rc": 0,
    "start": "2025-07-24 15:32:41.664406"
}

STDOUT:

CONTAINER ID   IMAGE                        COMMAND                  CREATED                  STATUS                                     PORTS                                         NAMES
671a01e330bf   guacamole/guacamole:latest   "/opt/guacamole/bin/…"   Less than a second ago   Up Less than a second                      0.0.0.0:8081->8080/tcp, [::]:8081->8080/tcp   guac_app
809f2c58fa7e   guacamole/guacd:latest       "/opt/guacamole/entr…"   1 second ago             Up Less than a second (health: starting)   0.0.0.0:4822->4822/tcp, [::]:4822->4822/tcp   guacd
f5711132145d   postgres:latest              "docker-entrypoint.s…"   1 second ago             Up 1 second                                5432/tcp                                      guac_db

TASK [vdi_tool : Show container status] ****************************************
ok: [localhost] => {}

MSG:

CONTAINER ID   IMAGE                        COMMAND                  CREATED                  STATUS                                     PORTS                                         NAMES
671a01e330bf   guacamole/guacamole:latest   "/opt/guacamole/bin/…"   Less than a second ago   Up Less than a second                      0.0.0.0:8081->8080/tcp, [::]:8081->8080/tcp   guac_app
809f2c58fa7e   guacamole/guacd:latest       "/opt/guacamole/entr…"   1 second ago             Up Less than a second (health: starting)   0.0.0.0:4822->4822/tcp, [::]:4822->4822/tcp   guacd
f5711132145d   postgres:latest              "docker-entrypoint.s…"   1 second ago             Up 1 second                                5432/tcp                                      guac_db

TASK [vdi_tool : Wait for Guacamole HTTP endpoint] *****************************
ok: [localhost] => {
    "changed": false,
    "elapsed": 2,
    "match_groupdict": {},
    "match_groups": [],
    "path": null,
    "port": 8081,
    "search_regex": null,
    "state": "started"
}

TASK [vdi_tool : Check Guacamole UI is up] *************************************
ok: [localhost] => {
    "accept_ranges": "bytes",
    "attempts": 1,
    "cache_control": "no-cache",
    "changed": false,
    "connection": "close",
    "content_length": "2811",
    "content_type": "text/html",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:32:45 GMT",
    "elapsed": 0,
    "etag": "W/\"2811-1753318742000\"",
    "last_modified": "Thu, 24 Jul 2025 00:59:02 GMT",
    "pragma": "no-cache",
    "redirected": false,
    "status": 200,
    "url": "http://localhost:8081/guacamole/"
}

MSG:

OK (2811 bytes)

TASK [vdi_tool : Obtain Guacamole API token to verify login] *******************
ok: [localhost] => {
    "attempts": 1,
    "changed": false,
    "connection": "close",
    "content": "{\"authToken\":\"0D1A88B239CAB8F2BB454E77803481AA313179A99217A10E06963CAFFC219737\",\"username\":\"guacadmin\",\"dataSource\":\"postgresql\",\"availableDataSources\":[\"postgresql\",\"postgresql-shared\"]}",
    "content_length": "187",
    "content_type": "application/json",
    "cookies": {},
    "cookies_string": "",
    "date": "Thu, 24 Jul 2025 15:32:45 GMT",
    "elapsed": 0,
    "json": {
        "authToken": "0D1A88B239CAB8F2BB454E77803481AA313179A99217A10E06963CAFFC219737",
        "availableDataSources": [
            "postgresql",
            "postgresql-shared"
        ],
        "dataSource": "postgresql",
        "username": "guacadmin"
    },
    "redirected": false,
    "status": 200,
    "url": "http://localhost:8081/guacamole/api/tokens"
}

MSG:

OK (187 bytes)

TASK [vdi_tool : Remove bootstrap SQL files unless debug is enabled] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not debug | default(false)",
    "skip_reason": "Conditional result was False"
}

TASK [vdi_tool : Install NoMachine] ********************************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "vdi_tool | lower == 'nomachine'",
    "skip_reason": "Conditional result was False"
}

TASK [vdi_tool : Install Workspot] *********************************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "vdi_tool | lower == 'workspot'",
    "skip_reason": "Conditional result was False"
}

TASK [vdi_tool : Set current role for lock manager completion] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_role": "vdi_tool",
        "role_completed": true
    },
    "changed": false
}

TASK [lock_manager : Debug create lock operation] ******************************
ok: [localhost] => {}

MSG:

Creating/updating lock file for role: vdi_tool

TASK [lock_manager : Check if lock file exists] ********************************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753371032.8846393,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "542bc16243f6f0f5bd20bfbc7c7d0ae70dfc3965",
        "ctime": 1753371032.652622,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 419489989,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753371032.49061,
        "nlink": 1,
        "path": "/opt/vdi-setup/.vdi-lock.yaml",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 1066,
        "uid": 0,
        "version": "68461029",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug lock file existence] ********************************
ok: [localhost] => {}

MSG:

Lock file exists: True

TASK [lock_manager : Create initial lock file structure] ***********************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not lock_file_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Debug lock file creation] *********************************
skipping: [localhost] => {
    "false_condition": "debug | default(false) and not lock_file_stat.stat.exists"
}

TASK [lock_manager : Load existing lock file data] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "vdi_setup_status": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "ansible_included_var_files": [
        "/opt/vdi-setup/.vdi-lock.yaml"
    ],
    "changed": false
}

TASK [lock_manager : Get current lock data] ************************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update deployment hash] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:30:30Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current timestamp] ************************************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "date",
        "-u",
        "+%Y-%m-%dT%H:%M:%SZ"
    ],
    "delta": "0:00:00.002389",
    "end": "2025-07-24 15:32:46.698118",
    "rc": 0,
    "start": "2025-07-24 15:32:46.695729"
}

STDOUT:

2025-07-24T15:32:46Z

TASK [lock_manager : Update last updated timestamp] ****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:30:30Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user secrets status] **************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets": {
            "last_secret_check": "2025-07-24T15:30:30Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Create user secrets update] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "user_secrets_update": {
            "last_secret_check": "2025-07-24T15:32:46Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6"
        }
    },
    "changed": false
}

TASK [lock_manager : Update user secrets hash] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets": {
            "last_secret_check": "2025-07-24T15:32:46Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user secrets update] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": false
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:32:46Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Create role status entry] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "role_status_entry": {
            "completed": true,
            "completed_at": "2025-07-24T15:32:46Z"
        }
    },
    "changed": false
}

TASK [lock_manager : Debug role status entry] **********************************
ok: [localhost] => {}

MSG:

Role status entry for vdi_tool:
  - completed: True
  - completed_at: 2025-07-24T15:32:46Z


TASK [lock_manager : Debug current lock data before role update] ***************
ok: [localhost] => {}

MSG:

Current lock data before updating vdi_tool:
  - current_lock_data: completed_roles:
    base_os:
        completed: true
        completed_at: '2025-07-24T15:29:50Z'
    lock_manager:
        completed: true
        completed_at: '2025-07-24T15:27:44Z'
    secret_manager:
        completed: true
        completed_at: '2025-07-24T15:30:03Z'
    user_provision:
        completed: true
        completed_at: '2025-07-24T15:30:16Z'
    vdi_tool:
        completed: false
    vnc:
        completed: true
        completed_at: '2025-07-24T15:30:30Z'
created_at: '2025-07-24T15:27:41Z'
deployment_hash: 4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab
deployment_name: vdi-test-scott
force_rerun: false
last_updated: '2025-07-24T15:32:46Z'
lock_version: '1.0'
setup_status: configuring
user_management:
    current_users:
    - alice
    - bob
    previous_users:
    - alice
    - bob
    removed_users: []
user_secrets_status:
    last_secret_check: '2025-07-24T15:32:46Z'
    user_secrets_hash: 6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6
    users_updated:
    - alice
    - bob

  - current_completed_roles: base_os:
    completed: true
    completed_at: '2025-07-24T15:29:50Z'
lock_manager:
    completed: true
    completed_at: '2025-07-24T15:27:44Z'
secret_manager:
    completed: true
    completed_at: '2025-07-24T15:30:03Z'
user_provision:
    completed: true
    completed_at: '2025-07-24T15:30:16Z'
vdi_tool:
    completed: false
vnc:
    completed: true
    completed_at: '2025-07-24T15:30:30Z'

  - role_completed: True
  - current_role: vdi_tool


TASK [lock_manager : Get current completed roles] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:16Z"
            },
            "vdi_tool": {
                "completed": false
            },
            "vnc": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:30Z"
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update completed roles] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_completed_roles": {
            "base_os": {
                "completed": true,
                "completed_at": "2025-07-24T15:29:50Z"
            },
            "lock_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:27:44Z"
            },
            "secret_manager": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:03Z"
            },
            "user_provision": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:16Z"
            },
            "vdi_tool": {
                "completed": true,
                "completed_at": "2025-07-24T15:32:46Z"
            },
            "vnc": {
                "completed": true,
                "completed_at": "2025-07-24T15:30:30Z"
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Update lock data with completed roles] ********************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:32:46Z"
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:32:46Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug updated lock data after role update] ****************
ok: [localhost] => {}

MSG:

Updated lock data after updating vdi_tool:
  - current_role: vdi_tool
  - role_completed: True
  - completed_roles: {'base_os': {'completed': True, 'completed_at': '2025-07-24T15:29:50Z'}, 'lock_manager': {'completed': True, 'completed_at': '2025-07-24T15:27:44Z'}, 'secret_manager': {'completed': True, 'completed_at': '2025-07-24T15:30:03Z'}, 'user_provision': {'completed': True, 'completed_at': '2025-07-24T15:30:16Z'}, 'vdi_tool': {'completed': True, 'completed_at': '2025-07-24T15:32:46Z'}, 'vnc': {'completed': True, 'completed_at': '2025-07-24T15:30:30Z'}}


TASK [lock_manager : Get current users updated list] ***************************
ok: [localhost] => {
    "ansible_facts": {
        "current_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Get new usernames list] ***********************************
ok: [localhost] => {
    "ansible_facts": {
        "new_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Combine users updated lists] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "combined_users_updated": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Debug user deduplication] *********************************
ok: [localhost] => {}

MSG:

User deduplication for vdi_tool:
  - current_users_updated: ['alice', 'bob']
  - new_usernames: ['alice', 'bob']
  - combined_users_updated: ['alice', 'bob']


TASK [lock_manager : Get current user secrets for list update] *****************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_secrets_for_list": {
            "last_secret_check": "2025-07-24T15:32:46Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Update users updated list] ********************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_secrets_with_list": {
            "last_secret_check": "2025-07-24T15:32:46Z",
            "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
            "users_updated": [
                "alice",
                "bob"
            ]
        }
    },
    "changed": false
}

TASK [lock_manager : Apply users updated list] *********************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:32:46Z"
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:32:46Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Get current user management data] *************************
ok: [localhost] => {
    "ansible_facts": {
        "current_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Get current usernames list] *******************************
ok: [localhost] => {
    "ansible_facts": {
        "current_usernames": [
            "alice",
            "bob"
        ]
    },
    "changed": false
}

TASK [lock_manager : Update user management data] ******************************
ok: [localhost] => {
    "ansible_facts": {
        "updated_user_management": {
            "current_users": [
                "alice",
                "bob"
            ],
            "previous_users": [
                "alice",
                "bob"
            ],
            "removed_users": []
        }
    },
    "changed": false
}

TASK [lock_manager : Apply user management update] *****************************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:32:46Z"
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "configuring",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:32:46Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug user management] ************************************
ok: [localhost] => {}

MSG:

User management for vdi_tool:
  - current_users: ['alice', 'bob']
  - previous_users: ['alice', 'bob']
  - removed_users: []


TASK [lock_manager : Check if all roles are completed] *************************
ok: [localhost] => {
    "ansible_facts": {
        "all_roles_completed": true
    },
    "changed": false
}

TASK [lock_manager : Update setup status based on completion] ******************
ok: [localhost] => {
    "ansible_facts": {
        "current_lock_data": {
            "completed_roles": {
                "base_os": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:29:50Z"
                },
                "lock_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:27:44Z"
                },
                "secret_manager": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:03Z"
                },
                "user_provision": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:16Z"
                },
                "vdi_tool": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:32:46Z"
                },
                "vnc": {
                    "completed": true,
                    "completed_at": "2025-07-24T15:30:30Z"
                }
            },
            "created_at": "2025-07-24T15:27:41Z",
            "deployment_hash": "4d7bbe69940a9da1aae5b3acad02ad140e47a546d53111fb6e9b65e460d11aab",
            "deployment_name": "vdi-test-scott",
            "force_rerun": false,
            "last_updated": "2025-07-24T15:32:46Z",
            "lock_version": "1.0",
            "setup_status": "available",
            "user_management": {
                "current_users": [
                    "alice",
                    "bob"
                ],
                "previous_users": [
                    "alice",
                    "bob"
                ],
                "removed_users": []
            },
            "user_secrets_status": {
                "last_secret_check": "2025-07-24T15:32:46Z",
                "user_secrets_hash": "6a6a02d3d09933ca282ae2b02336343c9d73701e45bd81475fbd92dcf9d2f3b6",
                "users_updated": [
                    "alice",
                    "bob"
                ]
            }
        }
    },
    "changed": false
}

TASK [lock_manager : Debug setup status update] ********************************
ok: [localhost] => {}

MSG:

Setup status update:
  - all_roles_completed: True
  - setup_status: available
  - completed_roles_count: 6
  - total_roles_count: 6


TASK [lock_manager : Write updated lock file] **********************************
changed: [localhost] => {
    "changed": true,
    "checksum": "fc55f0f0719e0f714591e3a785b23088e4370d6b",
    "dest": "/opt/vdi-setup/.vdi-lock.yaml",
    "gid": 0,
    "group": "root",
    "md5sum": "023467ccf639a5ab5102d3857dac0237",
    "mode": "0644",
    "owner": "root",
    "size": 1106,
    "src": "/root/.ansible/tmp/ansible-tmp-1753371167.8426328-29425-109328817609540/source",
    "state": "file",
    "uid": 0
}

TASK [lock_manager : Debug VM metadata update] *********************************
ok: [localhost] => {}

MSG:

VM metadata update info:
  - hostname: vdi-test-scott-rocky-0
  - zone: us-central1-a
  - lock_file_changed: True


TASK [lock_manager : Get lock file content as base64] **************************
changed: [localhost] => {
    "changed": true,
    "cmd": "cat /opt/vdi-setup/.vdi-lock.yaml | base64 -w 0",
    "delta": "0:00:00.003891",
    "end": "2025-07-24 15:32:48.398036",
    "rc": 0,
    "start": "2025-07-24 15:32:48.394145"
}

STDOUT:

dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjMyOjQ2WicKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MzBaJwogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMjo0NlonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogYXZhaWxhYmxlCiAgdXNlcl9tYW5hZ2VtZW50OgogICAgY3VycmVudF91c2VyczoKICAgIC0gYWxpY2UKICAgIC0gYm9iCiAgICBwcmV2aW91c191c2VyczoKICAgIC0gYWxpY2UKICAgIC0gYm9iCiAgICByZW1vdmVkX3VzZXJzOiBbXQogIHVzZXJfc2VjcmV0c19zdGF0dXM6CiAgICBsYXN0X3NlY3JldF9jaGVjazogJzIwMjUtMDctMjRUMTU6MzI6NDZaJwogICAgdXNlcl9zZWNyZXRzX2hhc2g6IDZhNmEwMmQzZDA5OTMzY2EyODJhZTJiMDIzMzYzNDNjOWQ3MzcwMWU0NWJkODE0NzVmYmQ5MmRjZjlkMmYzYjYKICAgIHVzZXJzX3VwZGF0ZWQ6CiAgICAtIGFsaWNlCiAgICAtIGJvYgo=

TASK [lock_manager : Add VDI lock file content to VM metadata] *****************
changed: [localhost] => {
    "changed": true,
    "cmd": [
        "gcloud",
        "compute",
        "instances",
        "add-metadata",
        "vdi-test-scott-rocky-0",
        "--metadata",
        "vdi-lock-content=dmRpX3NldHVwX3N0YXR1czoKICBjb21wbGV0ZWRfcm9sZXM6CiAgICBiYXNlX29zOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNToyOTo1MFonCiAgICBsb2NrX21hbmFnZXI6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQ0WicKICAgIHNlY3JldF9tYW5hZ2VyOgogICAgICBjb21wbGV0ZWQ6IHRydWUKICAgICAgY29tcGxldGVkX2F0OiAnMjAyNS0wNy0yNFQxNTozMDowM1onCiAgICB1c2VyX3Byb3Zpc2lvbjoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MTZaJwogICAgdmRpX3Rvb2w6CiAgICAgIGNvbXBsZXRlZDogdHJ1ZQogICAgICBjb21wbGV0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjMyOjQ2WicKICAgIHZuYzoKICAgICAgY29tcGxldGVkOiB0cnVlCiAgICAgIGNvbXBsZXRlZF9hdDogJzIwMjUtMDctMjRUMTU6MzA6MzBaJwogIGNyZWF0ZWRfYXQ6ICcyMDI1LTA3LTI0VDE1OjI3OjQxWicKICBkZXBsb3ltZW50X2hhc2g6IDRkN2JiZTY5OTQwYTlkYTFhYWU1YjNhY2FkMDJhZDE0MGU0N2E1NDZkNTMxMTFmYjZlOWI2NWU0NjBkMTFhYWIKICBkZXBsb3ltZW50X25hbWU6IHZkaS10ZXN0LXNjb3R0CiAgZm9yY2VfcmVydW46IGZhbHNlCiAgbGFzdF91cGRhdGVkOiAnMjAyNS0wNy0yNFQxNTozMjo0NlonCiAgbG9ja192ZXJzaW9uOiAnMS4wJwogIHNldHVwX3N0YXR1czogYXZhaWxhYmxlCiAgdXNlcl9tYW5hZ2VtZW50OgogICAgY3VycmVudF91c2VyczoKICAgIC0gYWxpY2UKICAgIC0gYm9iCiAgICBwcmV2aW91c191c2VyczoKICAgIC0gYWxpY2UKICAgIC0gYm9iCiAgICByZW1vdmVkX3VzZXJzOiBbXQogIHVzZXJfc2VjcmV0c19zdGF0dXM6CiAgICBsYXN0X3NlY3JldF9jaGVjazogJzIwMjUtMDctMjRUMTU6MzI6NDZaJwogICAgdXNlcl9zZWNyZXRzX2hhc2g6IDZhNmEwMmQzZDA5OTMzY2EyODJhZTJiMDIzMzYzNDNjOWQ3MzcwMWU0NWJkODE0NzVmYmQ5MmRjZjlkMmYzYjYKICAgIHVzZXJzX3VwZGF0ZWQ6CiAgICAtIGFsaWNlCiAgICAtIGJvYgo=",
        "--zone=us-central1-a"
    ],
    "delta": "0:00:04.026047",
    "end": "2025-07-24 15:32:52.625449",
    "failed_when_result": false,
    "rc": 0,
    "start": "2025-07-24 15:32:48.599402"
}

STDERR:

Updated [https://www.googleapis.com/compute/v1/projects/hpc-discovery-external/zones/us-central1-a/instances/vdi-test-scott-rocky-0].

TASK [lock_manager : Debug lock file write] ************************************
ok: [localhost] => {}

MSG:

Lock file written: True

TASK [lock_manager : Verify lock file integrity] *******************************
ok: [localhost] => {
    "changed": false,
    "cmd": [
        "python3",
        "-c",
        "import yaml; yaml.safe_load(open('/opt/vdi-setup/.vdi-lock.yaml'))"
    ],
    "delta": "0:00:00.040826",
    "end": "2025-07-24 15:32:52.906476",
    "rc": 0,
    "start": "2025-07-24 15:32:52.865650"
}

TASK [lock_manager : Debug lock file validation] *******************************
ok: [localhost] => {}

MSG:

Lock file validation: True

TASK [lock_manager : Check if VDI monitor service exists] **********************
ok: [localhost] => {
    "changed": false,
    "stat": {
        "atime": 1753370874.1548011,
        "attr_flags": "",
        "attributes": [],
        "block_size": 4096,
        "blocks": 8,
        "charset": "us-ascii",
        "checksum": "f6de22707f8d9248014f679a2f1930451e2bf635",
        "ctime": 1753370872.6256874,
        "dev": 2050,
        "device_type": 0,
        "executable": false,
        "exists": true,
        "gid": 0,
        "gr_name": "root",
        "inode": 285214140,
        "isblk": false,
        "ischr": false,
        "isdir": false,
        "isfifo": false,
        "isgid": false,
        "islnk": false,
        "isreg": true,
        "issock": false,
        "isuid": false,
        "mimetype": "text/plain",
        "mode": "0644",
        "mtime": 1753370872.4766762,
        "nlink": 1,
        "path": "/etc/systemd/system/vdi-monitor.service",
        "pw_name": "root",
        "readable": true,
        "rgrp": true,
        "roth": true,
        "rusr": true,
        "size": 283,
        "uid": 0,
        "version": "1338188335",
        "wgrp": false,
        "woth": false,
        "writeable": true,
        "wusr": true,
        "xgrp": false,
        "xoth": false,
        "xusr": false
    }
}

TASK [lock_manager : Debug VDI monitor setup conditions] ***********************
ok: [localhost] => {}

MSG:

VDI monitor setup conditions:
  - current_role: vdi_tool
  - vdi_monitor_service_exists: True
  - lock_file_creation.changed: False
  - will_setup_monitor: False


TASK [lock_manager : Setup VDI monitoring service (first time only)] ***********
skipping: [localhost] => {
    "changed": false,
    "false_condition": "not vdi_monitor_service_stat.stat.exists",
    "skip_reason": "Conditional result was False"
}

TASK [lock_manager : Fail if lock file is invalid] *****************************
skipping: [localhost] => {
    "changed": false,
    "false_condition": "lock_file_validation.rc != 0",
    "skip_reason": "Conditional result was False"
}

PLAY RECAP *********************************************************************
localhost                  : ok=551  changed=75   unreachable=0    failed=0    skipped=68   rescued=0    ignored=6

Thu Jul 24 15:32:53 +0000 2025 Info [1870]: === install.yaml-f44d finished with exit_code=0 ===
Thu Jul 24 15:32:53 +0000 2025 Info [1535]: === passed_startup_script.sh-22f5 finished with exit_code=0 ===
[root@vdi-test-scott-rocky-0 ~]# 