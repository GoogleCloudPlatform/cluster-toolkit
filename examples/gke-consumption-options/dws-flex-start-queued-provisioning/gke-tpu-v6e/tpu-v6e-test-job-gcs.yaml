# Copyright 2026 "Google LLC"
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: jobset.x-k8s.io/v1alpha2
kind: JobSet
metadata:
  name: tpu-v6e-qp-fio
  labels:
    kueue.x-k8s.io/queue-name: dws-local-queue
  annotations:
    # Required for DWS Flex / Queued Provisioning.
    provreq.kueue.x-k8s.io/maxRunDurationSeconds: "3600"
spec:
  replicatedJobs:
  - name: tpu-slice
    replicas: 1
    template:
      spec:
        parallelism: 4 # Total nodes (16 chips / 4 per node)
        completions: 4
        backoffLimit: 0
        template:
          metadata:
            annotations:
              gke-gcsfuse/volumes: "true"
          spec:
            securityContext:
              runAsUser: 0
              runAsGroup: 100
              fsGroup: 100
            serviceAccountName: workload-identity-k8s-sa
            containers:
            - name: tpu-job
              image: ubuntu:22.04
              command:
              - "/bin/bash"
              - "-c"
              - |
                set -eux
                export DEBIAN_FRONTEND=noninteractive
                # Install fio
                apt update -y && apt install -y fio
                # Use a tag to create a unique path for tests
                TAG=`date +%s`
                # Verify mountpoints
                df -h
                mountpoint /checkpoint-data
                mountpoint /training-data
                # Create temporary directory for fio benchmarks
                mkdir -p /{training,checkpoint}-data/fio-benchmarks-${TAG}
                # Test reading from the training bucket
                fio --ioengine=libaio --filesize=1G --ramp_time=2s --runtime=30s \
                  --numjobs=8 --create_serialize=0 --direct=1 --verify=0 \
                  --randrepeat=0 --group_reporting --directory=/training-data/fio-benchmarks-${TAG} \
                  --name=training-read --blocksize=1m --iodepth=16 --readwrite=randread
                # Test writing to the checkpointing bucket
                fio --ioengine=libaio --filesize=1G --ramp_time=2s --runtime=30s \
                  --numjobs=8 --create_serialize=0 --direct=1 --verify=0 \
                  --randrepeat=0 --group_reporting --directory=/checkpoint-data/fio-benchmarks-${TAG} \
                  --name=checkpoint-write --blocksize=10m --iodepth=16 --readwrite=write
                # Perform checkpoint data reading performance test
                fio --ioengine=libaio --filesize=1G --ramp_time=2s --runtime=30s \
                  --numjobs=8 --create_serialize=0 --direct=1 --verify=0 \
                  --randrepeat=0 --group_reporting --directory=/checkpoint-data/fio-benchmarks-${TAG} \
                  --name=checkpoint-read --blocksize=10m --iodepth=16 --readwrite=read
                rm -rf /{training,checkpoint}-data/fio-benchmarks-${TAG}
                echo "FIO benchmark complete!"
              resources:
                requests:
                  google.com/tpu: 4
                limits:
                  google.com/tpu: 4
              volumeMounts:
              - name: training-data
                mountPath: /training-data
              - name: checkpoint-data
                mountPath: /checkpoint-data
            nodeSelector:
              cloud.google.com/gke-tpu-topology: "4x4"
              cloud.google.com/gke-queued: "true"
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                  - matchExpressions:
                    - key: cloud.google.com/gke-nodepool
                      operator: In
                      values:
                      - gke-tpu-v6e-pool
            tolerations:
            - key: "google.com/tpu"
              operator: "Equal"
              value: "present"
              effect: "NoSchedule"
            - key: "cloud.google.com/gke-queued"
              operator: "Equal"
              value: "true"
              effect: "NoSchedule"
            volumes:
            - name: training-data
              persistentVolumeClaim:
                # Replace with the PVC name generated by the toolkit (e.g. training-data-...)
                claimName: REPLACE_WITH_YOUR_TRAINING_PVC
            - name: checkpoint-data
              persistentVolumeClaim:
                # Replace with the PVC name generated by the toolkit (e.g. checkpoint-data-...)
                claimName: REPLACE_WITH_YOUR_CHECKPOINT_PVC
            restartPolicy: Never
