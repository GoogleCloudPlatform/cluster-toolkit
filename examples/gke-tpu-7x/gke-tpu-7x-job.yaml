# Copyright 2026 "Google LLC"
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#This Kubernetes Pod is designed to test a TPU 7x node in GKE.
#It schedules a container on a node with a 2x2x1 7x TPU topology, installs the latest JAX and TPU libraries from specific Google-hosted indexes, and then runs a Python command to check how many TPU chips JAX can detect.
#The container runs with privileged access to interact with the TPU hardware.

apiVersion: v1
kind: Pod
metadata:
  name: tpu-job-jax-tpu7x
spec:
  restartPolicy: Never
  nodeSelector:
    cloud.google.com/gke-tpu-accelerator: tpu7x
    cloud.google.com/gke-tpu-topology: <YOUR_TPU_TOPOLLOGY> # E.g. 2x2x1
  containers:
  - name: tpu-job
    image: python:3.12
    ports:
    - containerPort: 8431
    securityContext:
      privileged: true
    command:
    - bash
    - -c
    - |
      set -ex
      pip install -U --pre jax jaxlib libtpu requests -i https://us-python.pkg.dev/ml-oss-artifacts-published/jax/simple/ -f https://storage.googleapis.com/jax-releases/libtpu_releases.html
      python -c 'import jax; print("Global device count:", jax.device_count())'
    resources:
      requests:
        google.com/tpu: <CHIPS_PER_NODE> # e.g., 4 for tpu7x-standard-4t
      limits:
        google.com/tpu: <CHIPS_PER_NODE> # e.g., 4 for tpu7x-standard-4t
