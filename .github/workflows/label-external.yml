# Copyright 2026 "Google LLC"
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Label External PRs

on:
  pull_request_target:
    branches:
    - develop
    types:
    - opened
    - reopened
    - synchronize

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  check-user-and-label:
    runs-on: ubuntu-latest

    steps:
    - name: Check user and add label if external
      uses: actions/github-script@v7
      with:
        script: |
            const author = context.payload.pull_request.user.login;

            const file = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: "cluster-toolkit-writers.json"
            });

            const content = Buffer.from(file.data.content, "base64").toString();
            const writers = JSON.parse(content);
            const internalUsers = writers.map(w => w.login);

            if (!internalUsers.includes(author)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ["external"]
              });
            }
