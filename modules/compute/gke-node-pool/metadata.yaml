# Copyright 2026 "Google LLC"
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

spec:
  requirements:
    services:
    - container.googleapis.com
ghpc:
  inject_module_id: internal_ghpc_module_id
  validators:
  - validator: regex
    inputs:
      vars: [name]
      pattern: "^[a-z]([-a-z0-9]{0,34}[a-z0-9])?$"
    error_message: "'name' must start with a lowercase letter, followed by up to 34 lowercase letters, numbers, or hyphens, and cannot end with a hyphen."
  - validator: range
    inputs:
      vars: [local.upgrade_settings.max_surge]
      min: 0
    error_message: "'max_surge' value must be at least 0."
  - validator: range
    inputs:
      vars: [local.upgrade_settings.max_unavailable]
      min: 0
    error_message: "'max_unavailable' value must be at least 0."
  - validator: conditional
    inputs:
      trigger: enable_flex_start
      trigger_value: true
      dependent: reservation_affinity.consume_reservation_type
      dependent_value: "NO_RESERVATION"
    error_message: "enable_flex_start only works with reservation_affinity consume_reservation_type NO_RESERVATION."
  - validator: conditional
    inputs:
      trigger: enable_flex_start
      trigger_value: true
      dependent: static_node_count
      dependent_value: null
    error_message: "enable_flex_start does not work with static_node_count. static_node_count should be set to null."
  - validator: conditional
    inputs:
      trigger: enable_flex_start
      trigger_value: true
      dependent: auto_repair
      dependent_value: false
    error_message: "enable_flex_start needs node auto_repair set to false."
  - validator: conditional
    inputs:
      trigger: enable_queued_provisioning
      trigger_value: true
      dependent: autoscaling_total_min_nodes
      dependent_value: 0
    error_message: "autoscaling_total_min_nodes should be 0 when enable_queued_provisioning is true."
  - validator: conditional
    inputs:
      trigger: enable_queued_provisioning
      trigger_value: true
      dependent: reservation_affinity.consume_reservation_type
      dependent_value: "NO_RESERVATION"
    error_message: "reservation_affinity should be NO_RESERVATION when enable_queued_provisioning is true."
