# Cluster Toolkit Dockerfile

This repository contains a Dockerfile for building a Docker image with Cluster Toolkit and its dependencies installed and the `gcluster` binary readily available for use.

## System Requirements

To build and use this Dockerfile, you'll need:

1. Docker: [Docker Engine](https://docs.docker.com/engine/) needs to be installed to build a Docker image from this Dockerfile.

2. Google Cloud Platform: Configure a Google Cloud Project with the necessary APIs, permissions, and credentials needed by the `gcluster` binary. See the [setup guide](https://cloud.google.com/cluster-toolkit/docs/setup/configure-environment) for instructions.

## Build Arguments
The following build arguments can be used to customize the build process:
* **`BASE_IMAGE`**: The base image to use for the build. Defaults to `gcr.io/google.com/cloudsdktool/google-cloud-cli:stable`.
* **`TERRAFORM_VERSION`**: The version of Terraform to install. Defaults to `1.5.2`.
* **`PACKER_VERSION`**: The version of Packer to install. Defaults to `1.8.6`.
* **`GO_VERSION`**: The version of Go to install. Defaults to `1.23.0`.
* **`CLUSTER_TOOLKIT_REF`**: The [Cluster Toolkit repository's](https://github.com/GoogleCloudPlatform/cluster-toolkit/releases) branch or tag from which to build Cluster Toolkit.  Defaults to the `main` branch, which is the latest official release.

## Build the Cluster Toolkit Docker Image
To build the Cluster Toolkit Docker image, navigate to the directory the Dockerfile is present in and run the following command:

```bash
docker build --build-arg BASE_IMAGE=<base_image> \
             --build-arg TERRAFORM_VERSION=<terraform_version> \
             --build-arg PACKER_VERSION=<packer_version> \
             --build-arg GO_VERSION=<go_version> \
             --build-arg CLUSTER_TOOLKIT_REF=<cluster_toolkit_ref> \
             -t <image_name> .
```

Example:

```bash
docker build --build-arg CLUSTER_TOOLKIT_REF=v1.40.0 -t gcluster -t ghpc .
```

The above example builds an image tagged `gcluster` and sets the `CLUSTER_TOOLKIT_REF` to the Git tag `v1.40.0` while using the default values for other arguments.

## Run the Cluster Toolkit Docker Image
To run the Cluster Toolkit Docker image, use the following command:

```bash
docker run -v ~/.config/gcloud/:/root/.config/gcloud -v $(pwd):/out <image_name> <gcluster_command>
```

This command runs the Cluster Toolkit Docker image and allows the `gcluster` binary to access your Google Cloud credentials and local files. Here's a breakdown:

* `-v ~/.config/gcloud/:/root/.config/gcloud`: This argument mounts your local Google Cloud configuration directory (i.e. `~/.config/gcloud`) to the `/root/.config/gcloud` directory inside the container. This allows the `gcluster` binary to access your credentials and interact with Google Cloud resources when needed. If not already done, running `gcloud auth application-default login` should generate the Application Default Credentials in the `~/.config/gcloud/` directory on your local machine.
* `-v $(pwd):/out`: This argument mounts your current working directory `$(pwd)` to the `/out` directory inside the container. This is important because the Cluster Toolkit Dockerfile is designed to automatically output deployment folders to the `/out` directory. Due to this automatic output behavior, you should not provide the `--out` argument to the `create` and `deploy` gcluster subcommands when using this Dockerfile. Instead, mount a local directory (as shown in the example above with $(pwd)) to the   `/out` directory within the container. This ensures that the deployment folder persists even after the container exits, allowing you to access and manage the deployment artifacts even after the container is removed. Additionally, this allows the container to access any files in your current directory (like blueprint files) from within the container. You can then reference these files in your `<gcluster_command>` using the `/out` path.
* `<image_name>`: Replace this with the name of your Docker image.
* `<gcluster_command>`: Replace this with the `gcluster` command you want to execute. The Cluster Toolkit Docker image has `ENTRYPOINT ["gcluster"]` in its Dockerfile. This means that the `gcluster` command is automatically executed when the container starts, and any arguments provided after `<image_name>` in the `docker run` command are passed as arguments to `gcluster`.

Example:

```bash
docker run -v ~/.config/gcloud/:/root/.config/gcloud -v $(pwd):/out gcluster deploy /out/my-blueprint.yaml --auto-approve
```

This example runs the `deploy` command with the blueprint file `my-blueprint.yaml` located in your current directory. The deployment folder generated by `gcluster deploy` will be saved to your current directory (which is mounted to `/out`). `--auto-approve` automatically approves any prompts from `gcluster`, streamlining the deployment process.
