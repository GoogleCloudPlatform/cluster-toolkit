-- VNC Connection for {{ username }}
WITH
  user_entity AS (
    SELECT entity_id
    FROM guacamole_entity
    WHERE name = '{{ username }}' AND type = 'USER'
  ),
  new_connection AS (
    INSERT INTO guacamole_connection (connection_name, protocol)
    VALUES ('{{ username }}', 'vnc')
    RETURNING connection_id
  ),
  insert_params AS (
    INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value)
    SELECT connection_id, param_name, param_value
    FROM new_connection, (VALUES
      ('hostname', '{{ ansible_default_ipv4.address }}'),
      ('port', '{{ port }}'),
      ('username', '{{ username }}'),
      ('password', '{{ vnc_password }}')
    ) AS params(param_name, param_value)
  ),
  insert_permissions AS (
    INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission)
    SELECT
      user_entity.entity_id,
      new_connection.connection_id,
      perms.permission::guacamole_object_permission_type
    FROM user_entity, new_connection,
         (VALUES ('READ'),('UPDATE'),('DELETE'),('ADMINISTER')) AS perms(permission)
  )
SELECT 1;

-- SSH Connection for {{ username }}
WITH
  user_entity AS (
    SELECT entity_id
    FROM guacamole_entity
    WHERE name = '{{ username }}' AND type = 'USER'
  ),
  new_connection_ssh AS (
    INSERT INTO guacamole_connection (connection_name, protocol)
    VALUES ('{{ username }} SSH', 'ssh')
    RETURNING connection_id
  ),
  insert_params_ssh AS (
    INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value)
    SELECT connection_id, param_name, param_value
    FROM new_connection_ssh, (VALUES
      ('hostname', '{{ ansible_default_ipv4.address }}'),
      ('port', '22'),
      ('username', '{{ username }}'),
      (
        'private-key',
        E'{{ lookup("file", "/home/" ~ username ~ "/.ssh/id_rsa")
              | replace("\\", "\\\\")
              | replace("'",  "''")
              | replace("\r", "")
              | replace("\n", "\\n") }}'
      )
    ) AS params(param_name, param_value)
  ),
  insert_permissions_ssh AS (
    INSERT INTO guacamole_connection_permission (entity_id, connection_id, permission)
    SELECT
      user_entity.entity_id,
      new_connection_ssh.connection_id,
      perms.permission::guacamole_object_permission_type
    FROM user_entity, new_connection_ssh,
         (VALUES ('READ'),('UPDATE'),('DELETE'),('ADMINISTER')) AS perms(permission)
  )
SELECT 1;
