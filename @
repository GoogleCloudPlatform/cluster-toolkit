
# Default compute SA will require IAM role: Secret Manager Secret Accessor

blueprint_name: vdi-test-scott

vars:
  deployment_name: vdi-test-scott
  project_id: hpc-discovery-external
  region: us-central1
  zone: us-central1-a

deployment_groups:
- group: primary
  modules:
  - id: network1
    source: modules/network/vpc
    settings:
      extra_iap_ports: [8080]
      firewall_rules:
      - name: allow-guacamole-8080-ext
        description: Allow external ingress to Guacamole on TCP port 8080
        direction: INGRESS
        ranges: ["0.0.0.0/0"] # or rev proxy address?
        allow:
          - protocol: tcp
            ports: ["8080"]

  - id: enable-apis
    source: community/modules/project/service-enablement
    settings:
      gcp_service_list:
      - secretmanager.googleapis.com
      - storage.googleapis.com
      - compute.googleapis.com

  - id: vdi-setup
    source: community/modules/scripts/vdi-setup
    settings:
      vnc_flavor: tigervnc
      vdi_tool: guacamole
      user_provision: local_users
      vdi_user_group: vdiusers
      vdi_resolution: 1920x1080
      vdi_users:
      - username: alice
        port: 5901
      - username: bob
        port: 5902
        secret_name: a-password-for-bob

  - id: machine
    source: modules/compute/vm-instance
    settings:
      instance_image:
        #family: debian-11
        #project: debian-cloud
        #family: ubuntu-2204-lts
        #project: ubuntu-os-cloud
        family: hpc-rocky-linux-8
        project: cloud-hpc-image-public
      machine_type: g2-standard-8
      disable_public_ips: false
      tags: ["guacamole"]
    use:
     - network1
     - vdi-setup
